<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>面试狗 - interviewdog 项目笔记 | 雪荷的博客</title><meta name="author" content="雪荷"><meta name="copyright" content="雪荷"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="面试狗 - interviewdog 项目笔记前端初始化配置Next.js 有两种开发模式（App Router / Page Router），注意，本项目用的是新的开发模式 App Router，建议看英文官方文档：https://nextjs.org/docs/getting-started/installation#automatic-installation 执行安装命令： 1n">
<meta property="og:type" content="article">
<meta property="og:title" content="面试狗 - interviewdog 项目笔记">
<meta property="og:url" content="http://example.com/2024/09/06/%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="雪荷的博客">
<meta property="og:description" content="面试狗 - interviewdog 项目笔记前端初始化配置Next.js 有两种开发模式（App Router / Page Router），注意，本项目用的是新的开发模式 App Router，建议看英文官方文档：https://nextjs.org/docs/getting-started/installation#automatic-installation 执行安装命令： 1n">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/post_2.png">
<meta property="article:published_time" content="2024-09-06T15:49:00.000Z">
<meta property="article:modified_time" content="2024-09-19T14:36:57.435Z">
<meta property="article:author" content="雪荷">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="React">
<meta property="article:tag" content="Next.js">
<meta property="article:tag" content="面试狗">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/post_2.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/09/06/%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '面试狗 - interviewdog 项目笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-19 22:36:57'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/ava.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/post_2.png')"><nav id="nav"><span id="blog-info"><a href="/" title="雪荷的博客"><span class="site-name">雪荷的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">面试狗 - interviewdog 项目笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-06T15:49:00.000Z" title="发表于 2024-09-06 23:49:00">2024-09-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-19T14:36:57.435Z" title="更新于 2024-09-19 22:36:57">2024-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/%E9%9D%A2%E8%AF%95%E7%8B%97/">面试狗</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="面试狗 - interviewdog 项目笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('/img/post_2.png');"></div><article class="post-content" id="article-container"><h1 id="面试狗-interviewdog-项目笔记"><a href="#面试狗-interviewdog-项目笔记" class="headerlink" title="面试狗 - interviewdog 项目笔记"></a>面试狗 - interviewdog 项目笔记</h1><h2 id="前端初始化配置"><a href="#前端初始化配置" class="headerlink" title="前端初始化配置"></a>前端初始化配置</h2><p>Next.js 有两种开发模式（App Router / Page Router），注意，本项目用的是新的开发模式 App Router，建议看英文官方文档：<a target="_blank" rel="noopener" href="https://nextjs.org/docs/getting-started/installation#automatic-installation">https://nextjs.org/docs/getting-started/installation#automatic-installation</a></p>
<p>执行安装命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-next-app@latest</span><br></pre></td></tr></tbody></table></figure>

<p>历史 next-app 版本：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/next?activeTab=versions">https://www.npmjs.com/package/next?activeTab=versions</a></p>
<p>安装 prettier （代码自动格式化插件），安装命令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev --save-exact prettier</span><br></pre></td></tr></tbody></table></figure>

<p>修改 .eslintrc.json 文件可以改变校验规则，一般自己做项目不需要修改。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "extends": ["next/core-web-vitals", "prettier"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240903211858.png" alt="image-20240903211858419"></p>
<p>如果报错 Error: Failed to load config “prettier” to extend from. Referenced from: D:\projects\interviewdog-frontend.eslintrc.json 则执行以下命令：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i eslint prettier-eslint eslint-config-prettier --save-dev</span><br></pre></td></tr></tbody></table></figure>

<p>安装 antd 组件库</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install antd --save</span><br></pre></td></tr></tbody></table></figure>

<p>针对 App Router 模式的 Next.js，需要处理页面闪动情况</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @ant-design/nextjs-registry --save</span><br></pre></td></tr></tbody></table></figure>

<p>修改页面全局布局文件 app/layout.tsx</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"./globals.css"</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">AntdRegistry</span>} <span class="keyword">from</span> <span class="string">'@ant-design/nextjs-registry'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">RootLayout</span>(<span class="params">{</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">}: Readonly&lt;{</span></span><br><span class="line"><span class="params">  children: React.ReactNode;</span></span><br><span class="line"><span class="params">}&gt;</span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">AntdRegistry</span>&gt;</span>{children}<span class="tag">&lt;/<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果能在 page.tsx 文件中引入组件，则代表组件库安装成功</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button type="primary"&gt;Primary Button&lt;/Button&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>安装 Ant Design 高级组件：<a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/layout?tab=api#packages-layout-src-components-layout-tab-api-demo-base">https://procomponents.ant.design/components/layout?tab=api#packages-layout-src-components-layout-tab-api-demo-base</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @ant-design/pro-components --save</span><br></pre></td></tr></tbody></table></figure>

<p>注意，引入 Ant Design 后，不建议引入 Tailwind CSS 了，可能会有样式冲突</p>
<h2 id="Next-js-开发规范"><a href="#Next-js-开发规范" class="headerlink" title="Next.js 开发规范"></a>Next.js 开发规范</h2><h3 id="1、约定式路由"><a href="#1、约定式路由" class="headerlink" title="1、约定式路由"></a>1、约定式路由</h3><p>Next.js 使用 约定式路由，根据文件夹的结构和名称，自动将对应的 URL 地址映射到页面文件。</p>
<p>常见的几种路由规则如下: 1）基础规则:以 app 目录作为根路径，根据文件夹的名称和嵌套层级，自动映射为 URL 地址。注意，只有目录下直接包含 page 文件(js、jsx、ts、tsx都支持)，才会被识别为路由。</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240903213423.png" alt="image-20240903213423138"></p>
<p>2）路由组:可以通过(xxx)语法，创建一个路由组，不会被转化为路径，可用于对路由进行分组管理，比如同组路由使用同一套布局。</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240903213548.png" alt="image-20240903213548477"></p>
<p>3）动态路由:可以通过[xxx]语法，让多个不同参数的 URL 复用同一个页面，比如app/question/[questionId]/page.tsx 中 questionld 就是动态路由参数，可以匹配 /question/1、/question/2 等URL地址，在页面中可以获取到 questionld 并加载不同的题目。</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Page</span>(<span class="params">{ params }: { params: { questionId: <span class="built_in">string</span> } }</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>我的题目: {params.questionId}<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以上只是 Next.js 的几种常用路由规则，还有其他的规则，详情可以见 Next.js 的官方文档:<a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/building-your-application/routing">https://nextjs.org/docs/app/building-your-application/routing</a></p>
<h3 id="2、静态资源"><a href="#2、静态资源" class="headerlink" title="2、静态资源"></a>2、静态资源</h3><p>Next.js 约定 在 <code>/public</code> 目录下存放静态资源。在其中新建 <code>assets</code> 目录，可以在其中存放图片等静态资源文件，比如网站 logo</p>
<p>对应官方文档：<a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/building-your-application/optimizing/static-assets">https://nextjs.org/docs/app/building-your-application/optimizing/static-assets</a></p>
<p>接着可以使用 Next.js 的 Image 组件加载静态资源，比如：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Image src={`/assets/logo.png`} alt={alt} width="64" height="64" /&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>注意，某些特殊的、常用的元信息文件不是放在 public 目录下，而是应该根据特定规则放在 app 目录下!对应官方文档：<a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/api-reference/file-conventions/metadata%E6%AF%94%E5%A6%82%E5%B0%86">https://nextjs.org/docs/app/api-reference/file-conventions/metadata比如将</a> favicon.ico 放到 app 的根目录下，可展示站点小图标:</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240903214445.png" alt="image-20240903214445070"></p>
<h3 id="3、文件组织形式"><a href="#3、文件组织形式" class="headerlink" title="3、文件组织形式"></a>3、文件组织形式</h3><p>首先，项目中的每个页面和组件都是单独的文件夹。</p>
<p>基于 Nextjs 的约定式路由，我们每个页面目录内需要添加 page.tsx页面文件和 index.css 样式文件;每个组件目录内添加 index.tsx页面文件和index.css 样式文件。</p>
<p>对于项目中多页面公用的组件，放在src/components目录下;对于某个页面私有的组件，放在该页面的components 目录下</p>
<h3 id="4、页面开发规范"><a href="#4、页面开发规范" class="headerlink" title="4、页面开发规范"></a>4、页面开发规范</h3><p>Next.js 支持 React 的语法，可以用函数的方式声明页面和组件。每个页面的根元素必须有 id、每个组件根元素必须有 className，用于控制样式和快速定位。</p>
<p>1）**为了区分服务端和客户端渲染，每个页面(或组件)都必须在开头显示编写<code>use client</code>或<code>use server</code>**比如定义一个客户端渲染的页面，代码如下：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"use client"</span>;</span><br><span class="line"><span class="comment">// 引入样式</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主页</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">HomePage</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">main</span> <span class="attr">id</span>=<span class="string">"homePage"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        程序员鱼皮x编程导航的项目教程</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）定义组件时，需要使用 ts 声明组件属性的类型，比如：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"use client"</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">Viewer</span> } <span class="keyword">from</span> <span class="string">"@bytemd/react"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> {</span><br><span class="line">  value?: <span class="built_in">string</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MdViewer</span> = (<span class="params">props: Props</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { value = <span class="string">""</span> } = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"md-viewer"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Viewer</span> <span class="attr">value</span>=<span class="string">{value}</span> <span class="attr">plugins</span>=<span class="string">{plugins}</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MdViewer</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5、其他注意事项"><a href="#5、其他注意事项" class="headerlink" title="5、其他注意事项"></a>5、其他注意事项</h3><p>1）开发时要严格注意 TypeScript 的类型和编辑器的错误提示，并且定期打包构建。因为 Next.js 的构建要求非常严格，稍有不慎就会报错。构建报错的话，注意查看和处理构建中的报错信息。</p>
<p>2）在项目中慎用 window 等浏览器环境才支持的对象，服务端无法使用。注意保证客户端渲染页面和服务端渲染页面的一致性，否则会出现水合错误。</p>
<h2 id="前端万能模板开发"><a href="#前端万能模板开发" class="headerlink" title="前端万能模板开发"></a>前端万能模板开发</h2><blockquote>
<p>Next.js 的页面名称要为 page.tsx，React 则为 index.tsx</p>
</blockquote>
<h3 id="全局通用布局"><a href="#全局通用布局" class="headerlink" title="全局通用布局"></a>全局通用布局</h3><p>先创建 layouts 布局目录，创建一个基础布局，并将基础布局组件包裹 layout.tsx 文件的 children 属性</p>
<p> layout.tsx：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"./globals.css"</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">AntdRegistry</span>} <span class="keyword">from</span> <span class="string">'@ant-design/nextjs-registry'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BasicLayout</span> <span class="keyword">from</span> <span class="string">"@/layouts/BasicLayout"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">RootLayout</span>(<span class="params">{</span></span><br><span class="line"><span class="params">                                     children,</span></span><br><span class="line"><span class="params">                                   }: Readonly&lt;{</span></span><br><span class="line"><span class="params">  children: React.ReactNode;</span></span><br><span class="line"><span class="params">}&gt;</span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">BasicLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              {children}</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">BasicLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>src/layouts/BasicLayout/index.tsx：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"use client"</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">GithubFilled</span>, <span class="title class_">LogoutOutlined</span>, <span class="title class_">PlusCircleFilled</span>, <span class="title class_">SearchOutlined</span>,} <span class="keyword">from</span> <span class="string">'@ant-design/icons'</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">ProLayout</span>,} <span class="keyword">from</span> <span class="string">'@ant-design/pro-components'</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">Dropdown</span>, <span class="title class_">Input</span>,} <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Image</span> <span class="keyword">from</span> <span class="string">"next/image"</span>;</span><br><span class="line"><span class="keyword">import</span> {usePathname} <span class="keyword">from</span> <span class="string">"next/navigation"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Link</span> <span class="keyword">from</span> <span class="string">"next/link"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">GlobalFooter</span> <span class="keyword">from</span> <span class="string">"@/components/GlobalFooter"</span>;</span><br><span class="line"><span class="keyword">import</span> {menus} <span class="keyword">from</span> <span class="string">"../../../config/menu"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索条</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">SearchInput</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">key</span>=<span class="string">"SearchOutlined"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">aria-hidden</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">{{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">display:</span> '<span class="attr">flex</span>',</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">alignItems:</span> '<span class="attr">center</span>',</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">marginInlineEnd:</span> <span class="attr">24</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            }}</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onMouseDown</span>=<span class="string">{(e)</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-xml">                e.stopPropagation();</span></span><br><span class="line"><span class="language-xml">                e.preventDefault();</span></span><br><span class="line"><span class="language-xml">            }}</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">{{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">borderRadius:</span> <span class="attr">4</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">marginInlineEnd:</span> <span class="attr">12</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                }}</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">prefix</span>=<span class="string">{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    &lt;<span class="attr">SearchOutlined</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                }</span></span><br><span class="line"><span class="language-xml">                placeholder="搜索题目"</span></span><br><span class="line"><span class="language-xml">                variant="borderless"</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> {</span><br><span class="line">    <span class="attr">children</span>: <span class="title class_">React</span>.<span class="property">ReactNode</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">BasicLayout</span>(<span class="params">{children}: Props</span>) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> pathname = <span class="title function_">usePathname</span>();</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">id</span>=<span class="string">"basicLayout"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">{{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">height:</span> '<span class="attr">100vh</span>',</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">overflow:</span> '<span class="attr">auto</span>',</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            }}</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">ProLayout</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">title</span>=<span class="string">"面试狗"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">logo</span>=<span class="string">{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    &lt;<span class="attr">Image</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">src</span>=<span class="string">"/assets/logo.png"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">height</span>=<span class="string">{32}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">width</span>=<span class="string">{32}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">alt</span>=<span class="string">"面试狗"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    /&gt;</span></span></span><br><span class="line"><span class="language-xml">                }</span></span><br><span class="line"><span class="language-xml">                layout="top"</span></span><br><span class="line"><span class="language-xml">                location={{</span></span><br><span class="line"><span class="language-xml">                    pathname,</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                avatarProps={{</span></span><br><span class="line"><span class="language-xml">                    src: 'https://gw.alipayobjects.com/zos/antfincdn/efFD%24IOql2/weixintupian_20170331104822.jpg',</span></span><br><span class="line"><span class="language-xml">                    size: 'small',</span></span><br><span class="line"><span class="language-xml">                    title: 'C1own',</span></span><br><span class="line"><span class="language-xml">                    render: (props, dom) =&gt; {</span></span><br><span class="line"><span class="language-xml">                        return (</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Dropdown</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                <span class="attr">menu</span>=<span class="string">{{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">items:</span> [</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                        {</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">key:</span> '<span class="attr">logout</span>',</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">icon:</span> &lt;<span class="attr">LogoutOutlined</span>/&gt;</span>,</span></span><br><span class="line"><span class="language-xml">                                            label: '退出登录',</span></span><br><span class="line"><span class="language-xml">                                        },</span></span><br><span class="line"><span class="language-xml">                                    ],</span></span><br><span class="line"><span class="language-xml">                                }}</span></span><br><span class="line"><span class="language-xml">                            &gt;</span></span><br><span class="line"><span class="language-xml">                                {dom}</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Dropdown</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        );</span></span><br><span class="line"><span class="language-xml">                    },</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                actionsRender={(props) =&gt; {</span></span><br><span class="line"><span class="language-xml">                    if (props.isMobile) return [];</span></span><br><span class="line"><span class="language-xml">                    return [</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">SearchInput</span> <span class="attr">key</span>=<span class="string">"searchInput"</span>/&gt;</span>,</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://www.github.com/dnwwdwd"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">key</span>=<span class="string">"github"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">GithubFilled</span> <span class="attr">key</span>=<span class="string">"GithubFilled"</span>/&gt;</span>,</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    ];</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                headerTitleRender={(logo, title, _) =&gt; {</span></span><br><span class="line"><span class="language-xml">                    const defaultDom = (</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            {logo}</span></span><br><span class="line"><span class="language-xml">                            {title}</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    );</span></span><br><span class="line"><span class="language-xml">                    if (typeof window === 'undefined') return defaultDom;</span></span><br><span class="line"><span class="language-xml">                    if (document.body.clientWidth &lt; 1400) {</span></span><br><span class="line"><span class="language-xml">                        return defaultDom;</span></span><br><span class="line"><span class="language-xml">                    }</span></span><br><span class="line"><span class="language-xml">                    if (_.isMobile) return defaultDom;</span></span><br><span class="line"><span class="language-xml">                    return (</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">                            {defaultDom}</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="language-xml">                    );</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                // 渲染底部栏</span></span><br><span class="line"><span class="language-xml">                footerRender={(props) =&gt; {</span></span><br><span class="line"><span class="language-xml">                    return <span class="tag">&lt;<span class="name">GlobalFooter</span>/&gt;</span>;</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                onMenuHeaderClick={(e) =&gt; console.log(e)}</span></span><br><span class="line"><span class="language-xml">                menuDataRender={() =&gt; {</span></span><br><span class="line"><span class="language-xml">                    return menus;</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                menuItemRender={(item, dom) =&gt; (</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Link</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">href</span>=<span class="string">{item.path</span> || '/'}</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">target</span>=<span class="string">{item.target}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        {dom}</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                )}</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                {children}</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">ProLayout</span>&gt;</span></span></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>其中 {children} 替换了原来的 PageContainer 组件，这样不同的页面就可以复用公共的布局，同时不同的页面能显示不同的内容</p>
<p>1.在 prolayout 组件中配置 logo 和 title 属性可以修改导航栏 logo 和标题，将当前页面的 pathname 传给 location 属性时，这个 procomponents 组件库会自动渲染菜单项</p>
<ul>
<li>另外在菜单项 item 可以通过添加 hideInMenu: true 来控制菜单项是否显示</li>
</ul>
<p>2.在服务端渲染中获取 pathname 可通过 next.js 的 usePathname 实现</p>
<p>3.通过 menuDataRender 定义有哪些菜单项</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">menuDataRender={<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">path</span>: <span class="string">'questions'</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">'题目'</span></span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">path</span>: <span class="string">'banks'</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">'题库'</span></span><br><span class="line">        },</span><br><span class="line">    ]</span><br><span class="line">}}</span><br></pre></td></tr></tbody></table></figure>

<p>4.根据 menuItemRender 指定点击菜单项的动作</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">menuItemRender={<span class="function">(<span class="params">item, dom</span>) =&gt;</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Link</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">href</span>=<span class="string">{item.path</span> || '/'}</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">target</span>=<span class="string">{item.target}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        {dom}</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line">)}</span><br></pre></td></tr></tbody></table></figure>

<p>5.通过 footerRender 可以渲染底部栏，我们可以自己定义一个底部栏并引入它</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">                footerRender ={<span class="function">(<span class="params">props</span>) =&gt;</span> {</span><br><span class="line">                    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">GlobalFooter</span> /&gt;</span></span>;</span><br><span class="line">                }}</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.css'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局底部栏组件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">GlobalFooter</span>(<span class="params"></span>) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentYear = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">className</span>=<span class="string">"global-footer"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span>@ {currentYear} AI 刷题平台<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://www.github.com/dnwwdwd"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                作者：C1own</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>6.注意使用客户端渲染时，请删除关于 windows、useState document 相关的代码！！！</p>
<h3 id="安装请求库"><a href="#安装请求库" class="headerlink" title="安装请求库"></a>安装请求库</h3><p>1、安装 axios 库</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install axios</span><br></pre></td></tr></tbody></table></figure>

<p>2、全局定义请求</p>
<blockquote>
<p>在这个文件中可以配置全局响应拦截器和超时时间，是否携带 cookie 等</p>
</blockquote>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 Axios 示例</span></span><br><span class="line"><span class="keyword">const</span> myAxios = axios.<span class="title function_">create</span>({</span><br><span class="line">  <span class="attr">baseURL</span>: <span class="string">"http://localhost:8101"</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">10000</span>,</span><br><span class="line">  <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建请求拦截器</span></span><br><span class="line">myAxios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">config</span>) {</span><br><span class="line">    <span class="comment">// 请求执行前执行</span></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">error</span>) {</span><br><span class="line">    <span class="comment">// 处理请求错误</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  },</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建响应拦截器</span></span><br><span class="line">myAxios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="comment">// 2xx 响应触发</span></span><br><span class="line">  <span class="keyword">function</span> (<span class="params">response</span>) {</span><br><span class="line">    <span class="comment">// 处理响应数据</span></span><br><span class="line">    <span class="keyword">const</span> { data } = response;</span><br><span class="line">    <span class="comment">// 未登录</span></span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">40100</span>) {</span><br><span class="line">      <span class="comment">// 不是获取用户信息接口，或者不是登录页面，则跳转到登录页面</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !response.<span class="property">request</span>.<span class="property">responseURL</span>.<span class="title function_">includes</span>(<span class="string">"user/get/login"</span>) &amp;&amp;</span><br><span class="line">        !<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>.<span class="title function_">includes</span>(<span class="string">"/user/login"</span>)</span><br><span class="line">      ) {</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">`/user/login?redirect=<span class="subst">${<span class="variable language_">window</span>.location.href}</span>`</span>;</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="property">code</span> !== <span class="number">0</span>) {</span><br><span class="line">      <span class="comment">// 其他错误</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(data.<span class="property">message</span> ?? <span class="string">"服务器错误"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// 非 2xx 响应触发</span></span><br><span class="line">  <span class="keyword">function</span> (<span class="params">error</span>) {</span><br><span class="line">    <span class="comment">// 处理响应错误</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  },</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> myAxios;</span><br></pre></td></tr></tbody></table></figure>

<p>3、自动生成请求代码</p>
<p>安装自动生成请求接口代码库：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev @umijs/openapi</span><br></pre></td></tr></tbody></table></figure>

<p>在 <code>项目根目录</code> 新建openapi.config.ts ，根据自己的需要定制生成的代码：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> { generateService } = <span class="built_in">require</span>(<span class="string">"@umijs/openapi"</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">generateService</span>({</span><br><span class="line">  <span class="attr">requestLibPath</span>: <span class="string">"import request from '@/libs/request'"</span>,</span><br><span class="line">  <span class="attr">schemaPath</span>: <span class="string">"http://localhost:8101/api/v2/api-docs"</span>,</span><br><span class="line">  <span class="attr">serversPath</span>: <span class="string">"./src"</span>,</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>4、执行生成代码的命令</p>
<blockquote>
<p>在 package.json 文件中添加如下脚本</p>
</blockquote>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"openapi"</span><span class="punctuation">:</span> <span class="string">"ts-node openapi.config.ts"</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>如果执行如上命令出现 <code>ts-node</code> 不是内部或外部命令则 执行这个命令 <code>npm install --save-dev ts-node</code></p>
</blockquote>
<h2 id="全局状态管理"><a href="#全局状态管理" class="headerlink" title="全局状态管理"></a>全局状态管理</h2><p>1、什么是全局状态管理？</p>
<p>是指多个页面需要共享或者跟踪变化的变量，可以放到全局来统一维护，而不是每个页面分别维护和获取。适合作为全局状态的数据:记登录用户信息(每个页面几乎都要用)</p>
<p>在 Vue 中，主流的状态管理库有 Vuex 和 Pinia;在 React 项目中，主流的状态管理库是 Redux，本项目也将使用它。</p>
<p>2、Redux 基本概念</p>
<p>React Redux 官方文档:<a target="_blank" rel="noopener" href="https://react-redux.js.org/Redux">https://react-redux.js.org/Redux</a> 中有一些常用的核心概念，不用理解，简单了解一下即可。 1）Store：整个应用状态（state）的容器，负责存储应用的状态，并提供访问状态、派发(dispatch)动作以及注册监听器等功能。 2）Action：一个普通的 JavaScript 对象，描述了状态变化的意图。每个 action 必须包含一个 type 字段表示动作类型。 一般开发中，我们会用一个字符串常量(Action Types)来标识不同的动作类型。比如改变计数器需要的 increment或 decrement：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">INCREMENT</span> = <span class="string">'INCREMENT'</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DECREMENT</span> = <span class="string">'DECREMENT'</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>还会用 Action Creators 动作创建器函数来生成 action 对象，比如：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">increment</span> = (<span class="params"></span>) =&gt; ({</span><br><span class="line">  <span class="attr">type</span>: <span class="variable constant_">INCREMENT</span>,</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">decrement</span> = (<span class="params"></span>) =&gt; ({</span><br><span class="line">  <span class="attr">type</span>: <span class="variable constant_">DECREMENT</span>,</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>3）Dispatch：用于发送 action，触发状态更新</p>
<p>4）Reducer：俗称状态处理器，根据当前状态和传入的 action 返回新的状态的函数。比如：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const initialState = { count: 0 };</span><br><span class="line"></span><br><span class="line">function counterReducer(state = initialState, action) {</span><br><span class="line">  switch (action.type) {</span><br><span class="line">    case INCREMENT:</span><br><span class="line">      return { ...state, count: state.count + 1 };</span><br><span class="line">    case DECREMENT:</span><br><span class="line">      return { ...state, count: state.count - 1 };</span><br><span class="line">    default:</span><br><span class="line">      return state;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3、状态管理实战</p>
<p>React Redux 官方入门文档:<a target="_blank" rel="noopener" href="https://react-redux,js.org/tutorials/quick-start">https://react-redux,js.org/tutorials/quick-start</a></p>
<p>由于我们使用的是 TypeScript，还要参考 TypeScript 的快速启动文档:<a target="_blank" rel="noopener" href="https://react-redux.js.org/tutorials/typescriptquick-start">https://react-redux.js.org/tutorials/typescriptquick-start</a> 。对于新手，上面两个文档最好按顺序阅读。</p>
<p>其实以前 Redux 的使用成本还是稍微有点高的，但官方提供了 Redux Toolkit，可以简化使用 Redux 的开发。 1）安装</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @reduxjs/toolkit react-redux</span><br></pre></td></tr></tbody></table></figure>

<p>2）配置 store</p>
<p>Store 是整个应用状态(state)的容器，负责存储应用的状态，并提供访问状态、派发(dispatch)动作以及注册监听器等功能。 在项目的 src 目录下新建 stores目录，用于存放所有的状态。然后在 stores目录下新建 index.ts 文件，创建一个空的 Redux Store：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> {configureStore} <span class="keyword">from</span> <span class="string">"@reduxjs/toolkit"</span>;</span><br><span class="line"><span class="keyword">import</span> loginUser <span class="keyword">from</span> <span class="string">"@/stores/loginUser"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">configureStore</span>({</span><br><span class="line">    <span class="attr">reducer</span>: {</span><br><span class="line">        <span class="comment">// 在这里存放状态</span></span><br><span class="line">        loginUser,</span><br><span class="line">    },</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于类型推断和提示</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">RootState</span> = <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> store.<span class="property">getState</span>&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">AppDispatch</span> = <span class="keyword">typeof</span> store.<span class="property">dispatch</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></tbody></table></figure>

<p>3）在项目中引入 Redux Store，修改 <code>app/layout.tsx</code> 项目全局入口文件即可：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'@/stores'</span></span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">Provider</span> } <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">RootLayout</span>(<span class="params">{</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">}: Readonly&lt;{</span></span><br><span class="line"><span class="params">  children: React.ReactNode;</span></span><br><span class="line"><span class="params">}&gt;</span>) {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">{store}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">BasicLayout</span>&gt;</span>{children}<span class="tag">&lt;/<span class="name">BasicLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>4）定义 Slice</p>
<p>Slice 是 Redux Toolkit 中的概念，它将状态和相关的 reducer 逻辑组织在一起，便于模块化管理。每个 sice 通常代表应用中的一部分状态(如用户、产品、购物车等)。</p>
<p>在没有 Redux Toolkit 和 Slice 之前，传统的 Redux 开发需要定义 action types、action creators 和 reducer 函数，所有这些通常需要在不同的文件中编写，增加了代码的复杂性和维护成本。</p>
<p>在 stores 目录下新建 loginUser.ts ，创建一个 slice 用于存储当前登录用户的信息。代码如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import { createSlice, PayloadAction } from "@reduxjs/toolkit";</span><br><span class="line">import { RootState } from "@/stores/index";</span><br><span class="line"></span><br><span class="line">// 默认用户</span><br><span class="line">const DEFAULT_USER: API.LoginUserVO = {</span><br><span class="line">  userName: "未登录",</span><br><span class="line">  userProfile: "暂无简介",</span><br><span class="line">  userAvatar: "/assets/notLoginUser.png",</span><br><span class="line">  userRole: "guest",</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 登录用户全局状态</span><br><span class="line"> */</span><br><span class="line">export const loginUserSlice = createSlice({</span><br><span class="line">  name: "loginUser",</span><br><span class="line">  initialState: DEFAULT_USER,</span><br><span class="line">  reducers: {</span><br><span class="line">    setLoginUser: (state, action: PayloadAction&lt;API.LoginUserVO&gt;) =&gt; {</span><br><span class="line">      return {</span><br><span class="line">        ...action.payload,</span><br><span class="line">      };</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// 修改状态</span><br><span class="line">export const { setLoginUser } = loginUserSlice.actions;</span><br><span class="line"></span><br><span class="line">export default loginUserSlice.reducer;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意：全局状态信息只能在客户端组件获取</strong></p>
<p>5）在 Store 中引入新创建的 Slice，写在 reducer 里：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> loginUser <span class="keyword">from</span> <span class="string">"./loginUser"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">configureStore</span>({</span><br><span class="line">  <span class="attr">reducer</span>: {</span><br><span class="line">    loginUser,</span><br><span class="line">  },</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>6）获取状态 注意，状态是维护在客户端的，可以在任意 客户端渲染 页面(或组件)中使用状态，服务端渲染无法使用。 使用下列语法获取状态：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loginUser = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state: RootState</span>) =&gt;</span> state.<span class="property">loginUser</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>7）修改状态</p>
<p>修改状态也很方便，可以在 <code>首次进入页面</code>时，尝试获取登录用户信息。修改 app/layout.tsx 的全局初始化逻辑，编写远程获取登录用户数据的代码：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化布局（多封装一层，使得能调用 useDispatch）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">children</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">InitLayout</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;</span><br><span class="line">  <span class="title class_">Readonly</span>&lt;{</span><br><span class="line">    <span class="attr">children</span>: <span class="title class_">React</span>.<span class="property">ReactNode</span>;</span><br><span class="line">  }&gt;</span><br><span class="line">&gt; = <span class="function">(<span class="params">{ children }</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> dispatch = useDispatch&lt;<span class="title class_">AppDispatch</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化全局用户状态</span></span><br><span class="line">  <span class="keyword">const</span> doInitLoginUser = <span class="title function_">useCallback</span>(<span class="keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="comment">// 获取用户信息</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getLoginUserUsingGet</span>();</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">data</span>) {</span><br><span class="line">      <span class="title function_">dispatch</span>(<span class="title function_">setLoginUser</span>(res.<span class="property">data</span>));</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// todo 测试代码，实际可删除</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">const</span> testUser = { <span class="attr">userName</span>: <span class="string">"测试登录"</span>, <span class="attr">id</span>: <span class="number">1</span> };</span><br><span class="line">        <span class="title function_">dispatch</span>(<span class="title function_">setLoginUser</span>(testUser));</span><br><span class="line">      }, <span class="number">3000</span>);</span><br><span class="line">    }</span><br><span class="line">  }, []);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="title function_">doInitLoginUser</span>();</span><br><span class="line">  }, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;&gt;</span>{children}<span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>其中，通过 dispatch 触发全局状态的更新：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先获取 dispatch</span></span><br><span class="line"><span class="keyword">const</span> dispatch = useDispatch&lt;<span class="title class_">AppDispatch</span>&gt;();</span><br><span class="line"><span class="comment">// 触发更新</span></span><br><span class="line"><span class="title function_">dispatch</span>(<span class="title function_">setLoginUser</span>({...}));</span><br></pre></td></tr></tbody></table></figure>

<p><strong>扩展</strong></p>
<p>有些页面可以不用获取全局初始化状态，比如用户登录和用户注册页，可以根据 pathname 判断：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前页面路径</span></span><br><span class="line"><span class="keyword">const</span> pathname = <span class="title function_">usePathname</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录和注册页不用获取登录信息</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  !pathname.<span class="title function_">startsWith</span>(<span class="string">"/user/login"</span>) &amp;&amp;</span><br><span class="line">  !pathname.<span class="title function_">startsWith</span>(<span class="string">"/user/register"</span>)</span><br><span class="line">) {</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2 id="全局权限管理"><a href="#全局权限管理" class="headerlink" title="全局权限管理"></a>全局权限管理</h2><p>需求：能够灵活配置每个页面所需要的用户权限，由全局权限管理系统自动校验和拦截，而不需要在每个页面中编写权限校验代码，提高开发效率。 还要能够根据权限控制导航菜单的显隐，只有具有权限的菜单，才对用户可见。</p>
<h3 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h3><p>1.在路由配置文件，定义某个路由的访问权限。由于 Next.js 项目是约定式路由，只有我们自定义的菜单配置文件，可以在菜单配置文件中定义权限。</p>
<p>2.每次访问页面时，根据用户要访问页面的路由权限信息，判断用户是否有对应的访问权限，并进行相应的拦截处理。这是一个全局逻辑，可以在项目根布局app/layout.tsx中添加。</p>
<p>3.导航栏展示菜单时，可以过滤掉登录用户没有权限的菜单项，从而实现根据权限控制导航菜单的显隐</p>
<h3 id="开发实现"><a href="#开发实现" class="headerlink" title="开发实现"></a>开发实现</h3><p>1）在 app 目录下新建 forbidden 无权限页面，内容随便写，比如：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">Result</span>, <span class="title class_">Button</span> } <span class="keyword">from</span> <span class="string">"antd"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无权限访问</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Forbidden</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Result</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">status</span>=<span class="string">"403"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">title</span>=<span class="string">"403"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">subTitle</span>=<span class="string">"抱歉，您无权访问此页面。 "</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">extra</span>=<span class="string">{</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &lt;<span class="attr">Button</span> <span class="attr">type</span>=<span class="string">"primary"</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          返回主页</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      }</span></span><br><span class="line"><span class="language-xml">    /&gt;</span></span><br><span class="line">  );</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Forbidden</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>2）在 src 下新建 access 目录，所有权限管理相关的代码都放在该目录下，模块化。只要不引入，就不会生效。先在目录中定义权限枚举文件 accessEnum.ts:</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 权限定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACCESS_ENUM</span> = {</span><br><span class="line">  <span class="attr">NOT_LOGIN</span>: <span class="string">"notLogin"</span>,</span><br><span class="line">  <span class="attr">USER</span>: <span class="string">"user"</span>,</span><br><span class="line">  <span class="attr">ADMIN</span>: <span class="string">"admin"</span>,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="variable constant_">ACCESS_ENUM</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>有了枚举类后，可以将全局状态中的默认用户权限改为“未登录”：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">DEFAULT_USER</span>: <span class="variable constant_">API</span>.<span class="property">LoginUserVO</span> = {</span><br><span class="line">  <span class="attr">userName</span>: <span class="string">"未登录"</span>,</span><br><span class="line">  <span class="attr">userProfile</span>: <span class="string">"暂无简介"</span>,</span><br><span class="line">  <span class="attr">userAvatar</span>: <span class="string">"/assets/notLoginUser.png"</span>,</span><br><span class="line">  <span class="attr">userRole</span>: <span class="title class_">AccessEnum</span>.<span class="property">NOT_LOGIN</span>,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>3）在菜单配置文件 menu.tsx 中补充对于权限的配置。比如：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">path</span>: <span class="string">"/admin"</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">"管理"</span>,</span><br><span class="line">  <span class="attr">icon</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">CrownOutlined</span> /&gt;</span></span>,</span><br><span class="line">  <span class="attr">access</span>: <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">ADMIN</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">path</span>: <span class="string">"/admin/user"</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">"用户管理"</span>,</span><br><span class="line">      <span class="attr">access</span>: <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">ADMIN</span>,</span><br><span class="line">    },</span><br><span class="line">  ],</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>4）编写通用的权限校验方法</p>
<p>为什么?因为菜单组件中要判断权限、权限拦截也要用到权限判断功能，所以抽离成公共模块。新建 checkAccess.ts 文件，代码如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 检查权限（检查当前登录用户是否具有某个权限）</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">import AccessEnum from "@/access/accessEnum";</span><br><span class="line">import ACCESS_ENUM from "@/access/accessEnum";</span><br><span class="line"></span><br><span class="line">const checkAccess = (</span><br><span class="line">    loginUser: API.LoginUserVO,</span><br><span class="line">    needAccess = AccessEnum.NOT_LOGIN,</span><br><span class="line">) =&gt; {</span><br><span class="line">    // 获取当前登录用户拥有的权限（如果没有登录，就代表没有权限）</span><br><span class="line">    const loginUserAccess = loginUser?.userRole ?? ACCESS_ENUM.NOT_LOGIN;</span><br><span class="line">    // 如果当前不需要任何权限</span><br><span class="line">    if (needAccess === AccessEnum.NOT_LOGIN) {</span><br><span class="line">        return true;</span><br><span class="line">    }</span><br><span class="line">    // 如果页面需要登录才可访问</span><br><span class="line">    if (needAccess === AccessEnum.USER) {</span><br><span class="line">        // 如果用户未登录，表示无权限</span><br><span class="line">        if (loginUserAccess === ACCESS_ENUM.NOT_LOGIN) {</span><br><span class="line">            return false;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    // 如果需要管理员权限才可访问</span><br><span class="line">    if (needAccess === AccessEnum.ADMIN) {</span><br><span class="line">        // 必须要有管理员权限，如果没有，则表示无权限</span><br><span class="line">        return loginUserAccess === AccessEnum.ADMIN;</span><br><span class="line">    }</span><br><span class="line">    return true;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">export default checkAccess;</span><br></pre></td></tr></tbody></table></figure>

<p>有了枚举类后，可以将全局状态中的默认用户权限改为“未登录”：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">DEFAULT_USER</span>: <span class="variable constant_">API</span>.<span class="property">LoginUserVO</span> = {</span><br><span class="line">  <span class="attr">userName</span>: <span class="string">"未登录"</span>,</span><br><span class="line">  <span class="attr">userProfile</span>: <span class="string">"暂无简介"</span>,</span><br><span class="line">  <span class="attr">userAvatar</span>: <span class="string">"/assets/notLoginUser.png"</span>,</span><br><span class="line">  <span class="attr">userRole</span>: <span class="title class_">AccessEnum</span>.<span class="property">NOT_LOGIN</span>,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>3）在菜单配置文件中 menu.tsx 中补充对于权限的配置。比如：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">path</span>: <span class="string">"/admin"</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">"管理"</span>,</span><br><span class="line">  <span class="attr">icon</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">CrownOutlined</span> /&gt;</span></span>,</span><br><span class="line">  <span class="attr">access</span>: <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">ADMIN</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">path</span>: <span class="string">"/admin/user"</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">"用户管理"</span>,</span><br><span class="line">      <span class="attr">access</span>: <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">ADMIN</span>,</span><br><span class="line">    },</span><br><span class="line">  ],</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>4——编写通用的权限校验方法。</p>
<p>为什么？因为菜单组件中要判断权限、权限拦截也要用到权限判断功能，所以抽离成公共模块。</p>
<p>新建 checkAccess.ts 文件，代码如下:</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="variable constant_">ACCESS_ENUM</span> <span class="keyword">from</span> <span class="string">"@/access/accessEnum"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查权限（判断当前登录用户是否具有某个权限）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginUser 当前登录用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> needAccess 需要有的权限</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean 有无权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkAccess</span> = (<span class="params">loginUser: API.LoginUserVO, needAccess = ACCESS_ENUM.NOT_LOGIN</span>) =&gt; {</span><br><span class="line">  <span class="comment">// 获取当前登录用户具有的权限（如果没有 loginUser，则表示未登录）</span></span><br><span class="line">  <span class="keyword">const</span> loginUserAccess = loginUser?.<span class="property">userRole</span> ?? <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">NOT_LOGIN</span>;</span><br><span class="line">  <span class="keyword">if</span> (needAccess === <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">NOT_LOGIN</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 如果用户登录才能访问</span></span><br><span class="line">  <span class="keyword">if</span> (needAccess === <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">USER</span>) {</span><br><span class="line">    <span class="comment">// 如果用户没登录，那么表示无权限</span></span><br><span class="line">    <span class="keyword">if</span> (loginUserAccess === <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">NOT_LOGIN</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 如果需要管理员权限</span></span><br><span class="line">  <span class="keyword">if</span> (needAccess === <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">ADMIN</span>) {</span><br><span class="line">    <span class="comment">// 如果不为管理员，表示无权限</span></span><br><span class="line">    <span class="keyword">if</span> (loginUserAccess !== <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">ADMIN</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> checkAccess;</span><br></pre></td></tr></tbody></table></figure>

<p>可以根据自己的需要，修改判断权限的逻辑。</p>
<p>5）新增权限校验布局 AccessLayout.tsx，逻辑如下: 1.获取到 pathname 和 loginUser 2.根据 pathname 获取到对应的菜单项配置，并获取到所需的权限 3.调用 checkAccess 函数检测是否具有权限。如果有，则正常返回内容;如果没有，返回到无权限页面。</p>
<p>可以先在 menus.tsx 中编写“根据 pathname 获取到菜单项配置” 的函数，使用递归实现:</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据路径查找所有菜单</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> findAllMenuItemByPath = (<span class="attr">path</span>: <span class="built_in">string</span>): <span class="title class_">MenuDataItem</span> | <span class="function"><span class="params">null</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">findMenuItemByPath</span>(menus, path);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据路径查找菜单</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> findMenuItemByPath = (</span><br><span class="line">  <span class="attr">menus</span>: <span class="title class_">MenuDataItem</span>[],</span><br><span class="line">  <span class="attr">path</span>: <span class="built_in">string</span>,</span><br><span class="line">): <span class="title class_">MenuDataItem</span> | <span class="function"><span class="params">null</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> menu <span class="keyword">of</span> menus) {</span><br><span class="line">    <span class="keyword">if</span> (menu.<span class="property">path</span> === path) {</span><br><span class="line">      <span class="keyword">return</span> menu;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (menu.<span class="property">children</span>) {</span><br><span class="line">      <span class="keyword">const</span> matchedMenuItem = <span class="title function_">findMenuItemByPath</span>(menu.<span class="property">children</span>, path);</span><br><span class="line">      <span class="keyword">if</span> (matchedMenuItem) {</span><br><span class="line">        <span class="keyword">return</span> matchedMenuItem;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>然后就可以编写权限校验布局 AccessLayout.tsx，代码如下：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useSelector } <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">RootState</span> } <span class="keyword">from</span> <span class="string">"@/stores"</span>;</span><br><span class="line"><span class="keyword">import</span> { usePathname } <span class="keyword">from</span> <span class="string">"next/navigation"</span>;</span><br><span class="line"><span class="keyword">import</span> checkAccess <span class="keyword">from</span> <span class="string">"@/access/checkAccess"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Forbidden</span> <span class="keyword">from</span> <span class="string">"@/app/forbidden"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> { findAllMenuItemByPath } <span class="keyword">from</span> <span class="string">"../../config/menus"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AccessEnum</span> <span class="keyword">from</span> <span class="string">"@/access/accessEnum"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统一权限校验拦截器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">children</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AccessLayout</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;</span><br><span class="line">  <span class="title class_">Readonly</span>&lt;{</span><br><span class="line">    <span class="attr">children</span>: <span class="title class_">React</span>.<span class="property">ReactNode</span>;</span><br><span class="line">  }&gt;</span><br><span class="line">&gt; = <span class="function">(<span class="params">{ children }</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> pathname = <span class="title function_">usePathname</span>();</span><br><span class="line">  <span class="keyword">const</span> loginUser = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state: RootState</span>) =&gt;</span> state.<span class="property">loginUser</span>);</span><br><span class="line">  <span class="comment">// 权限校验</span></span><br><span class="line">  <span class="keyword">const</span> menu = <span class="title function_">findAllMenuItemByPath</span>(pathname) || {};</span><br><span class="line">  <span class="keyword">const</span> needAccess = menu?.<span class="property">access</span> ?? <span class="title class_">AccessEnum</span>.<span class="property">NOT_LOGIN</span>;</span><br><span class="line">  <span class="keyword">const</span> canAccess = <span class="title function_">checkAccess</span>(loginUser, needAccess);</span><br><span class="line">  <span class="keyword">if</span> (!canAccess) {</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Forbidden</span> /&gt;</span></span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;&gt;</span>{children}<span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">AccessLayout</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>可以在 RootLayout 中引入，嵌入到 BasicLayout 中：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">RootLayout</span>(<span class="params">{</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">}: Readonly&lt;{</span></span><br><span class="line"><span class="params">  children: React.ReactNode;</span></span><br><span class="line"><span class="params">}&gt;</span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">{store}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">InitLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">BasicLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">AccessLayout</span>&gt;</span>{children}<span class="tag">&lt;/<span class="name">AccessLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">BasicLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">InitLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">AntdRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>6）根据权限控制菜单显隐 新建 menuAccess.ts 文件，提供获取可访问菜单的函数：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> checkAccess <span class="keyword">from</span> <span class="string">"@/access/checkAccess"</span>;</span><br><span class="line"><span class="keyword">import</span> { menus } <span class="keyword">from</span> <span class="string">"../../config/menus"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取有权限、可访问的菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">loginUser</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">menuItems</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getAccessibleMenus</span> = (<span class="params">loginUser: API.LoginUserVO, menuItems = menus</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> menuItems.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">checkAccess</span>(loginUser, item.<span class="property">access</span>)) {</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (item.<span class="property">children</span>) {</span><br><span class="line">      item.<span class="property">children</span> = <span class="title function_">getAccessibleMenus</span>(loginUser, item.<span class="property">children</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> getAccessibleMenus;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>扩展</strong></p>
<p>还有其他实现权限校验的方法，比如使用高阶组件(HOC)在客户端进行权限校验，这种方法会更灵活。</p>
<p>创建一个 HOC 组件：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/withAuth.js</span></span><br><span class="line"><span class="keyword">import</span> { useRouter } <span class="keyword">from</span> <span class="string">'next/router'</span>;</span><br><span class="line"><span class="keyword">import</span> { useEffect } <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> { useSelector } <span class="keyword">from</span> <span class="string">'react-redux'</span>; <span class="comment">// 或者使用其他全局状态管理库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">withAuth</span>(<span class="params">Component</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">AuthenticatedComponent</span>(<span class="params">props</span>) {</span><br><span class="line">    <span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line">    <span class="keyword">const</span> isAuthenticated = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">auth</span>.<span class="property">isAuthenticated</span>); <span class="comment">// 获取用户登录状态</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (!isAuthenticated) {</span><br><span class="line">        <span class="comment">// 如果未登录，重定向到登录页面</span></span><br><span class="line">        router.<span class="title function_">push</span>(<span class="string">'/login'</span>);</span><br><span class="line">      }</span><br><span class="line">    }, [isAuthenticated]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果未登录，不渲染组件</span></span><br><span class="line">    <span class="keyword">if</span> (!isAuthenticated) {</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果已登录，渲染组件</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> {<span class="attr">...props</span>} /&gt;</span></span>;</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>使用这个 HOC 包裹需要进行权限校验的页面：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/protected.js</span></span><br><span class="line"><span class="keyword">import</span> withAuth <span class="keyword">from</span> <span class="string">'@/components/withAuth'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ProtectedPage</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>This is a protected page.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">withAuth</span>(<span class="title class_">ProtectedPage</span>);</span><br></pre></td></tr></tbody></table></figure>



<h2 id="通用组件-Markdown-富文本编辑器"><a href="#通用组件-Markdown-富文本编辑器" class="headerlink" title="通用组件 - Markdown 富文本编辑器"></a>通用组件 - Markdown 富文本编辑器</h2><p>安装命令：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i @bytemd/react</span><br><span class="line">npm i @bytemd/plugin-highlight @bytemd/plugin-gfm</span><br></pre></td></tr></tbody></table></figure>

<p>在 /src/components 目录中新建 MdEditor 组件，编写代码：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">Editor</span> } <span class="keyword">from</span> <span class="string">"@bytemd/react"</span>;</span><br><span class="line"><span class="keyword">import</span> gfm <span class="keyword">from</span> <span class="string">"@bytemd/plugin-gfm"</span>;</span><br><span class="line"><span class="keyword">import</span> highlight <span class="keyword">from</span> <span class="string">"@bytemd/plugin-highlight"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"bytemd/dist/index.css"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"highlight.js/styles/vs.css"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> {</span><br><span class="line">  value?: <span class="built_in">string</span>;</span><br><span class="line">  onChange?: <span class="function">(<span class="params">v: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  placeholder?: <span class="built_in">string</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> plugins = [<span class="title function_">gfm</span>(), <span class="title function_">highlight</span>()];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Markdown 编辑器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">props</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MdEditor</span> = (<span class="params">props: Props</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { value = <span class="string">""</span>, onChange, placeholder } = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"md-editor"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Editor</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">{value}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">placeholder</span>=<span class="string">{placeholder}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">mode</span>=<span class="string">"split"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">plugins</span>=<span class="string">{plugins}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">{onChange}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MdEditor</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>比如隐藏编辑器中不需要的操作图标(像 GitHub 图标)：</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.bytemd-toolbar-icon</span><span class="selector-class">.bytemd-tippy</span><span class="selector-class">.bytemd-tippy-right</span><span class="selector-pseudo">:last-child</span> {</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>MdViewer 实例代码：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">Viewer</span> } <span class="keyword">from</span> <span class="string">"@bytemd/react"</span>;</span><br><span class="line"><span class="keyword">import</span> gfm <span class="keyword">from</span> <span class="string">"@bytemd/plugin-gfm"</span>;</span><br><span class="line"><span class="keyword">import</span> highlight <span class="keyword">from</span> <span class="string">"@bytemd/plugin-highlight"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"bytemd/dist/index.css"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"highlight.js/styles/vs.css"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> {</span><br><span class="line">  value?: <span class="built_in">string</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> plugins = [<span class="title function_">gfm</span>(), <span class="title function_">highlight</span>()];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Markdown 浏览器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">props</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MdViewer</span> = (<span class="params">props: Props</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { value = <span class="string">""</span> } = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"md-viewer"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Viewer</span> <span class="attr">value</span>=<span class="string">{value}</span> <span class="attr">plugins</span>=<span class="string">{plugins}</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MdViewer</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>bytemd 组件引入 github css 样式</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install github-markdown-css --force</span><br></pre></td></tr></tbody></table></figure>

<p>参考上方文档安装之后，在 MdViewer和 MdEditor 中引入样式文件：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'github-markdown-css/github-markdown-light.css'</span>;</span><br></pre></td></tr></tbody></table></figure>



<h2 id="前端页面开发"><a href="#前端页面开发" class="headerlink" title="前端页面开发"></a>前端页面开发</h2><p>前端页面开发，跑通前后端核心业务流程，主要包括:</p>
<ul>
<li>基础页面开发<ul>
<li>用户模块</li>
<li>题库管理页面</li>
<li>题目管理页面</li>
</ul>
</li>
<li>核心页面开发<ul>
<li>主页</li>
<li>题库列表页</li>
<li>题目搜索页</li>
<li>题库详情页</li>
<li>题目详情页</li>
</ul>
</li>
<li>题目题库绑定(管理员)<ul>
<li>按照题库查询题目</li>
<li>修改题目所属题库</li>
</ul>
</li>
</ul>
<h3 id="1、用户登录页面"><a href="#1、用户登录页面" class="headerlink" title="1、用户登录页面"></a>1、用户登录页面</h3><p>可以使用 Ant Design ProComponents 的 ProForm 表单组件，先安装</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @ant-design/pro-form --force</span><br></pre></td></tr></tbody></table></figure>

<p>运用 ProComponents 的登录表单，在其基础上修改即可</p>
<h3 id="2、用户注册页面"><a href="#2、用户注册页面" class="headerlink" title="2、用户注册页面"></a>2、用户注册页面</h3><p>与登录页面类似，只不过表单提交逻辑和多了一个输入框</p>
<h3 id="3、用户管理页面"><a href="#3、用户管理页面" class="headerlink" title="3、用户管理页面"></a>3、用户管理页面</h3><p>安装表格组件依赖：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @ant-design/pro-table --force</span><br></pre></td></tr></tbody></table></figure>

<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p>1）用户管理页面可以通过给删除增加二次确认，减少误操作概率。使用 Popconfirm 组件可轻松实现:<a target="_blank" rel="noopener" href="https://ant-design.antgroup.com/components/popconfirm-cn">https://ant-design.antgroup.com/components/popconfirm-cn</a></p>
<p>2）用户管理页面实现多列排序功能 前端 ProTable 已经默认支持了，通过 request 函数的 sort 参数可以获取到排序条件，需要让后端支持处理多列排序。</p>
<h3 id="4、题目管理页面"><a href="#4、题目管理页面" class="headerlink" title="4、题目管理页面"></a>4、题目管理页面</h3><p>表格列配置：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">columns</span>: <span class="title class_">ProColumns</span>&lt;<span class="variable constant_">API</span>.<span class="property">Question</span>&gt;[] = [</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"id"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"id"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"text"</span>,</span><br><span class="line">    <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"标题"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"title"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"text"</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"内容"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"content"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"text"</span>,</span><br><span class="line">    <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">240</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"答案"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"answer"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"text"</span>,</span><br><span class="line">    <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">640</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"标签"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"tags"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"select"</span>,</span><br><span class="line">    <span class="attr">fieldProps</span>: {</span><br><span class="line">      <span class="attr">mode</span>: <span class="string">"tags"</span>,</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"创建用户"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"userId"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"text"</span>,</span><br><span class="line">    <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">  },</span><br><span class="line"></span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"创建时间"</span>,</span><br><span class="line">    <span class="attr">sorter</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"createTime"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"dateTime"</span>,</span><br><span class="line">    <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"编辑时间"</span>,</span><br><span class="line">    <span class="attr">sorter</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"editTime"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"dateTime"</span>,</span><br><span class="line">    <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"更新时间"</span>,</span><br><span class="line">    <span class="attr">sorter</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"updateTime"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"dateTime"</span>,</span><br><span class="line">    <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"操作"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"option"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"option"</span>,</span><br><span class="line">    <span class="attr">render</span>: <span class="function">(<span class="params">_, record</span>) =&gt;</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">Space</span> <span class="attr">size</span>=<span class="string">"middle"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Typography.Link</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-xml">            setCurrentRow(record);</span></span><br><span class="line"><span class="language-xml">            setUpdateModalVisible(true);</span></span><br><span class="line"><span class="language-xml">          }}</span></span><br><span class="line"><span class="language-xml">          &gt;</span></span><br><span class="line"><span class="language-xml">          修改</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Typography.Link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Typography.Link</span> <span class="attr">type</span>=<span class="string">"danger"</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> handleDelete(record)}&gt;</span></span><br><span class="line"><span class="language-xml">          删除</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Typography.Link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Space</span>&gt;</span></span></span><br><span class="line">    ),</span><br><span class="line">  },</span><br><span class="line">];</span><br></pre></td></tr></tbody></table></figure>

<p>处理特殊逻辑</p>
<p>1）自定标签渲染，把字符串转为标签列表：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">title</span>: <span class="string">"标签"</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">"tags"</span>,</span><br><span class="line">  <span class="attr">valueType</span>: <span class="string">"select"</span>,</span><br><span class="line">  <span class="attr">fieldProps</span>: {</span><br><span class="line">    <span class="attr">mode</span>: <span class="string">"tags"</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">render</span>: <span class="function">(<span class="params">_, record</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> tagList = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(record.<span class="property">tags</span> || <span class="string">"[]"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">TagList</span> <span class="attr">tagList</span>=<span class="string">{tagList}</span> /&gt;</span></span>;</span><br><span class="line">  },</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>tagList 是用于渲染标签列表的组件：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">Tag</span> } <span class="keyword">from</span> <span class="string">"antd"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> {</span><br><span class="line">  tagList?: <span class="built_in">string</span>[];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标签列表组件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">props</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">TagList</span> = (<span class="params">props: Props</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { tagList = [] } = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"tag-list"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {tagList.map((tag) =&gt; {</span></span><br><span class="line"><span class="language-xml">        return <span class="tag">&lt;<span class="name">Tag</span> <span class="attr">key</span>=<span class="string">{tag}</span>&gt;</span>{tag}<span class="tag">&lt;/<span class="name">Tag</span>&gt;</span>;</span></span><br><span class="line"><span class="language-xml">      })}</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">TagList</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>2）需要修改题目内容和答案的输入框为我们封装的 MdEditor 编辑器，可参考 ProTable 官方文档的 自定义表单项渲染。</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">title</span>: <span class="string">"内容"</span>,</span><br><span class="line">  <span class="attr">dataIndex</span>: <span class="string">"content"</span>,</span><br><span class="line">  <span class="attr">valueType</span>: <span class="string">"text"</span>,</span><br><span class="line">  <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">240</span>,</span><br><span class="line">  <span class="attr">renderFormItem</span>: <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    _,</span></span></span><br><span class="line"><span class="params"><span class="function">    { <span class="keyword">type</span>, defaultRender, formItemProps, fieldProps, ...rest },</span></span></span><br><span class="line"><span class="params"><span class="function">    form,</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// value 和 onchange 会通过 form 自动注入。</span></span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">MdEditor</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        // <span class="attr">组件的配置</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        {<span class="attr">...fieldProps</span>}</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  },</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>3）注意，更新数据时，需要将 tags 转换成数组后作为表单初始值，否则无法正常同步到表单。可以在 UpdateModal 中自己 定义初始值对象：</p>
<figure class="highlight ts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表单转换</span></span><br><span class="line"><span class="keyword">let</span> initValues = { ...oldData };</span><br><span class="line"><span class="keyword">if</span> (oldData.<span class="property">tags</span>) {</span><br><span class="line">  initValues.<span class="property">tags</span> = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(oldData.<span class="property">tags</span>) || [];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后在 ProTable 组件中使用初始值对象：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ProTable</span></span><br><span class="line">  <span class="keyword">type</span>=<span class="string">"form"</span></span><br><span class="line">  columns={columns}</span><br><span class="line">  form={{</span><br><span class="line">    <span class="attr">initialValues</span>: initValues,</span><br><span class="line">  }}</span><br><span class="line">/&gt;</span><br></pre></td></tr></tbody></table></figure>



<h2 id="核心页面开发"><a href="#核心页面开发" class="headerlink" title="核心页面开发"></a>核心页面开发</h2><h3 id="主页开发"><a href="#主页开发" class="headerlink" title="主页开发"></a>主页开发</h3><p>利用 Title 组件显示标题，注意引入的库为 <code>import Title from "antd/es/typography/Title";</code></p>
<p>利用 <flex> 组件是组件变为流式布局，自定义题目列表和题库列表组件，并根据后端返回的值填入到对应的组件中</flex></p>
<blockquote>
<p>注意，主页为服务端渲染，但是主页用到的题目列表组件和题库列表组件需要单独抽离出来，并且为客户端渲染</p>
</blockquote>
<h3 id="ProTable-组件"><a href="#ProTable-组件" class="headerlink" title="ProTable 组件"></a>ProTable 组件</h3><p>1、对于 ProComponents 的表格 ProTable 组件，可以通过 <code>hideInSearch: true,hideInForm: true,</code>来显示控制某些列是否要展示在搜素框和表单中。</p>
<p>2、另外 ProTable 渲染多个标签时可以自己实现 render 函数，并自己封装标签列表组件再将标签列表传入其中。</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">title</span>: <span class="string">"标签"</span>,</span><br><span class="line">    <span class="attr">dataIndex</span>: <span class="string">"tags"</span>,</span><br><span class="line">    <span class="attr">valueType</span>: <span class="string">"select"</span>,</span><br><span class="line">    <span class="attr">fieldProps</span>: {</span><br><span class="line">        <span class="attr">mode</span>: <span class="string">"tags"</span>,</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">render</span>: <span class="function">(<span class="params">_, record</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">const</span> tags = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(record.<span class="property">tags</span> || <span class="string">"[]"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">TagList</span> <span class="attr">tags</span>=<span class="string">{tags}/</span>&gt;</span></span>;</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>3、ProTable 表格中的数据的数据是通过 request 函数请求远程获取的，在 return 中我们需要将 total 和 data 的值改为后端返回的值。</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">request={<span class="keyword">async</span> (params, sort, filter) =&gt; {</span><br><span class="line">    <span class="keyword">const</span> sortField = <span class="title class_">Object</span>.<span class="title function_">keys</span>(sort)?.[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> sortOrder = sort?.[sortField] ?? <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> {data, code} = <span class="keyword">await</span> <span class="title function_">listQuestionByPageUsingPost</span>({</span><br><span class="line">        ...params,</span><br><span class="line">        sortField,</span><br><span class="line">        sortOrder,</span><br><span class="line">        ...filter,</span><br><span class="line">    } <span class="keyword">as</span> <span class="variable constant_">API</span>.<span class="property">QuestionQueryRequest</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新结果</span></span><br><span class="line">    <span class="keyword">const</span> newData = data?.<span class="property">records</span> || [];</span><br><span class="line">    <span class="keyword">const</span> newTotal = data?.<span class="property">total</span> || <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="attr">success</span>: code === <span class="number">0</span>,</span><br><span class="line">        <span class="attr">data</span>: newData,</span><br><span class="line">        <span class="attr">total</span>: newTotal,</span><br><span class="line">    };</span><br><span class="line">}}</span><br><span class="line">columns={columns}</span><br></pre></td></tr></tbody></table></figure>

<p>demo：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"use client"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, {useState} <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">ProColumns</span>, <span class="title class_">ProTable</span>} <span class="keyword">from</span> <span class="string">"@ant-design/pro-table"</span>;</span><br><span class="line"><span class="keyword">import</span> {listQuestionByPageUsingPost} <span class="keyword">from</span> <span class="string">"@/api/questionController"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TagList</span> <span class="keyword">from</span> <span class="string">"@/components/TagList"</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">TablePaginationConfig</span>} <span class="keyword">from</span> <span class="string">"antd"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> {</span><br><span class="line">    <span class="comment">// 默认值</span></span><br><span class="line">    defaultQuestionList?: <span class="variable constant_">API</span>.<span class="property">QuestionVO</span>[],</span><br><span class="line">    defaultTotal?: <span class="built_in">number</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目表格组件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">QuestionTable</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">(<span class="params">props: Props</span>) =&gt;</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> {defaultQuestionList, defaultTotal} = props;</span><br><span class="line">    <span class="comment">// 题目列表</span></span><br><span class="line">    <span class="keyword">const</span> [questionList, setQuestionList] = useState&lt;<span class="variable constant_">API</span>.<span class="property">QuestionVO</span>[]&gt;(defaultQuestionList || []);</span><br><span class="line">    <span class="comment">// 题目总数</span></span><br><span class="line">    <span class="keyword">const</span> [total, setTotal] = useState&lt;<span class="built_in">number</span>&gt;(defaultTotal || <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表格列配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">columns</span>: <span class="title class_">ProColumns</span>&lt;<span class="variable constant_">API</span>.<span class="property">Question</span>&gt;[] = [</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">title</span>: <span class="string">'标题'</span>,</span><br><span class="line">            <span class="attr">dataIndex</span>: <span class="string">'title'</span>,</span><br><span class="line">            <span class="attr">valueType</span>: <span class="string">'text'</span>,</span><br><span class="line">            <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">title</span>: <span class="string">"标签"</span>,</span><br><span class="line">            <span class="attr">dataIndex</span>: <span class="string">"tags"</span>,</span><br><span class="line">            <span class="attr">valueType</span>: <span class="string">"select"</span>,</span><br><span class="line">            <span class="attr">fieldProps</span>: {</span><br><span class="line">                <span class="attr">mode</span>: <span class="string">"tags"</span>,</span><br><span class="line">            },</span><br><span class="line">            <span class="attr">render</span>: <span class="function">(<span class="params">_, record</span>) =&gt;</span> {</span><br><span class="line">                <span class="keyword">const</span> tags = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(record.<span class="property">tags</span> || <span class="string">"[]"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">TagList</span> <span class="attr">tags</span>=<span class="string">{tags}/</span>&gt;</span></span>;</span><br><span class="line">            },</span><br><span class="line">            <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">title</span>: <span class="string">'创建人'</span>,</span><br><span class="line">            <span class="attr">dataIndex</span>: <span class="string">'userId'</span>,</span><br><span class="line">            <span class="attr">valueType</span>: <span class="string">'text'</span>,</span><br><span class="line">            <span class="attr">hideInSearch</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">hideInForm</span>: <span class="literal">true</span>,</span><br><span class="line">        },</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"questionTable"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;ProTable<span class="tag">&lt;<span class="name">API.QuestionVO</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                rowKey="key"</span></span><br><span class="line"><span class="language-xml">                size="large"</span></span><br><span class="line"><span class="language-xml">                search={{</span></span><br><span class="line"><span class="language-xml">                    labelWidth: "auto",</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                pagination={{</span></span><br><span class="line"><span class="language-xml">                    pageSize: 12,</span></span><br><span class="line"><span class="language-xml">                    showTotal: (total) =&gt; `总共${total}条`,</span></span><br><span class="line"><span class="language-xml">                    showSizeChanger: false,</span></span><br><span class="line"><span class="language-xml">                    total,</span></span><br><span class="line"><span class="language-xml">                } as TablePaginationConfig}</span></span><br><span class="line"><span class="language-xml">                request={async (params, sort, filter) =&gt; {</span></span><br><span class="line"><span class="language-xml">                    const sortField = Object.keys(sort)?.[0];</span></span><br><span class="line"><span class="language-xml">                    const sortOrder = sort?.[sortField] ?? undefined;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    const {data, code} = await listQuestionByPageUsingPost({</span></span><br><span class="line"><span class="language-xml">                        ...params,</span></span><br><span class="line"><span class="language-xml">                        sortField,</span></span><br><span class="line"><span class="language-xml">                        sortOrder,</span></span><br><span class="line"><span class="language-xml">                        ...filter,</span></span><br><span class="line"><span class="language-xml">                    } as API.QuestionQueryRequest);</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    // 更新结果</span></span><br><span class="line"><span class="language-xml">                    const newData = data?.records || [];</span></span><br><span class="line"><span class="language-xml">                    const newTotal = data?.total || 0;</span></span><br><span class="line"><span class="language-xml">                    setQuestionList(newData);</span></span><br><span class="line"><span class="language-xml">                    setTotal(newTotal);</span></span><br><span class="line"><span class="language-xml">                    return {</span></span><br><span class="line"><span class="language-xml">                        success: code === 0,</span></span><br><span class="line"><span class="language-xml">                        data: newData,</span></span><br><span class="line"><span class="language-xml">                        total: newTotal,</span></span><br><span class="line"><span class="language-xml">                    };</span></span><br><span class="line"><span class="language-xml">                }}</span></span><br><span class="line"><span class="language-xml">                columns={columns}</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    );</span></span><br><span class="line"><span class="language-xml">};</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">export default QuestionTable;</span></span><br></pre></td></tr></tbody></table></figure>

<p>4、ProTable 组件的 form 参数可以通过 initialValus 参数配置初始值</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">form={{</span><br><span class="line">    <span class="attr">initialValues</span>: defaultSearchParams</span><br><span class="line">}}</span><br></pre></td></tr></tbody></table></figure>

<p>ProTable 组件还支持多选表格项，可以通过配置 rowSelection、tableAlertRender、tableAlertOptionRender 等属性实现</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProTable&lt;TableListItem&gt;</span><br><span class="line">      columns={columns}</span><br><span class="line">      rowSelection={{</span><br><span class="line">        // 自定义选择项参考: https://ant.design/components/table-cn/#components-table-demo-row-selection-custom</span><br><span class="line">        // 注释该行则默认不显示下拉选项</span><br><span class="line">        selections: [Table.SELECTION_ALL, Table.SELECTION_INVERT],</span><br><span class="line">        defaultSelectedRowKeys: [1],</span><br><span class="line">      }}</span><br><span class="line">      tableAlertRender={({</span><br><span class="line">        selectedRowKeys,</span><br><span class="line">        selectedRows,</span><br><span class="line">        onCleanSelected,</span><br><span class="line">      }) =&gt; {</span><br><span class="line">        console.log(selectedRowKeys, selectedRows);</span><br><span class="line">        return (</span><br><span class="line">          &lt;Space size={24}&gt;</span><br><span class="line">            &lt;span&gt;</span><br><span class="line">              已选 {selectedRowKeys.length} 项</span><br><span class="line">              &lt;a style={{ marginInlineStart: 8 }} onClick={onCleanSelected}&gt;</span><br><span class="line">                取消选择</span><br><span class="line">              &lt;/a&gt;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">            &lt;span&gt;{`容器数量: ${selectedRows.reduce(</span><br><span class="line">              (pre, item) =&gt; pre + item.containers,</span><br><span class="line">              0,</span><br><span class="line">            )} 个`}&lt;/span&gt;</span><br><span class="line">            &lt;span&gt;{`调用量: ${selectedRows.reduce(</span><br><span class="line">              (pre, item) =&gt; pre + item.callNumber,</span><br><span class="line">              0,</span><br><span class="line">            )} 次`}&lt;/span&gt;</span><br><span class="line">          &lt;/Space&gt;</span><br><span class="line">        );</span><br><span class="line">      }}</span><br><span class="line">      tableAlertOptionRender={() =&gt; {</span><br><span class="line">        return (</span><br><span class="line">          &lt;Space size={16}&gt;</span><br><span class="line">            &lt;a&gt;批量删除&lt;/a&gt;</span><br><span class="line">            &lt;a&gt;导出数据&lt;/a&gt;</span><br><span class="line">          &lt;/Space&gt;</span><br><span class="line">        );</span><br><span class="line">      }}</span><br><span class="line">      dataSource={tableListDataSource}</span><br><span class="line">      scroll={{ x: 1300 }}</span><br><span class="line">      options={false}</span><br><span class="line">      search={false}</span><br><span class="line">      pagination={{</span><br><span class="line">        pageSize: 5,</span><br><span class="line">      }}</span><br><span class="line">      rowKey="key"</span><br><span class="line">      headerTitle="批量操作"</span><br><span class="line">      toolBarRender={() =&gt; [&lt;Button key="show"&gt;查看日志&lt;/Button&gt;]}</span><br><span class="line">    /&gt;</span><br></pre></td></tr></tbody></table></figure>



<p>next.js 中在组件形参中加上 searchParams 默认就能获取搜索参数的值</p>
<h3 id="题库详情页"><a href="#题库详情页" class="headerlink" title="题库详情页"></a>题库详情页</h3><figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"use server"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"><span class="keyword">import</span> {<span class="title class_">Avatar</span>, <span class="title class_">Button</span>, <span class="title class_">Card</span>, message} <span class="keyword">from</span> <span class="string">"antd"</span>;</span><br><span class="line"><span class="keyword">import</span> {getQuestionBankVoByIdUsingGet} <span class="keyword">from</span> <span class="string">"@/api/questionBankController"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Meta</span> <span class="keyword">from</span> <span class="string">"antd/es/card/Meta"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Paragraph</span> <span class="keyword">from</span> <span class="string">"antd/es/typography/Paragraph"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">QuestionList</span> <span class="keyword">from</span> <span class="string">"@/components/QuestionList"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Title</span> <span class="keyword">from</span> <span class="string">"antd/es/typography/Title"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题库详情页</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">BankPage</span>(<span class="params">{ params }</span>) {</span><br><span class="line">  <span class="keyword">const</span> { questionBankId } = params;</span><br><span class="line">  <span class="keyword">let</span> bank = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getQuestionBankVoByIdUsingGet</span>({</span><br><span class="line">          <span class="attr">id</span>: questionBankId,</span><br><span class="line">          <span class="attr">needQueryQuestionList</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="comment">// 可以自行扩展为分页实现</span></span><br><span class="line">          <span class="attr">pageSize</span>: <span class="number">200</span>,</span><br><span class="line">      });</span><br><span class="line">      bank = res?.<span class="property">data</span>;</span><br><span class="line">  } <span class="keyword">catch</span> (e) {</span><br><span class="line">    message.<span class="title function_">error</span>(<span class="string">"获取题目失败，"</span> + e.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果题目不存在，进行错误处理</span></span><br><span class="line">  <span class="keyword">if</span> (!bank) {</span><br><span class="line">      <span class="keyword">return</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>获取题库详情失败，请刷新重试<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取第一道题目</span></span><br><span class="line">    <span class="keyword">let</span> firstQuestionId;</span><br><span class="line">  <span class="keyword">if</span> (bank.<span class="property">questionPage</span>?.<span class="property">records</span> &amp;&amp; bank.<span class="property">questionPage</span>.<span class="property">records</span>.<span class="property">length</span> &gt; <span class="number">0</span>) {</span><br><span class="line">      firstQuestionId = bank.<span class="property">questionPage</span>.<span class="property">records</span>[<span class="number">0</span>];</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"bankPage"</span> <span class="attr">className</span>=<span class="string">"max-width-content"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Title</span> <span class="attr">level</span>=<span class="string">{2}</span>&gt;</span>{bank.name}<span class="tag">&lt;/<span class="name">Title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Card</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Meta</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">avatar</span>=<span class="string">{</span>&lt;<span class="attr">Avatar</span> <span class="attr">src</span>=<span class="string">{bank.picture}</span> <span class="attr">size</span>=<span class="string">{72}/</span>&gt;</span>}</span></span><br><span class="line"><span class="language-xml">                    title={</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Title</span> <span class="attr">level</span>=<span class="string">{3}</span> <span class="attr">style</span>=<span class="string">{{marginBottom:</span> <span class="attr">0</span>}}&gt;</span></span></span><br><span class="line"><span class="language-xml">                        {bank.title}</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    }</span></span><br><span class="line"><span class="language-xml">                    description={</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Paragraph</span> <span class="attr">type</span>=<span class="string">"secondary"</span> <span class="attr">ellipsis</span>=<span class="string">{{rows:</span> <span class="attr">1</span>}} <span class="attr">style</span>=<span class="string">{{marginBottom:</span> <span class="attr">0</span>}}&gt;</span></span></span><br><span class="line"><span class="language-xml">                            {bank.description}</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Paragraph</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">"primary"</span> <span class="attr">shape</span>=<span class="string">"round"</span> <span class="attr">href</span>=<span class="string">{</span>`/<span class="attr">bank</span>/${<span class="attr">questionBankId</span>}/<span class="attr">question</span>/${<span class="attr">firstQuestionId</span>}`} <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">disabled</span>=<span class="string">{!firstQuestionId}</span>&gt;</span>开始刷题<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="language-xml">                    }</span></span><br><span class="line"><span class="language-xml">                /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Card</span>&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">{{marginBottom:</span> <span class="attr">16</span>}}&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">QuestionList</span> <span class="attr">questionList</span>=<span class="string">{bank.questionPage.records</span> ?? []} <span class="attr">cardTitle</span>=<span class="string">{</span>`<span class="attr">題目列表</span>（${</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">bank.questionPage</span>?<span class="attr">.total</span> ?? <span class="attr">0</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        }）`} <span class="attr">questionBankId</span>=<span class="string">{questionBankId}/</span>&gt;</span></span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="题目详情页"><a href="#题目详情页" class="headerlink" title="题目详情页"></a>题目详情页</h3><p>需求:有两种不同的题目详情页</p>
<p>1.从题库进入的题目详情页:左侧需要展示题库内的题目列表。路由:/bank/[bankld]/question/[questionld</p>
<p>2.从其他位置(比如主页、搜索页)进入的题目详情页，不需要展示题库列表。路由：/question/[questionld] 这两个页面极为相似，可以直接开发额外展示题目列表的题目详情页，另一个页面复制并删减即可</p>
<p>为什么题目详情页的标题要是一级的 =&gt; 为了被搜索引擎爬虫收录</p>
<p>对于 Ant Design 组件库，凡是某个组件定义了 React.Node 都是可以传组件的</p>
<p>Menu 组件如何实现选中菜单高亮？</p>
<blockquote>
<p>通过往 selectedKeys 属性传 数组实现对应的菜单项高亮</p>
</blockquote>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Menu</span> items={questionMenuItemList} selectedKeys={[question.<span class="property">id</span>]}/&gt;</span><br></pre></td></tr></tbody></table></figure>



<h4 id="Form-组件"><a href="#Form-组件" class="headerlink" title="Form 组件"></a>Form 组件</h4><p>1、可以根据 useForm 函数获取 form 表的参数</p>
<p>2、根据 setFieldValue 函数设置表单项的值</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [form] = <span class="title class_">Form</span>.<span class="title function_">useForm</span>();</span><br><span class="line">form.<span class="title function_">setFieldValue</span>(<span class="string">"questionBankIdList"</span>, questionBankIdList);</span><br></pre></td></tr></tbody></table></figure>



<p>3、Select 组件支持传入 options 属性指定下拉框所选项</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">options={questionBankList.<span class="title function_">map</span>(<span class="function">(<span class="params">questionBank</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="attr">label</span>: questionBank.<span class="property">title</span>,</span><br><span class="line">        <span class="attr">value</span>: questionBank.<span class="property">id</span>,</span><br><span class="line">    };</span><br><span class="line">})}</span><br></pre></td></tr></tbody></table></figure>



<p>4、Select 组件还支持传入 onSelect 函数和 onDeselect 函数，使得选中、取消选中值时编写相应逻辑，比如给后端发请求</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">onSelect={async (value) =&gt; {</span><br><span class="line">    const hide = message.loading('正在更新');</span><br><span class="line">    try {</span><br><span class="line">        await addQuestionBankQuestionUsingPost({</span><br><span class="line">            questionId,</span><br><span class="line">            questionBankId: value,</span><br><span class="line">        });</span><br><span class="line">        hide();</span><br><span class="line">        message.success('绑定题库成功');</span><br><span class="line">        return true;</span><br><span class="line">    } catch (error: any) {</span><br><span class="line">        hide();</span><br><span class="line">        message.error('绑定题库失败，' + error.message);</span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line">}}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>扩展思路：</p>
<p>1、预渲染 通过 官方文档 了解 Next.js 的 prefetch 预渲染机制，进行性能优化。</p>
<p>比如页面内的链接过多时，预渲染次数会很多，可以将 prefetch 关闭来减少预渲染:</p>
<p>2、Metadata Next.js 支持通过 Metadata 设置页面的 TDK(标题、描述、关键词)等网页元信息。可参考官方文档:<a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/building-your-application/optimizing/metadata">https://nextjs.org/docs/app/building-your-application/optimizing/metadata</a></p>
<p>3、请求缓存 Next.is 扩展了原生的 fetch，支持请求数据的服务端缓存，是提升性能、减少资源占用的好方法。可以参考官方获取数据的文档:<a target="_blank" rel="noopener" href="https://nextjs.org/docs/app/building-your-application/data-fetching%E4%BD%86%E6%98%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84">https://nextjs.org/docs/app/building-your-application/data-fetching但是，我们项目中使用的</a> Axios 库是不支持缓存的!有其他的方式来实现缓存:1)可以在 getStaticProps 或 getServerSideProps 中使用 Axios 来获取数据，然后通过 Next.js 的 revalidate选项来控制页面或数据的重新生成时间。</p>
<p>4、并发请求</p>
<p>如果同一个页面要多次请求后端，串行可能会很慢，导致页面迟迟不返回。因此可以并发调用多个接口来获取数据，使用 promise.all 语法即可。</p>
</blockquote>
<h3 id="用户刷题记录日历"><a href="#用户刷题记录日历" class="headerlink" title="用户刷题记录日历"></a>用户刷题记录日历</h3><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>为了鼓励用户多在网站上刷题，并且能自主复盘学习情况，增加成就感，需要支持用户刷题记录日历功能。</p>
<p>每个用户有自己的签到记录，具体拆解为 2 个子需求:</p>
<ol>
<li>用户每日首次浏览题目，算作是签到，会记 统中。</li>
<li>用户可以在前端以图表的形式查看自己在 某个年份 的刷题签到记录(每天是否有签到)</li>
</ol>
<h3 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h3><p><strong>后端方案 — 基于数据库</strong></p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_sign_in (</span><br><span class="line">  id <span class="type">BIGINT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,  <span class="comment">-- 主键，自动递增</span></span><br><span class="line">  userId <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,               <span class="comment">-- 用户ID，关联用户表</span></span><br><span class="line">  signDate <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,            <span class="comment">-- 签到日期</span></span><br><span class="line">  createdTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,  <span class="comment">-- 记录创建时间</span></span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY uq_user_date (userId, signDate)  <span class="comment">-- 用户ID和签到日期的唯一性约束</span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>

<p>通过唯一索引，可以确保同一用户在同一天内只能签到一次。通过下面的 SQL 即可查询用户的签到记录：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> signDate <span class="keyword">FROM</span> user_sign_in </span><br><span class="line"><span class="keyword">WHERE</span> userId <span class="operator">=</span> ? <span class="keyword">AND</span> signDate <span class="keyword">BETWEEN</span> ？<span class="keyword">AND</span> ?;</span><br></pre></td></tr></tbody></table></figure>

<p>优点：原理简单，容易实现，适用于用户量较小的系统</p>
<p>缺点：随着用户量和数据量增大，对数据库的压力增大，直接查询数据库性能较差。除了单接口的响应会增加，可能整个系统都会被其拖垮。</p>
<p><strong>后端方法—基于 Redis Set</strong></p>
<p>可以利用内存缓存加速读写，常用的本地缓存是 Caffeine，分布式缓存是 Redis。由于每个用户会有多个签到记录，很适合使用 Redis 的 Set 类型存储，每个用户对应一个键，Set 内的每个元素为签到的具体日期。</p>
<p>Redis Key的设计为:user:signins:{userId}</p>
<p>其中:</p>
<ul>
<li>user 是业务领域前缀</li>
<li>signins 是具体操作或功能</li>
<li>{userld}表示每个用户，是动态值</li>
</ul>
<p>如果 Redis 被多个项目公用，还可以在开头增加项目前缀区分，比如 mianshiya:user:signins:{userId}。</p>
<blockquote>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240912221315.png" alt="07F1567C">扩展知识：Redis 键设计规范 明确性:键名称应明确表示数据的含义和结构。例如，通过使用signins 可以清楚地知道这个键与用户的签到记录有关。 层次结构:使 号:分隔不同的部分，可以使键结构化，便于管理和查询。 唯一性:确保键的唯一性，避免不同数据使用相同的键前缀。 一致性:在整个系统中保持键设计的一致性，使得管理和维护变得更加简单。 长度:避免过长的键名称，以防影响性能和存储效率。</p>
</blockquote>
<p>该方案的优点：Set 数据结构天然支持去重，适合存储和检索打卡记录。</p>
<p>缺点：上述设计显然存储了很多重复的字符串，针对海量数据场景，需要考虑内存的占用量。</p>
<p>比如下列数据：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key = user:signins:123</span><br><span class="line">value = ["2024-09-01", "2024-09-02", "2024-10-01", "2024-10-02"]</span><br></pre></td></tr></tbody></table></figure>

<p>其中年份被重复存储。</p>
<p>为了减少内存占用，还可以在 key 中增加更多日期层级，比如 <code>user:signins:{year}:{userId}</code>，实例命令如下：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SADD user:signins:2024:123 "09-01"</span><br><span class="line">SADD user:signins:2024:123 "10-01"</span><br></pre></td></tr></tbody></table></figure>

<p>这样一来，不仅节约了内存，也便于管理，可以轻松查询某个用户在某个年份的签到情况。</p>
<p>💡 存储 <strong>100 万个用户</strong> 的 <strong>365 天</strong> 签到记录，使用 Redis 集合类型来存储每个用户的签到信息，每个用户需要大约 <strong>1880 字节1608639807578177538_0.9860546375639874</strong> 的空间，总共需要大约 <strong>1.88GB</strong> 的内存空间，相比数据库节约了 10 倍左右。</p>
<p><strong>后端方案—BitMap位图</strong></p>
<p>位图是一个用位表示数据的紧凑数据结构，每个位可以存储两个值：0 或 1，常用于表示某种状态。在签到系统中，可以用 1 表示已签到，0 表示未签到。以用户的 id 和年份作为 key，1 和 0 表示用户在一年中是否签到，bitmap 本质是有 Zset 实现的，所以我们可以这么是设计，假如用户在第一天签到了，那么 zset 索引为 0 的位置改为 1，假如在第 30 天签到了，那么 zset 索引为 29 的位置改为 1，其余就为 0。最后我们遍历 Zset 集合，根据值为 1 的索引与本年的第一天进行计算，从而算出签到的日期。</p>
<blockquote>
<p>现代计算机体系结构通常以字节（8位）作为最小寻址单位，那么上述的 bit 是如何存储的呢？</p>
<p>答案就是 <strong>打包</strong>。</p>
</blockquote>
<p>对每一位操作时，要使用位运算进行访问，所以上述的图实际应该改成：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424258.png" alt="img"></p>
<p>💡 对于刷题签到记录场景，一个用户存储一年的数据仅需占用 46 字节，因为 46 * 8 = 368，能覆盖 365 天的记录。那一百万用户也才占用 43.8 MB，相比于 Redis Set 结构节约了 40 多倍存储空间！</p>
<p>1000w 个用户也才占用 438 MB！恭喜你，设计出了一个低成本支持千万用户的系统！</p>
<p>当然，我们没必要自己通过 int 等类型实现 Bitmap，JDK 自带了 BitSet 类、Redis 也支持 Bitmap 高级数据结构。考虑到项目的分布式、可扩展性，采用 Redis 的 Bitmap 实现。</p>
<p>综上所述，Redis Key 的设计为：<code>user:signins:{年份}:{userId}</code></p>
<blockquote>
<p>在 Java 程序中，还可以使用 Redisson 库提供的现成的 RBitSet，开发成本也很低。</p>
<p>这种方案的优点：内存占用极小，适合大规模用户和日期的场景。</p>
<p>缺点：需要熟悉位图操作，不够直观。</p>
</blockquote>
<h3 id="前端方案"><a href="#前端方案" class="headerlink" title="前端方案"></a>前端方案</h3><p>要明确前端展示签到记录日历所需的数据类型，后端才好设计接口的返回值，因此方案设计阶段要考虑全面。 复杂的展示组件肯定不用自己开发，只要是图表(可视化)，就可以优先考虑使用 Apache Echarts 前端可视化库，有3种可行的组件：</p>
<p>1.基础日历图：<a target="_blank" rel="noopener" href="https://echarts.apache.org/examples/zh/editor.html?c=calendar-simple">https://echarts.apache.org/examples/zh/editor.html?c=calendar-simple</a></p>
<p>2.日历热力图：<a target="_blank" rel="noopener" href="https://echarts.apache.org/examples/zh/editor.htm!?c=calendar-heatmap%EF%BC%8C%E8%B7%9F%E4%B8%8A%E4%B8%80%E4%B8%AA%E5%9B%BE%E7%9A%84%E5%8C%BA%E5%88%AB%E5%B0%B1%E6%98%AF%E9%BC%A0%E6%A0%87%E6%94%BE%E4%B8%8A%E5%8E%BB%E5%8F%AF%E4%BB%A5%E5%B1%95%E7%A4%BA%E5%85%B7%E4%BD%93%E7%9A%84%E7%83%AD%E5%8A%9B%E5%80%BC%EF%BC%8C%E7%83%AD%E5%8A%9B%E5%80%BC%E8%B6%8A%E9%AB%98%EF%BC%8C%E5%9B%BE%E5%9D%97%E7%9A%84%E9%A2%9C%E8%89%B2%E8%B6%8A%E6%B7%B1%E3%80%82">https://echarts.apache.org/examples/zh/editor.htm!?c=calendar-heatmap，跟上一个图的区别就是鼠标放上去可以展示具体的热力值，热力值越高，图块的颜色越深。</a></p>
<p>3.日历图：<a target="_blank" rel="noopener" href="https://echarts.apache.org/examples/zh/editor.html?c=calendar-charts">https://echarts.apache.org/examples/zh/editor.html?c=calendar-charts</a></p>
<p>本项目选择基础日历图即可，不涉及热力数值的区分(只有0和1签到/未签到的区别)：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424011.png" alt="img"></p>
<p>如下是官方 Demo 的数据格式：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> time = date; time &lt;= end; time += dayTime) {</span><br><span class="line">  data.<span class="title function_">push</span>([</span><br><span class="line">    echarts.<span class="property">time</span>.<span class="title function_">format</span>(time, <span class="string">'{yyyy}-{MM}-{dd}'</span>, <span class="literal">false</span>),</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10000</span>)</span><br><span class="line">  ]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>很明显得到的数据是一个二位数组，每个元素表示对应的日期和热力值，很明显我们后端就要返回如上的结构的数据</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [<span class="string">'2017-01-01'</span>, <span class="number">3456</span>],</span><br><span class="line">  [<span class="string">'2017-01-02'</span>, <span class="number">8975</span>],</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>但回归我们的项目，用 Bitmap 每天最多只有一次记录，相当于只有 0 和 1。因此可以调整 Apache ECharts 图表的配置来调整热力值的范围，从而控制颜色深浅。还支持调整颜色：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">visualMap</span>: {</span><br><span class="line">  <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">max</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">inRange</span>: {</span><br><span class="line">    <span class="attr">color</span>: [<span class="string">'#efefef'</span>, <span class="string">'lightgreen'</span>]  <span class="comment">// 颜色从灰色到浅绿色</span></span><br><span class="line">  },</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>效果如图：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424144.png" alt="img"></p>
<h3 id="后端开发"><a href="#后端开发" class="headerlink" title="后端开发"></a>后端开发</h3><p>因此我们要开发两个接口</p>
<ol>
<li>用户添加签到记录接口</li>
<li>查询刷题签到记录接口</li>
</ol>
<p>1、引入Redisson</p>
<p><a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">Redisson</a> 是一个基于 Redis 的开源分布式 Java 数据库客户端，提供了类似 Java 标准库的数据结构（如 Map、Set、List、BitSet 等）在分布式环境下的实现。它不仅支持基本的 Redis 操作，还提供了高级功能，如分布式锁、同步器、限流器、缓存等，简化了在分布式系统中使用 Redis 进行数据共享和并发控制的复杂性。</p>
<p><img src="https://pic.yupi.icu/1285/202409061424370.png" alt="img"></p>
<p>1）引入 Redisson 依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>2）编写 Redisson 配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "spring.redis")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">// 1. 创建配置</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisAddress</span> <span class="operator">=</span> String.format(<span class="string">"redis://%s:%s"</span>, host, port);</span><br><span class="line">        config.useSingleServer().setAddress(redisAddress).setDatabase(<span class="number">7</span>).setPassword(password);<span class="comment">//设置单个服务器，设置地址，选择数据库</span></span><br><span class="line">        <span class="comment">// 2. 创建实例</span></span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">        <span class="keyword">return</span> redisson;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2、开发刷题签到记录接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addUserSignIn</span><span class="params">(HttpServletRequest request)</span> {</span><br><span class="line">    <span class="type">User</span> <span class="variable">loginUser</span> <span class="operator">=</span> <span class="built_in">this</span>.getLoginUser(request);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> loginUser.getId();</span><br><span class="line">    <span class="type">RBitSet</span> <span class="variable">bitSet</span> <span class="operator">=</span> redisson.getBitSet(RedisConstant.getUserSignInRedisKey(userId));</span><br><span class="line">    <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> LocalDateTime.now().getDayOfYear();</span><br><span class="line">    <span class="keyword">if</span> (!bitSet.get(offset)) {</span><br><span class="line">        <span class="keyword">return</span> bitSet.set(offset);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3、开发签到记录查询接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;LocalDate, Boolean&gt; <span class="title function_">getSignInRecord</span><span class="params">(<span class="type">long</span> userId, Integer year)</span> {</span><br><span class="line">    <span class="keyword">if</span> (year == <span class="literal">null</span>) {</span><br><span class="line">        year = DateUtils.getNowYear();</span><br><span class="line">    }</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.getUserSignInRedisKey(year, userId);</span><br><span class="line">    <span class="type">RBitSet</span> <span class="variable">signInBitSet</span> <span class="operator">=</span> redisson.getBitSet(key);</span><br><span class="line">    <span class="comment">// LinkedHashMap 保证有序</span></span><br><span class="line">    Map&lt;LocalDate, Boolean&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 获取当前年份的总天数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">totalDays</span> <span class="operator">=</span> Year.of(year).length();</span><br><span class="line">    <span class="comment">// 依次获取每一天的签到状态</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">dayOfYear</span> <span class="operator">=</span> <span class="number">1</span>; dayOfYear &lt;= totalDays; dayOfYear++) {</span><br><span class="line">        <span class="comment">// 获取 key：当前日期</span></span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">currentDate</span> <span class="operator">=</span> LocalDate.ofYearDay(year, dayOfYear);</span><br><span class="line">        <span class="comment">// 获取 value：当天是否有刷题</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasRecord</span> <span class="operator">=</span> signInBitSet.get(dayOfYear);</span><br><span class="line">        <span class="comment">// 将结果放入 map</span></span><br><span class="line">        result.put(currentDate, hasRecord);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>性能优化</strong></p>
<p>由于每次查询用户的签到记录，都要访问 Redis 去查看是否有签到记录，每一个循环就要请求一次 Redis，这样就导致性能十分低下，因此我们可以通过本地缓存来降低对 Redis 的压力。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;LocalDate, Boolean&gt; <span class="title function_">getSignInRecord</span><span class="params">(<span class="type">long</span> userId, Integer year)</span> {</span><br><span class="line">    <span class="keyword">if</span> (year == <span class="literal">null</span>) {</span><br><span class="line">        year = DateUtils.getNowYear();</span><br><span class="line">    }</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.getUserSignInRedisKey(year, userId);</span><br><span class="line">    <span class="type">RBitSet</span> <span class="variable">signInBitSet</span> <span class="operator">=</span> redisson.getBitSet(key);</span><br><span class="line">    <span class="type">BitSet</span> <span class="variable">bitSet</span> <span class="operator">=</span> signInBitSet.asBitSet();</span><br><span class="line">    <span class="comment">// LinkedHashMap 保证有序</span></span><br><span class="line">    Map&lt;LocalDate, Boolean&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 获取当前年份的总天数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">totalDays</span> <span class="operator">=</span> Year.of(year).length();</span><br><span class="line">    <span class="comment">// 依次获取每一天的签到状态</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">dayOfYear</span> <span class="operator">=</span> <span class="number">1</span>; dayOfYear &lt;= totalDays; dayOfYear++) {</span><br><span class="line">        <span class="comment">// 获取 key：当前日期</span></span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">currentDate</span> <span class="operator">=</span> LocalDate.ofYearDay(year, dayOfYear);</span><br><span class="line">        <span class="comment">// 获取 value：当天是否有刷题</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasRecord</span> <span class="operator">=</span> bitSet.get(dayOfYear);</span><br><span class="line">        <span class="comment">// 将结果放入 map</span></span><br><span class="line">        result.put(currentDate, hasRecord);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2、刷题记录返回优化</p>
<p>从返回结果看出传输的数据较多、计算时间较长、带宽占用较大，效率低</p>
<p>实际上我们继续将有刷题记录的日期返回给前端就好了，随后再由前段渲染刷过题的日期，其余就是没刷过题的</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getUserSignInRecord</span><span class="params">(<span class="type">long</span> userId, Integer year)</span> {</span><br><span class="line">    <span class="keyword">if</span> (year == <span class="literal">null</span>) {</span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line">        year = date.getYear();</span><br><span class="line">    }</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.getUserSignInRedisKey(year, userId);</span><br><span class="line">    <span class="type">RBitSet</span> <span class="variable">signInBitSet</span> <span class="operator">=</span> redissonClient.getBitSet(key);</span><br><span class="line">    <span class="comment">// 加载 BitSet 到内存中，避免后续读取时发送多次请求</span></span><br><span class="line">    <span class="type">BitSet</span> <span class="variable">bitSet</span> <span class="operator">=</span> signInBitSet.asBitSet();</span><br><span class="line">    <span class="comment">// 统计签到的日期</span></span><br><span class="line">    List&lt;Integer&gt; dayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 获取当前年份的总天数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">totalDays</span> <span class="operator">=</span> Year.of(year).length();</span><br><span class="line">    <span class="comment">// 依次获取每一天的签到状态</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">dayOfYear</span> <span class="operator">=</span> <span class="number">1</span>; dayOfYear &lt;= totalDays; dayOfYear++) {</span><br><span class="line">        <span class="comment">// 获取 value：当天是否有刷题</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasRecord</span> <span class="operator">=</span> bitSet.get(dayOfYear);</span><br><span class="line">        <span class="keyword">if</span> (hasRecord) {</span><br><span class="line">            dayList.add(dayOfYear);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> dayList;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3、计算优化</p>
<p>上述代码中，我们使用循环来遍历所有年份，而循环是需要消耗CPU 计算资源的。在 Java 中的 Bitset 类中，可以使用 nextsetBit(int fromIndex)和 nextclearBit(int fromIndex)方法来获取从指定索引开始的下一个 已设置(即为 1) 或 未设置(即为 0) 的位。主要是 2 个方法: nextsetBit(int fromIndex):从 fromIndex 开始(包括 fromIndex 本身)寻找下一个被设置为1的位。如果找到了，返回该位的索引;如果没有找到，返回-1。</p>
<p>nextclearBit(int fromIndex):从 fromIndex 开始(包括 fromIndex本身)寻找下一个为0的位。如果找到了 返回该位的索引;如果没有找到，返回一个大的整数值。</p>
<p>使用 nextSetBit，可以跳过无意义的循环检查，通过位运算来获取被设置为1的位置，性能更高。</p>
<p>修改后的代码如下:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getUserSignInRecord</span><span class="params">(<span class="type">long</span> userId, Integer year)</span> {</span><br><span class="line">    <span class="keyword">if</span> (year == <span class="literal">null</span>) {</span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line">        year = date.getYear();</span><br><span class="line">    }</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.getUserSignInRedisKey(year, userId);</span><br><span class="line">    <span class="type">RBitSet</span> <span class="variable">signInBitSet</span> <span class="operator">=</span> redissonClient.getBitSet(key);</span><br><span class="line">    <span class="comment">// 加载 BitSet 到内存中，避免后续读取时发送多次请求</span></span><br><span class="line">    <span class="type">BitSet</span> <span class="variable">bitSet</span> <span class="operator">=</span> signInBitSet.asBitSet();</span><br><span class="line">    <span class="comment">// 统计签到的日期</span></span><br><span class="line">    List&lt;Integer&gt; dayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 从索引 0 开始查找下一个被设置为 1 的位</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> bitSet.nextSetBit(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span> (index &gt;= <span class="number">0</span>) {</span><br><span class="line">        dayList.add(index);</span><br><span class="line">        <span class="comment">// 查找下一个被设置为 1 的位</span></span><br><span class="line">        index = bitSet.nextSetBit(index + <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> dayList;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="优化小结"><a href="#优化小结" class="headerlink" title="优化小结"></a>优化小结</h4><p>优化小结 本功能的性能优化也是有代表性的，总结出来几个实用优化思路:</p>
<ol>
<li>减少网络请求或调用次数</li>
<li>减少接口传输数据的体积</li>
<li>减少循环和计算</li>
<li>通过客户端计算减少服务端的压力</li>
</ol>
<h3 id="前端开发"><a href="#前端开发" class="headerlink" title="前端开发"></a>前端开发</h3><p>1、引入 ECharts 组件库</p>
<p>安装 ECharts：<a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html1608639807578177538_0.43979611555120557">https://echarts.apache.org/zh/index.html1608639807578177538_0.43979611555120557</a></p>
<p>和 React ECharts 可视化库：<a target="_blank" rel="noopener" href="https://github.com/hustcc/echarts-for-react">https://github.com/hustcc/echarts-for-react</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save echarts --force</span><br><span class="line">npm install --save echarts-for-react --force</span><br></pre></td></tr></tbody></table></figure>

<p>2、用户中心页面开发</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Dropdown</span></span><br><span class="line">  menu={{</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">key</span>: <span class="string">"userCenter"</span>,</span><br><span class="line">        <span class="attr">icon</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">UserOutlined</span> /&gt;</span></span>,</span><br><span class="line">        <span class="attr">label</span>: <span class="string">"个人中心"</span>,</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">key</span>: <span class="string">"logout"</span>,</span><br><span class="line">        <span class="attr">icon</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">LogoutOutlined</span> /&gt;</span></span>,</span><br><span class="line">        <span class="attr">label</span>: <span class="string">"退出登录"</span>,</span><br><span class="line">      },</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">onClick</span>: <span class="keyword">async</span> (<span class="attr">event</span>: { <span class="attr">key</span>: <span class="title class_">React</span>.<span class="property">Key</span> }) =&gt; {</span><br><span class="line">      <span class="keyword">const</span> { key } = event;</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">"logout"</span>) {</span><br><span class="line">        <span class="title function_">userLogout</span>();</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">"userCenter"</span>) {</span><br><span class="line">        router.<span class="title function_">push</span>(<span class="string">"/user/center"</span>);</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">  }}</span><br><span class="line">&gt;</span><br><span class="line">  {dom}</span><br><span class="line">&lt;/<span class="title class_">Dropdown</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>页面结构可以通过如下组件快速完成：</p>
<p>栅格响应式布局：<a target="_blank" rel="noopener" href="https://ant-design.antgroup.com/components/grid-cn#grid-demo-responsive">https://ant-design.antgroup.com/components/grid-cn#grid-demo-responsive</a> 左侧用户信息，Card.Meta 组件：<a target="_blank" rel="noopener" href="https://ant-design.antgroup.com/components/card-cn#card-demo-meta">https://ant-design.antgroup.com/components/card-cn#card-demo-meta</a> 右侧内容区域，带页签的卡片：<a target="_blank" rel="noopener" href="https://ant-design.antgroup.com/components/card-cn#card-demo-tabs">https://ant-design.antgroup.com/components/card-cn#card-demo-tabs</a></p>
<p>3、封装日历组件</p>
<p><img src="https://pic.yupi.icu/1285/202409061424949.png" alt="img"></p>
<p>1）参考 React ECharts 的 <a target="_blank" rel="noopener" href="https://git.hust.cc/echarts-for-react/">官方文档</a> 来使用 ECharts 组件，把 Demo 代码复制到新建的组件文件中。</p>
<p>2）在用户中心页面中引入组件，便于查看效果：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{activeTabKey === <span class="string">"record"</span> &amp;&amp; <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">CalendarChart</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/&gt;</span></span>}</span><br></pre></td></tr></tbody></table></figure>

<p>3）定义签到日期数组变量，将数组转换为图表需要的数据。其中，对日期的处理需要用到 dayjs 库：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 签到日期列表（[1, 200]，表示第 1 和第 200 天有签到记录）</span></span><br><span class="line"><span class="keyword">const</span> [dataList, setDataList] = useState&lt;<span class="built_in">number</span>[]&gt;([]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算图表需要的数据</span></span><br><span class="line"><span class="keyword">const</span> year = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>();</span><br><span class="line"><span class="keyword">const</span> optionsData = dataList.<span class="title function_">map</span>(<span class="function">(<span class="params">dayOfYear, index</span>) =&gt;</span> {</span><br><span class="line">  <span class="comment">// 计算日期字符串</span></span><br><span class="line">  <span class="keyword">const</span> dateStr = <span class="title function_">dayjs</span>(<span class="string">`<span class="subst">${year}</span>-01-01`</span>)</span><br><span class="line">    .<span class="title function_">add</span>(dayOfYear - <span class="number">1</span>, <span class="string">"day"</span>)</span><br><span class="line">    .<span class="title function_">format</span>(<span class="string">"YYYY-MM-DD"</span>);</span><br><span class="line">  <span class="keyword">return</span> [dateStr, <span class="number">1</span>];</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>4）参考 Echarts 的官方 Demo 开发前端日历图：<a target="_blank" rel="noopener" href="https://echarts.apache.org/examples/zh/editor.html?c=calendar-simple">https://echarts.apache.org/examples/zh/editor.html?c=calendar-simple</a></p>
<p>先在 Demo 页面里调整好效果，得到 options 选项。</p>
<p>调整好的 options 如下：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图表配置</span></span><br><span class="line"><span class="keyword">const</span> options = {</span><br><span class="line">  <span class="attr">visualMap</span>: {</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">max</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">inRange</span>: {</span><br><span class="line">      <span class="comment">// 颜色从灰色到浅绿色</span></span><br><span class="line">      <span class="attr">color</span>: [<span class="string">"#efefef"</span>, <span class="string">"lightgreen"</span>],</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">calendar</span>: {</span><br><span class="line">    <span class="attr">range</span>: year,</span><br><span class="line">    <span class="attr">left</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="comment">// 单元格自动宽度，高度为 16 像素</span></span><br><span class="line">    <span class="attr">cellSize</span>: [<span class="string">'auto'</span>, <span class="number">16</span>],</span><br><span class="line">    <span class="attr">yearLabel</span>: {</span><br><span class="line">      <span class="attr">position</span>: <span class="string">"top"</span>,</span><br><span class="line">      <span class="attr">formatter</span>: <span class="string">`<span class="subst">${year}</span> 年刷题记录`</span>,</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">series</span>: {</span><br><span class="line">    <span class="attr">type</span>: <span class="string">"heatmap"</span>,</span><br><span class="line">    <span class="attr">coordinateSystem</span>: <span class="string">"calendar"</span>,</span><br><span class="line">    <span class="attr">data</span>: optionsData,</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>5）获取数据：前端调用 OpenAP| 生成新的刷题签到记录相关接口，调用并得到 dataList 即可。</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求后端获取数据</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fetchDataList</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getUserSignInRecordUsingGet</span>({</span><br><span class="line">      year,</span><br><span class="line">    });</span><br><span class="line">    <span class="title function_">setDataList</span>(res.<span class="property">data</span> || []);</span><br><span class="line">  } <span class="keyword">catch</span> (e) {</span><br><span class="line">    message.<span class="title function_">error</span>(<span class="string">"获取刷题签到记录失败，"</span> + e.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="title function_">fetchDataList</span>();</span><br><span class="line">}, []);</span><br></pre></td></tr></tbody></table></figure>

<p>4、执行签到</p>
<p>由于获取题目详情接口是在服务端渲染，拿不到用户登录态，所以建议在客户端额外发送请求来执行签到。</p>
<p>编写一个 hooks 钩子，便于在多个题目详情页中复用：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useEffect, useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> { message } <span class="keyword">from</span> <span class="string">"antd"</span>;</span><br><span class="line"><span class="keyword">import</span> { addUserSignInUsingPost } <span class="keyword">from</span> <span class="string">"@/api/userController"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加用户签到记录钩子</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useAddUserSignInRecord</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求后端执行签到</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">doFetch</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="title function_">setLoading</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">addUserSignInUsingPost</span>();</span><br><span class="line">    } <span class="keyword">catch</span> (e) {</span><br><span class="line">      message.<span class="title function_">error</span>(<span class="string">"添加刷题签到记录失败，"</span> + e.<span class="property">message</span>);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">      <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="title function_">doFetch</span>();</span><br><span class="line">  }, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> { loading };</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useAddUserSignInRecord;</span><br></pre></td></tr></tbody></table></figure>

<p>注意，该钩子需要在客户端组件中执行，因为用到了 useEffect 防止重复请求、并且还需要获取到用户登录态。</p>
<p>可以在题目详情卡片 QuestionCard 这一客户端组件里使用钩子，这样所有题目详情页都会触发签到。代码如下：</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">QuestionCard</span> = (<span class="params">props: Props</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { question } = props;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 签到</span></span><br><span class="line">  <span class="title function_">useAddUserSignInRecord</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>前端拓展</strong></p>
<p>1)用户中心是否需要实现服务端渲染?如何实现服务端渲染?思路:先通过 userld 获取基础信息(未登录也可获取)，再到客户端携带 Cookie 获取登录用户可见的信息。</p>
<p>2)用户中心页面添加权限校验 思路:可以通过 menu 菜单项配置，利用全局权限校验实现仅登录用户可见。</p>
<p>3)优化:如果前端签到成功，可以保存到LocalStorage 等位置，防止每次刷题都重复发送签到请求。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>1、过期时间</p>
<p>问:Redis 中的 Bitmap 如何设置过期时间?需要设置一年的过期时间吗?答:如果用户有看往年记录的需求，可以用单次任务(或定时任务)将往年 Redis 数据落库，确保入库成功后，清理Redis 即可。</p>
<p>比如 2025 年1月1号，就可以将 2024 年的签到记录入库了。 除非是非常重要的数据，否则最好还是设置下过期时间，一年多即可。</p>
<p>再问:Bitmap 一年落库一次吗?不怕数据丢失吗?</p>
<p>答:Redis 本身有持久化机制，虽然无法完全保证数据不丢失，但是至少数据不会全部丢失。根据我们的刷题逻辑，即使Redis 意外宕机，丢失前几秒的部分签到，但是用户当天刷题后又会补回来。</p>
<p>如果想保证数据完全不丢失，那么需要在获取题目详情的时候，同步将刷题记录落库，这样性能相对而言就比较差，在一些重要的数据场景需要这样设计。或者再加一个消息队列来提高性能，但架构复杂度和系统维护成本就更高了。</p>
<p>2、更详细的刷题记录</p>
<p><img src="https://pic.yupi.icu/1285/202409061424521.png" alt="img"></p>
<h2 id="分词题目搜索"><a href="#分词题目搜索" class="headerlink" title="分词题目搜索"></a>分词题目搜索</h2><p><strong>方案设计</strong></p>
<p>使用 Elasticsearch 实现题目数据的存储和分词搜索，需要将数据库的数据同步到 Elasticsearch。</p>
<p>1、什么是 ES</p>
<p>Elasticsearch 生态系统非常丰富，包含了一系列工具和功能，帮助用户处理、分析和可视化数据，Elastic Stack 是其核心组成部分。</p>
<p>2、ES 生态</p>
<p>Elasticsearch 生态系统非常丰富，包含了一系列工具和功能，帮助用户处理、分析和可视化数据，Elastic Stack 是其核心组成部分。</p>
<p>Elastic Stack（也称为 ELK Stack）由以下几部分组成：</p>
<ul>
<li>Elasticsearch：核心搜索引擎，负责存储、索引和搜索数据。</li>
<li>Kibana：可视化平台，用于查询、分析和展示 Elasticsearch 中的数据。</li>
<li>Logstash：数据处理管道，负责数据收集、过滤、增强和传输到 Elasticsearch。</li>
<li>Beats：轻量级的数据传输工具，收集和发送数据到 Logstash 或 Elasticsearch。</li>
</ul>
<p>Kibana 是 Elastic Stack 的可视化组件，允许用户通过图表、地图和仪表盘来展示存储在 Elasticsearch 中的数据。它提供了简单的查询接口、数据分析和实时监控功能。</p>
<p><img src="https://pic.yupi.icu/1285/202409061424297.png" alt="img"></p>
<p>Logstash 是一个强大的数据收集管道工具，能够从多个来源收集、过滤、转换数据，然后将数据发送到 Elasticsearch。Logstash 支持丰富的输入、过滤和输出插件。</p>
<p><img src="https://pic.yupi.icu/1285/202409061424329.png" alt="img"></p>
<p>Beats 是一组轻量级的数据采集代理，负责从不同来源收集数据并发送到 Elasticsearch 或 Logstash。常见的 Beats 包括：</p>
<ul>
<li>Filebeat：收集日志文件。</li>
<li>Metricbeat：收集系统和服务的指标。</li>
<li>Packetbeat：监控网络流量。</li>
</ul>
<p><img src="https://pic.yupi.icu/1285/202409061424343.png" alt="img"></p>
<p>3、Elasticsearch 的核心概念</p>
<p>索引（Index）：类似于关系型数据库中的表，索引是数据存储和搜索的 <strong>基本单位</strong>。每个索引可以存储多条文档数据。</p>
<p>文档（Document）：索引中的每条记录，类似于数据库中的行。文档以 JSON 格式存储。</p>
<p>字段（Field）：文档中的每个键值对，类似于数据库中的列。</p>
<p>映射（Mapping）：用于定义 Elasticsearch 索引中文档字段的数据类型及其处理方式，类似于关系型数据库中的 Schema 表结构，帮助控制字段的存储、索引和查询行为。</p>
<p>集群（Cluster）：多个节点组成的群集，用于存储数据并提供搜索功能。集群中的每个节点都可以处理数据。</p>
<p>分片（Shard）：为了实现横向扩展，ES 将索引拆分成多个分片，每个分片可以分布在不同节点上。</p>
<p>副本（Replica）：分片的复制品，用于提高可用性和容错性。</p>
<p><strong>和数据库类比：</strong></p>
<table>
<thead>
<tr>
<th><strong>Elasticsearch 概念</strong></th>
<th><strong>关系型数据库类比</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Index</td>
<td>Table</td>
</tr>
<tr>
<td>Document</td>
<td>Row</td>
</tr>
<tr>
<td>Field</td>
<td>Column</td>
</tr>
<tr>
<td>Mapping</td>
<td>Schema</td>
</tr>
<tr>
<td>Shard</td>
<td>Partition</td>
</tr>
<tr>
<td>Replica</td>
<td>Backup</td>
</tr>
</tbody></table>
<p>4、Elasticsearch 实现全文检索的原理</p>
<p>1）分词：Elasticsearch 的分词器会将输入文本拆解成独立的词条（tokens），方便进行索引和搜索。分词的具体过程包括以下几步：</p>
<ul>
<li>字符过滤：去除特殊字符、HTML 标签或进行其他文本清理。</li>
<li>分词：根据指定的分词器（analyzer），将文本按规则拆分成一个个词条。例如，英文可以按空格拆分，中文使用专门的分词器处理。</li>
<li>词汇过滤：对分词结果进行过滤，如去掉停用词（常见但无意义的词，如 “the”、”is” 等）或进行词形归并（如将动词变为原形）。</li>
</ul>
<p>Elasticsearch 内置了很多分词器，比如按照空格分词等，默认只支持英文，可以在 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/analysis-analyzers.html">官方文档</a> 了解。</p>
<p>2）倒排索引：</p>
<p>倒排索引是 Elasticsearch 实现高效搜索的核心数据结构。它将文档中的词条映射到文档 ID，实现快速查找。</p>
<p>工作原理：</p>
<ul>
<li>每个文档在被索引时，分词器会将文档内容拆解为多个词条。</li>
<li>然后，Elasticsearch 为每个词条生成一个倒排索引，记录该词条在哪些文档中出现。</li>
</ul>
<p>举个例子，假设有两个文档：</p>
<ul>
<li>文档 1：鱼皮是帅锅</li>
<li>文档 2：鱼皮是好人</li>
</ul>
<p>中文分词后，生成的倒排索引大致如下：</p>
<table>
<thead>
<tr>
<th>词条</th>
<th>文档 ID</th>
</tr>
</thead>
<tbody><tr>
<td>鱼皮</td>
<td>1, 2</td>
</tr>
<tr>
<td>是</td>
<td>1, 2</td>
</tr>
<tr>
<td>帅锅</td>
<td>1</td>
</tr>
<tr>
<td>好人</td>
<td>2</td>
</tr>
</tbody></table>
<p>通过这种结构，查询某个词时，可以快速找到包含该词的所有文档。</p>
<p>5、Elasticsearch 打分规则</p>
<p>实际应用 Elasticsearch 来实现搜索功能时，我们不仅要求能搜到内容，而且还要把和用户搜索最相关的内容展示在前面。这就需要我们了解 Elasticsearch 的打分规则。</p>
<p>打分规则（<em>Score）是用于衡量每个文档与查询条件的匹配度的评分机制。搜索结果的默认排序方式是按相关性得分（</em>score）从高到低。Elasticsearch 使用 <strong>BM25 算法</strong> 来计算每个文档的得分，它是基于词频、反向文档频率、文档长度等因素来评估文档和查询的相关性。</p>
<p>打分的主要因素：</p>
<ol>
<li>词频（TF, Term Frequency）：查询词在文档中出现的次数，出现次数越多，得分越高。</li>
<li>反向文档频率（IDF, Inverse Document Frequency）：查询词在所有文档中出现的频率。词在越少的文档中出现，IDF 值越高，得分越高。</li>
<li>文档长度：较短的文档往往被认为更相关，因为查询词在短文档中占的比例更大。</li>
</ol>
<p>下面举一个例子：假设要在 Elasticsearch 中查询 <code>鱼皮</code> 这个关键词，索引中有以下三个文档：</p>
<p>文档 1：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plain</span><br><span class="line"></span><br><span class="line">复制代码鱼皮是个帅小伙，鱼皮非常聪明，鱼皮很喜欢编程。</span><br></pre></td></tr></tbody></table></figure>

<p>分析：</p>
<ul>
<li>查询词 <code>鱼皮</code> 出现了 3 次。</li>
<li>该文档较短，查询词 <code>鱼皮</code> 的密度很高。</li>
</ul>
<p>由于 <code>鱼皮</code> 在文档中多次出现且文档较短，因此得分较高，相关性较强。</p>
<p>文档 2：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plain</span><br><span class="line"></span><br><span class="line">复制代码鱼皮是个帅小伙。</span><br></pre></td></tr></tbody></table></figure>

<p>分析：</p>
<ul>
<li>查询词 <code>鱼皮</code> 出现了 1 次。</li>
<li>文档非常短</li>
</ul>
<p>尽管文档短，但是查询词出现的次数少，因此得分中等，相关性较普通。</p>
<p>文档 3：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plain</span><br><span class="line"></span><br><span class="line">复制代码鱼皮是个帅小伙，他喜欢写代码。他的朋友们也很喜欢编程和技术讨论，大家经常一起参与各种技术会议，讨论分布式系统、机器学习和人工智能等主题。</span><br></pre></td></tr></tbody></table></figure>

<p>分析：</p>
<ul>
<li>查询词 <code>鱼皮</code> 出现了 1 次。</li>
<li>文档较长，且 <code>鱼皮</code> 只在文档开头出现，词条密度较低。</li>
</ul>
<p>由于文档很长，<code>鱼皮</code> 出现的次数少，密度也低，因此得分较低，相关性不强。</p>
<p>再举个例子，什么是反向文档频率？</p>
<p>假如说 ES 中有 10 个文档，都包含了“鱼皮”这个关键词；只有 1 个文档包含了“帅锅”这个关键词。</p>
<p>现在用户搜索“鱼皮帅锅”，大概率会把后面这条文档搜出来，因为更稀有。</p>
<p>当然，以上只是简单举例，实际上 ES 计算打分规则时，会有一套较为复杂的公式，感兴趣的同学可以阅读下面资料来了解：</p>
<ul>
<li>鱼皮文章：<a target="_blank" rel="noopener" href="https://liyupi.blog.csdn.net/article/details/119176943">https://liyupi.blog.csdn.net/article/details/119176943</a></li>
<li>官方文章：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html">https://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html</a></li>
</ul>
<p>6、Elasticsearch 查询语法</p>
<p>Elasticsearch 支持多种查询语法，用于不同的场景和需求，主要包括查询 DSL、EQL、SQL 等。</p>
<p>*<em>1）DSL 查询（*</em>*<em>Domain Specific Language*</em>*<em>）</em>*</p>
<p>一种基于 JSON 的查询语言，它是 Elasticsearch 中最常用的查询方式。</p>
<p>示例：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">json复制代码<span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"message"</span><span class="punctuation">:</span> <span class="string">"Elasticsearch 是强大的"</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个查询会对 <code>message</code> 字段进行分词，并查找包含 “Elasticsearch” 和 “强大” 词条的文档。</p>
<p><strong>2）EQL</strong></p>
<p>EQL 全称 Event Query Language，是一种用于检测和检索时间序列 <strong>事件</strong> 的查询语言，常用于日志和安全监控场景。</p>
<p>示例：查找特定事件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plain</span><br><span class="line"></span><br><span class="line">复制代码process where process.name == "malware.exe"</span><br></pre></td></tr></tbody></table></figure>

<p>这个查询会查找 <code>process.name</code> 为 “malware.exe” 的所有进程事件，常用于安全检测中的恶意软件分析。</p>
<p><strong>3）SQL 查询</strong></p>
<p>Elasticsearch 提供了类似于传统数据库的 SQL 查询语法，允许用户以 SQL 的形式查询 Elasticsearch 中的数据，对熟悉 SQL 的用户来说非常方便。</p>
<p>示例 SQL 查询：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sql</span></span><br><span class="line"></span><br><span class="line">复制代码<span class="keyword">SELECT</span> name, age <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">30</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个查询会返回 <code>users</code> 索引中 <code>age</code> 大于 30 的所有用户，并按年龄降序排序。</p>
<p>以下几种简单了解即可：</p>
<p><strong>4）Lucene 查询语法</strong></p>
<p>Lucene 是 Elasticsearch 底层的搜索引擎，Elasticsearch 支持直接使用 Lucene 的查询语法，适合简单的字符串查询。</p>
<p>示例 Lucene 查询：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plain</span><br><span class="line"></span><br><span class="line">复制代码name:Elasticsearch AND age:[30 TO 40]</span><br></pre></td></tr></tbody></table></figure>

<p>这个查询会查找 <code>name</code> 字段为 “Elasticsearch” 且 <code>age</code> 在 30 到 40 之间的文档。</p>
<p><strong>5）Kuery（KQL: Kibana Query Language）</strong></p>
<p>KQL 是 Kibana 的查询语言，专门用于在 Kibana 界面上执行搜索查询，常用于仪表盘和数据探索中。</p>
<p>示例 KQL 查询：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plain</span><br><span class="line"></span><br><span class="line">复制代码name: "Elasticsearch" and age &gt; 30</span><br></pre></td></tr></tbody></table></figure>

<p>这个查询会查找 <code>name</code> 为 “Elasticsearch” 且 <code>age</code> 大于 30 的文档。</p>
<p><strong>6）Painless 脚本查询</strong></p>
<p>Painless 是 Elasticsearch 的内置脚本语言，用于执行自定义的脚本操作，常用于排序、聚合或复杂计算场景。</p>
<p>示例 Painless 脚本：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">json复制代码<span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"script_score"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"match"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"message"</span><span class="punctuation">:</span> <span class="string">"Elasticsearch"</span> <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"script"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"source"</span><span class="punctuation">:</span> <span class="string">"doc['popularity'].value * 2"</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个查询会基于 <code>popularity</code> 字段的值进行动态评分，将其乘以 2。</p>
<p>总结一下，DSL 是最通用的，EQL 和 KQL 则适用于特定场景，如日志分析和 Kibana 查询，而 SQL 则便于数据库开发人员上手。</p>
<p>7、Elasticsearch 查询条件</p>
<p>如何利用 Elasticsearch 实现数据筛选呢？需要了解其查询条件，以 ES 的 DSL 语法为例：</p>
<table>
<thead>
<tr>
<th><strong>查询条件</strong></th>
<th><strong>介绍</strong></th>
<th><strong>示例</strong></th>
<th><strong>用途</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>match</code></td>
<td>用于全文检索，将查询字符串进行分词并匹配文档中对应的字段。</td>
<td><code>{ "match": { "content": "鱼皮是帅小伙" } }</code></td>
<td>适用于全文检索，分词后匹配文档内容。</td>
</tr>
<tr>
<td><code>term</code></td>
<td>精确匹配查询，不进行分词。通常用于结构化数据的精确匹配，如数字、日期、关键词等。</td>
<td><code>{ "term": { "status": "active" } }</code></td>
<td>适用于字段的精确匹配，如状态、ID、布尔值等。</td>
</tr>
<tr>
<td><code>terms</code></td>
<td>匹配多个值中的任意一个，相当于多个 <code>term</code> 查询的组合。</td>
<td><code>{ "terms": { "status": ["active", "pending"] } }</code></td>
<td>适用于多值匹配的场景。</td>
</tr>
<tr>
<td><code>range</code></td>
<td>范围查询，常用于数字、日期字段，支持大于、小于、区间等查询。</td>
<td><code>{ "range": { "age": { "gte": 18, "lte": 30 } } }</code></td>
<td>适用于数值或日期的范围查询。</td>
</tr>
<tr>
<td><code>bool</code></td>
<td>组合查询，通过 <code>must</code>、<code>should</code>、<code>must_not</code> 等组合多个查询条件。</td>
<td><code>{ "bool": { "must": [ { "term": { "status": "active" } }, { "range": { "age": { "gte": 18 } } } ] } }</code></td>
<td>适用于复杂的多条件查询，可以灵活组合。</td>
</tr>
<tr>
<td><code>wildcard</code></td>
<td>通配符查询，支持 <code>*</code> 和 <code>?</code>，前者匹配任意字符，后者匹配单个字符。</td>
<td><code>{ "wildcard": { "name": "鱼*" } }</code></td>
<td>适用于部分匹配的查询，如模糊搜索。</td>
</tr>
<tr>
<td><code>prefix</code></td>
<td>前缀查询，匹配以指定前缀开头的字段内容。</td>
<td><code>{ "prefix": { "name": "鱼" } }</code></td>
<td>适用于查找以指定字符串开头的内容。</td>
</tr>
<tr>
<td><code>fuzzy</code></td>
<td>模糊查询，允许指定程度的拼写错误或字符替换。</td>
<td><code>{ "fuzzy": { "name": "yupi~2" } }</code></td>
<td>适用于处理拼写错误或不完全匹配的查询。</td>
</tr>
<tr>
<td><code>exists</code></td>
<td>查询某字段是否存在。</td>
<td><code>{ "exists": { "field": "name" } }</code></td>
<td>适用于查找字段存在或缺失的文档。</td>
</tr>
<tr>
<td><code>match_phrase</code></td>
<td>短语匹配查询，要求查询的词语按顺序完全匹配。</td>
<td><code>{ "match_phrase": { "content": "鱼皮 帅小伙" } }</code></td>
<td>适用于严格的短语匹配，词语顺序和距离都严格控制。</td>
</tr>
<tr>
<td><code>match_all</code></td>
<td>匹配所有文档。</td>
<td><code>{ "match_all": {} }</code></td>
<td>适用于查询所有文档，通常与分页配合使用。</td>
</tr>
<tr>
<td><code>ids</code></td>
<td>基于文档 ID 查询，支持查询特定 ID 的文档。</td>
<td><code>{ "ids": { "values": ["1", "2", "3"] } }</code></td>
<td>适用于根据文档 ID 查找特定文档。</td>
</tr>
<tr>
<td><code>geo_distance</code></td>
<td>地理位置查询，基于地理坐标和指定距离查询。</td>
<td><code>{ "geo_distance": { "distance": "12km", "location": { "lat": 40.73, "lon": -74.1 } } }</code></td>
<td>适用于根据距离计算查找地理位置附近的文档。</td>
</tr>
<tr>
<td><code>aggregations</code></td>
<td>聚合查询，用于统计、计算和分组查询，类似 SQL 中的 <code>GROUP BY</code>。</td>
<td><code>{ "aggs": { "age_stats": { "stats": { "field": "age" } } } }</code></td>
<td>适用于统计和分析数据，比如求和、平均值、最大值等。</td>
</tr>
</tbody></table>
<p>其中的几个关键：</p>
<ol>
<li>精确匹配 vs. 全文检索：<code>term</code> 是精确匹配，不分词；<code>match</code> 用于全文检索，会对查询词进行分词。</li>
<li>组合查询：<code>bool</code> 查询可以灵活组合多个条件，适用于复杂的查询需求。</li>
<li>模糊查询：<code>fuzzy</code> 和 <code>wildcard</code> 提供了灵活的模糊匹配方式，适用于拼写错误或不完全匹配的场景。</li>
</ol>
<p>了解上面这些一般就足够了，更多可以随用随查，参考 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html">官方文档</a> 。</p>
<p>8、Elasticsearch 客户端</p>
<p>前面了解了 Elasticsearch 的概念和查询语法，但是如何执行 Elasticsearch 操作呢？还需要了解下 ES 的客户端，列举一些常用的：</p>
<p>1）HTTP API：Elasticsearch 提供了 RESTful HTTP API，用户可以通过直接发送 HTTP 请求来执行索引、搜索和管理集群的操作。<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/rest-apis.html">官方文档</a></p>
<p>2）Kibana：Kibana 是 Elasticsearch 官方提供的可视化工具，用户可以通过 Kibana 控制台使用查询语法（如 DSL、KQL）来执行搜索、分析和数据可视化。</p>
<p>3）Java REST Client：Elasticsearch 官方提供的 Java 高级 REST 客户端库，用于 Java 程序中与 Elasticsearch 进行通信，支持索引、查询、集群管理等操作。<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/introduction.html">官方文档</a></p>
<p>4）Spring Data Elasticsearch：Spring 全家桶的一员，用于将 Elasticsearch 与 Spring 框架集成，通过简化的 Repository 方式进行索引、查询和数据管理操作。<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-elasticsearch">官方文档</a></p>
<p>5）Elasticsearch SQL CLI：命令行工具，允许通过类 SQL 语法直接在命令行中查询 Elasticsearch 数据，适用于熟悉 SQL 的用户。</p>
<p>此外，Elasticsearch 当然不只有 Java 的客户端，Python、PHP、Node.js、Go 的客户端都是支持的。</p>
<p>💡 在选择客户端时，要格外注意版本号！！！要跟 Elasticsearch 的版本保持兼容。</p>
<p>9、ES 数据同步方案</p>
<p>一般情况下，如果做查询搜索功能，使用 ES 来模糊搜索，但是数据是存放在数据库 MySQL 里的，所以说我们需要把 MySQL 中的数据和 ES 进行同步，保证数据一致（以 MySQL 为主）。</p>
<p>数据流向：MySQL =&gt; ES （单向）</p>
<p>数据同步一般有 2 个过程：全量同步（首次）+ 增量同步（新数据）</p>
<p>总共有 4 种主流方案：</p>
<p><strong>1）定时任务</strong></p>
<p>比如 1 分钟 1 次，找到 MySQL 中过去几分钟内（至少是定时周期的 2 倍）发生改变的数据，然后更新到 ES。</p>
<p>优点：</p>
<ul>
<li>简单易懂，开发、部署、维护相对容易。</li>
<li>占用资源少，不需要引入复杂的第三方中间件。</li>
<li>不用处理复杂的并发和实时性问题。</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>有时间差</strong>：无法做到实时同步，数据存在滞后。</li>
<li>数据频繁变化时，无法确保数据完全同步，容易出现错过更新的情况。</li>
<li>对大数据量的更新处理不够高效，可能会引入重复更新逻辑。</li>
</ul>
<p>应用场景：</p>
<ul>
<li>数据实时性要求不高：适合数据短时间内不同步不会带来重大影响的场景。</li>
<li>数据基本不发生修改：适合数据几乎不修改、修改不频繁的场景。</li>
<li>数据容忍丢失</li>
</ul>
<p><strong>2）双写</strong></p>
<p>写数据的时候，必须也去写 ES；更新删除数据库同理。</p>
<p>可以通过事务保证数据一致性，使用事务时，要先保证 MySQL 写成功，因为如果 ES 写入失败了，不会触发回滚，但是可以通过定时任务 + 日志 + 告警进行检测和修复（补偿）。</p>
<p>优点：</p>
<ul>
<li>方案简单易懂，业务逻辑直接控制数据同步。</li>
<li>可以利用事务部分保证 MySQL 和 ES 的数据一致性。</li>
<li>同步的时延较短，理论上可以接近实时更新 ES。</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>影响性能</strong>：每次写 MySQL 时，需要同时操作 ES，增加了业务写入延迟，影响性能。</li>
<li><strong>一致性问题</strong>：如果 ES 写入失败，MySQL 事务提交成功后，ES 可能会丢失数据；或者 ES 写入成功，MySQL 事务提交失败，ES 无法回滚。因此必须额外设计监控、补偿机制来检测同步失败的情况（如通过定时任务、日志和告警修复）。</li>
<li>代码复杂度增加，需要对每个写操作都进行双写处理。</li>
</ul>
<p>应用场景：</p>
<ul>
<li>实时性要求较高</li>
<li>业务写入频率较低：适合写操作不频繁的场景，这样对性能的影响较小。</li>
</ul>
<p><strong>3）用 Logstash 数据同步管道</strong></p>
<p>一般要配合 kafka 消息队列 + beats 采集器：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424396.png" alt="img"></p>
<p>优点：</p>
<ul>
<li><strong>配置驱动</strong>：基于配置文件，减少了手动编码，数据同步逻辑和业务代码解耦。</li>
<li><strong>扩展性好</strong>：可以灵活引入 Kafka 等消息队列实现异步数据同步，并可处理高吞吐量数据。</li>
<li>支持多种数据源：Logstash 支持丰富的数据源，方便扩展其他同步需求。</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>灵活性差</strong>：需要通过配置文件进行同步，复杂的业务逻辑可能难以在配置中实现，无法处理细粒度的定制化需求。</li>
<li>引入额外组件，维护成本高：通常需要引入 Kafka、Beats 等第三方组件，增加了系统的复杂性和运维成本。</li>
</ul>
<p>应用场景：</p>
<ul>
<li><strong>大数据同步</strong>：适合大规模、分布式数据同步场景。</li>
<li><strong>对实时性要求不高</strong>：适合数据流处理或延迟容忍较大的系统。</li>
<li>系统已有 Kafka 或类似的消息队列架构：如果系统中已经使用了 Kafka 等中间件，使用 Logstash 管道会变得很方便。</li>
</ul>
<p><strong>4）监听 MySQL Binlog</strong></p>
<p>有任何数据变更时都能够实时监听到，并且同步到 Elasticsearch。一般不需要自己监听，可以使用现成的技术，比如 <a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/">Canal</a> 。</p>
<p><img src="https://pic.yupi.icu/1285/202409061424844.png" alt="img"></p>
<p>💡 Canal 的核心原理：数据库每次修改时，会修改 binlog 文件，只要监听该文件的修改，就能第一时间得到消息并处理</p>
<p>优点：</p>
<ul>
<li><strong>实时性强</strong>：能够在 MySQL 数据发生变更的第一时间同步到 ES，做到真正的实时同步。</li>
<li>轻量级：Binlog 是数据库自带的日志功能，不需要修改核心业务代码，只需要新增监听逻辑。</li>
</ul>
<p>缺点：</p>
<ul>
<li>引入外部依赖：需要引入像 Canal 这样的中间件，增加了系统的复杂性和维护成本。</li>
<li>运维难度增加：需要确保 Canal 或者其他 Binlog 监听器的稳定运行，并且对 MySQL 的 Binlog 配置要求较高。</li>
<li>一致性问题：如果 Canal 服务出现问题或暂停，数据可能会滞后或丢失，必须设计补偿机制。</li>
</ul>
<p>应用场景：</p>
<ul>
<li><strong>实时同步要求高</strong>：适合需要实时数据同步的场景，通常用于高并发、高数据一致性要求的系统。</li>
<li><strong>数据频繁变化</strong>：适合数据变更频繁且需要高效增量同步的场景。</li>
</ul>
<p>最终方案：对于本项目，由于数据量不大，题目更新也不频繁，容忍丢失和不一致，所以选用方案一，实现成本最低。</p>
<h3 id="后端开发（ES-实战）"><a href="#后端开发（ES-实战）" class="headerlink" title="后端开发（ES 实战）"></a>后端开发（ES 实战）</h3><h4 id="1、Elasticsearch-搭建"><a href="#1、Elasticsearch-搭建" class="headerlink" title="1、Elasticsearch 搭建"></a>1、Elasticsearch 搭建</h4><p>目标：安装 Elasticsearch 和 Kibana，能够在 Kibana 查看到 Elasticsearch 存储的数据。</p>
<p>💡 也可以直接使用云 Elasticsearch 服务，省去自主搭建的时间，推荐使用 Serverless 版本，学完关掉就行。</p>
<p><strong>Elasticsearch 更新迭代非常快，所以安装时，一定要注意慎重选择版本号！</strong></p>
<p>由于我们自己的项目用的 Spring Boot 2.7.6 版本，对应的 <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-elasticsearch">Spring Data Elasticsearch</a> 客户端版本是 4.x，支持的 Elasticsearch 是 7.x，所以建议 Elasticsearch 使用 7.x 的版本。</p>
<p>安装版本为 7.17.24</p>
<p>💡 可以在 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/reference/elasticsearch/versions.html">官方文档</a> 了解到版本兼容情况：比如 Spring 6 才支持 Elasticsearch 8.x</p>
<h5 id="1）安装-Elasticsearch（9200-端口）"><a href="#1）安装-Elasticsearch（9200-端口）" class="headerlink" title="1）安装 Elasticsearch（9200 端口）"></a>1）安装 Elasticsearch（9200 端口）</h5><p>参考官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html</a></p>
<p>Windows 解压安装：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/zip-windows.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/zip-windows.html</a></p>
<p>其他操作系统安装：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/targz.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/targz.html</a></p>
<p>如果官网下不动，可以用鱼皮已经下载好的：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA">https://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA</a> ，提取码：c2sd</p>
<p><strong>注意，安装路径不要包含中文！</strong></p>
<p>安装完成后进入 es 目录并执行启动命令（或者进入 bin 目录点击运行 elasticsearch.bat 程序）：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\elasticsearch.bat</span><br></pre></td></tr></tbody></table></figure>

<p>可以用 CURL 测试是否启动成功：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制代码curl -X GET "localhost:9200/?pretty"</span><br></pre></td></tr></tbody></table></figure>



<h5 id="2）安装-Kibana（5601-端口）"><a href="#2）安装-Kibana（5601-端口）" class="headerlink" title="2）安装 Kibana（5601 端口）"></a>2）安装 Kibana（5601 端口）</h5><p><strong>注意，只要是同一套技术，所有版本必须一致！此处都用 7.17 版本！</strong></p>
<p>参考官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/7.17/introduction.html">https://www.elastic.co/guide/en/kibana/7.17/introduction.html</a></p>
<p>安装 Kibana：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/7.17/install.html">https://www.elastic.co/guide/en/kibana/7.17/install.html</a></p>
<p>安装完成后进入 kibana 目录并执行启动命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制代码.\bin\kibana.bat</span><br></pre></td></tr></tbody></table></figure>

<p>正常输出如图：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424995.png" alt="img"></p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost:5601/%EF%BC%8C%E5%8D%B3%E5%8F%AF%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8%E3%80%82">http://localhost:5601/，即可开始使用。</a></p>
<p><img src="https://pic.yupi.icu/1285/202409061424225.png" alt="img"></p>
<p><strong>配置中文界面</strong></p>
<p>但 kibana 默认是英文，不变阅读，可以修改 <code>config/kibana.yml</code> 中的国际化配置：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424257.png" alt="img"></p>
<p>然后重启 kibana 即可。</p>
<p><strong>注意，目前 Kibana 面板没有增加权限校验，所有人都能访问，所以请勿在线上直接部署！</strong></p>
<h5 id="3）测试"><a href="#3）测试" class="headerlink" title="3）测试"></a>3）测试</h5><p>尝试利用 Kibana 的开发工具来操作 Elasticsearch 的数据，比如查询：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424414.png" alt="img"></p>
<p>验证下分词器的效果，比如使用标准分词器：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"analyzer"</span><span class="punctuation">:</span> <span class="string">"standard"</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">"text"</span><span class="punctuation">:</span> <span class="string">"鱼皮是个帅小伙，非常喜欢编程"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>效果如图，英文被识别为了一个词，但中文未被识别：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424518.png" alt="img"></p>
<p>默认支持的分词器如下：</p>
<ul>
<li>standard：标准分词器。</li>
<li>simple：简单分词器。</li>
<li>whitespace：按空格分词。</li>
<li>stop：带停用词的分词器。</li>
<li>keyword：不分词，将整个字段作为一个词条。</li>
<li>pattern：基于正则表达式的分词器。</li>
<li>ngram 和 edge_ngram：n-gram 分词器。</li>
</ul>
<p>由于这些分词器都不支持中文，所以需要安装 IK 中文分词器，以满足我们的业务需要。</p>
<h5 id="4）安装-IK-中文分词器（ES-插件）"><a href="#4）安装-IK-中文分词器（ES-插件）" class="headerlink" title="4）安装 IK 中文分词器（ES 插件）"></a>4）安装 IK 中文分词器（ES 插件）</h5><p>开源地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>直接按照官方指引安装即可，注意下载和我们 Elasticsearch 一致的版本，可以在这里找到各版本的插件包：<a target="_blank" rel="noopener" href="https://release.infinilabs.com/analysis-ik/stable/">https://release.infinilabs.com/analysis-ik/stable/</a></p>
<p>在 ES 安装目录下执行：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\elasticsearch-plugin.bat install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-7.17.24.zip</span><br></pre></td></tr></tbody></table></figure>

<p>安装成功，需要重启 ES：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424525.png" alt="img"></p>
<p>IK 分词器插件为我们提供了两个分词器：<code>ik_smart</code> 和 <code>ik_max_word</code>。</p>
<ul>
<li>ik_smart <strong>是智能分词</strong>，尽量选择最像一个词的拆分方式，比如“好学生”会被识别为一个词</li>
<li>ik_max_word <strong>尽可能地分词</strong>，可以包括组合词，比如“好学生”会被识别为 3 个词：好学生、好学、学生</li>
</ul>
<p>测试一下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">{</span><br><span class="line">  "analyzer": "ik_smart", </span><br><span class="line">  "text": "鱼皮是好学生"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如图：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424557.png" alt="img"> <img src="https://pic.yupi.icu/1285/202409061424627.png" alt="img"></p>
<p>这两种分词器如何选用呢？其实可以结合：</p>
<ul>
<li><code>ik_smart</code>：适用于 <strong>搜索分词</strong>，即在查询时使用，保证性能的同时提供合理的分词精度。</li>
<li><code>ik_max_word</code>：适用于 <strong>底层索引分词</strong>，确保在建立索引时尽可能多地分词，提高查询时的匹配度和覆盖面。</li>
</ul>
<p>下面就来实战下 ES 索引的设计吧~</p>
<p>💡 思考：有些时候 IK 识别词汇不准，比如不认识“程序员鱼皮”，怎么样让 IK 按自己的规则分词？</p>
<p>解决方案：插件支持自定义词典。可以按照 <a target="_blank" rel="noopener" href="https://github.com/infinilabs/analysis-ik/tree/v7.17.18?tab=readme-ov-file#dictionary-configuration">官方文档</a> 配置。</p>
<h4 id="2、设计-ES-索引"><a href="#2、设计-ES-索引" class="headerlink" title="2、设计 ES 索引"></a>2、设计 ES 索引</h4><p>为了将 MySQL 题目表数据导入到 Elasticsearch 中并实现分词搜索，需要为 ES 索引定义 <code>mapping</code>。ES 的 <code>mapping</code> 用于定义字段的类型、分词器及其索引方式。</p>
<p>相当于数据库的建表，数据库建表时我们要考虑索引，同样 Elasticsearch 建立索引时，要考虑到字段选取、分词器、字段格式等问题。</p>
<p>基于我们数据库的表结构和需求，我们可以定义 title、content、answer 等字段使用分词搜索，同时为其他字段指定适当的类型。以下是本项目的 <code>mapping</code> 定义：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"mappings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"properties"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"title"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"analyzer"</span><span class="punctuation">:</span> <span class="string">"ik_max_word"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"search_analyzer"</span><span class="punctuation">:</span> <span class="string">"ik_smart"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"fields"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"keyword"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"keyword"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ignore_above"</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"content"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"analyzer"</span><span class="punctuation">:</span> <span class="string">"ik_max_word"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"search_analyzer"</span><span class="punctuation">:</span> <span class="string">"ik_smart"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"tags"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"keyword"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"answer"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"text"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"analyzer"</span><span class="punctuation">:</span> <span class="string">"ik_max_word"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"search_analyzer"</span><span class="punctuation">:</span> <span class="string">"ik_smart"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"userId"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"long"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"editTime"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"date"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"format"</span><span class="punctuation">:</span> <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"createTime"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"date"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"format"</span><span class="punctuation">:</span> <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"updateTime"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"date"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"format"</span><span class="punctuation">:</span> <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"isDelete"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"keyword"</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>为什么不显示指定 id 字段？</strong></p>
<p>在 Elasticsearch 中，每个文档都有一个唯一的 <code>_id</code> 字段来标识文档，该字段用于文档的主键索引和唯一标识。通常，开发者并不需要显式定义 <code>id</code> 字段，因为 Elasticsearch 会自动生成 <code>_id</code>，或者在插入数据时，你可以手动指定 <code>_id</code>。</p>
<p>由于 <code>_id</code> 是 Elasticsearch 内部的系统字段，它默认存在并作为主键使用，因此在 mappings 中通常不需要显式定义。如果你想让某个字段（如 userId 或其他唯一标识）作为 <code>_id</code>，可以在插入文档时指定该字段的值作为 <code>_id</code>。比如：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /index/_doc/&lt;custom_id&gt;</span><br><span class="line">{</span><br><span class="line">  <span class="string">"userId"</span>: 1001,</span><br><span class="line">  <span class="string">"title"</span>: <span class="string">"Example"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>日期字段为什么要格式化？</strong></p>
<p>日期字段的格式化（<code>format: "yyyy-MM-dd HH:mm:ss"</code>）有以下几个考虑：</p>
<ol>
<li>一致性：定义日期字段的格式可以确保所有插入的日期数据都是一致的，避免因不同的日期格式导致解析错误。例如，Elasticsearch 默认可以支持多种日期格式，但如果不定义明确的格式，可能会导致不一致的日期解析。</li>
<li>优化查询：格式化日期后，Elasticsearch 知道该如何存储和索引这些时间数据，从而可以高效地执行基于日期的范围查询、过滤和排序操作。明确的格式定义还可以帮助 Elasticsearch 进行更优化的存储和压缩。</li>
<li>避免歧义：没有明确格式的日期可能导致歧义，比如 <code>"2023-09-03"</code> 是日期，还是年份？加上时间部分（如 <code>"yyyy-MM-dd HH:mm:ss"</code>）可以更明确地表明时间的精度，便于进行更精确的查询。</li>
</ol>
<p><strong>tags 支持数组么？为什么</strong></p>
<p>在 Elasticsearch 中，所有的字段类型（包括 <code>keyword</code> 和 <code>text</code>）默认都支持数组。你可以直接插入一个包含多个值的数组，Elasticsearch 会自动将其视为多个值的集合。例如，以下文档中，tags 字段是一个数组：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"title"</span><span class="punctuation">:</span> <span class="string">"How to learn Elasticsearch"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"tags"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"Elasticsearch"</span><span class="punctuation">,</span> <span class="string">"Search"</span><span class="punctuation">,</span> <span class="string">"Database"</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>在查询时，Elasticsearch 会将数组中的每个值视为独立的 <code>keyword</code>，可以进行精确匹配。</p>
<h4 id="3、新建索引"><a href="#3、新建索引" class="headerlink" title="3、新建索引"></a>3、新建索引</h4><p>可以通过如下命令创建索引，在 Kibana 开发者工具中执行、或者用 CURL 调用 Elasticsearch 执行均可：可以通过如下命令创建索引，在 Kibana 开发者工具中执行、或者用 CURL 调用 Elasticsearch 执行均可：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /question_v1</span><br><span class="line">{</span><br><span class="line">  <span class="string">"mappings"</span>: {</span><br><span class="line">    <span class="string">"properties"</span>: {</span><br><span class="line">      ...</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>但是有一点要注意，推荐在创建索引时添加 alias（别名） ，因为它提供了灵活性和简化索引管理的能力。具体原因如下：</p>
<ol>
<li>零停机切换索引：在更新索引或重新索引数据时，你可以创建一个新索引并使用 alias 切换到新索引，而不需要修改客户端查询代码，避免停机或中断服务。</li>
<li>简化查询：通过 alias，可以使用一个统一的名称进行查询，而不需要记住具体的索引名称（尤其当索引有版本号或时间戳时）。</li>
<li>索引分组：alias 可以指向多个索引，方便对多个索引进行联合查询，例如用于跨时间段的日志查询或数据归档。</li>
</ol>
</blockquote>
<p>其中，第一个是重点，举个例子，在创建索引时添加 alias：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index_v1</span><br><span class="line">{</span><br><span class="line">  "aliases": {</span><br><span class="line">    "my_index": {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个 alias 可以在后续版本中指向新的索引（如 my_index_v2），无需更改查询逻辑，查询时仍然使用 my_index。</p>
<p><strong>所以，我们要执行的完整命令如下，可以放到后端项目目录中进行备份：</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">PUT /question_v1</span><br><span class="line">{</span><br><span class="line">  "aliases": {</span><br><span class="line">    "question": {}</span><br><span class="line">  },</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word",</span><br><span class="line">        "search_analyzer": "ik_smart",</span><br><span class="line">        "fields": {</span><br><span class="line">          "keyword": {</span><br><span class="line">            "type": "keyword",</span><br><span class="line">            "ignore_above": 256</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "content": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word",</span><br><span class="line">        "search_analyzer": "ik_smart"</span><br><span class="line">      },</span><br><span class="line">      "tags": {</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "answer": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word",</span><br><span class="line">        "search_analyzer": "ik_smart"</span><br><span class="line">      },</span><br><span class="line">      "userId": {</span><br><span class="line">        "type": "long"</span><br><span class="line">      },</span><br><span class="line">      "editTime": {</span><br><span class="line">        "type": "date",</span><br><span class="line">        "format": "yyyy-MM-dd HH:mm:ss"</span><br><span class="line">      },</span><br><span class="line">      "createTime": {</span><br><span class="line">        "type": "date",</span><br><span class="line">        "format": "yyyy-MM-dd HH:mm:ss"</span><br><span class="line">      },</span><br><span class="line">      "updateTime": {</span><br><span class="line">        "type": "date",</span><br><span class="line">        "format": "yyyy-MM-dd HH:mm:ss"</span><br><span class="line">      },</span><br><span class="line">      "isDelete": {</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>执行以上命令创建索引，创建成功的样子如下所示</strong>：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424000.png" alt="img"></p>
<h4 id="4、引入-ES-客户端"><a href="#4、引入-ES-客户端" class="headerlink" title="4、引入 ES 客户端"></a>4、引入 ES 客户端</h4><p>1）引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- elasticsearch--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>2）更改 yml 配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">uris:</span> <span class="string">http://localhost:9200</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></tbody></table></figure>

<p>3）使用 spring data es 提供的 Bean 即可操作 Bean，可以直接通过 @Resource 注解注入</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br></pre></td></tr></tbody></table></figure>

<p>4）编写一个单元测试文件，验证对于 Elasticsearch 的增删改查基本操作</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchRestTemplateTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INDEX_NAME</span> <span class="operator">=</span> <span class="string">"test_index"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index (Create) a document</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">indexDocument</span><span class="params">()</span> {</span><br><span class="line">        Map&lt;String, Object&gt; doc = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        doc.put(<span class="string">"title"</span>, <span class="string">"Elasticsearch Introduction"</span>);</span><br><span class="line">        doc.put(<span class="string">"content"</span>, <span class="string">"Learn Elasticsearch basics and advanced usage."</span>);</span><br><span class="line">        doc.put(<span class="string">"tags"</span>, <span class="string">"elasticsearch,search"</span>);</span><br><span class="line">        doc.put(<span class="string">"answer"</span>, <span class="string">"Yes"</span>);</span><br><span class="line">        doc.put(<span class="string">"userId"</span>, <span class="number">1L</span>);</span><br><span class="line">        doc.put(<span class="string">"editTime"</span>, <span class="string">"2023-09-01 10:00:00"</span>);</span><br><span class="line">        doc.put(<span class="string">"createTime"</span>, <span class="string">"2023-09-01 09:00:00"</span>);</span><br><span class="line">        doc.put(<span class="string">"updateTime"</span>, <span class="string">"2023-09-01 09:10:00"</span>);</span><br><span class="line">        doc.put(<span class="string">"isDelete"</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">IndexQuery</span> <span class="variable">indexQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexQueryBuilder</span>().withId(<span class="string">"1"</span>).withObject(doc).build();</span><br><span class="line">        <span class="type">String</span> <span class="variable">documentId</span> <span class="operator">=</span> elasticsearchRestTemplate.index(indexQuery, IndexCoordinates.of(INDEX_NAME));</span><br><span class="line"></span><br><span class="line">        assertThat(documentId).isNotNull();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get (Retrieve) a document by ID</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getDocument</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">documentId</span> <span class="operator">=</span> <span class="string">"1"</span>;  <span class="comment">// Replace with the actual ID of an indexed document</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; document = elasticsearchRestTemplate.get(documentId, Map.class, IndexCoordinates.of(INDEX_NAME));</span><br><span class="line"></span><br><span class="line">        assertThat(document).isNotNull();</span><br><span class="line">        assertThat(document.get(<span class="string">"title"</span>)).isEqualTo(<span class="string">"Elasticsearch Introduction"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update a document</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDocument</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">documentId</span> <span class="operator">=</span> <span class="string">"1"</span>;  <span class="comment">// Replace with the actual ID of an indexed document</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; updates = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        updates.put(<span class="string">"title"</span>, <span class="string">"Updated Elasticsearch Title"</span>);</span><br><span class="line">        updates.put(<span class="string">"updateTime"</span>, <span class="string">"2023-09-01 10:30:00"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">UpdateQuery</span> <span class="variable">updateQuery</span> <span class="operator">=</span> UpdateQuery.builder(documentId)</span><br><span class="line">                .withDocument(Document.from(updates))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        elasticsearchRestTemplate.update(updateQuery, IndexCoordinates.of(INDEX_NAME));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; updatedDocument = elasticsearchRestTemplate.get(documentId, Map.class, IndexCoordinates.of(INDEX_NAME));</span><br><span class="line">        assertThat(updatedDocument.get(<span class="string">"title"</span>)).isEqualTo(<span class="string">"Updated Elasticsearch Title"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete a document</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDocument</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">documentId</span> <span class="operator">=</span> <span class="string">"1"</span>;  <span class="comment">// Replace with the actual ID of an indexed document</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> elasticsearchRestTemplate.delete(documentId, IndexCoordinates.of(INDEX_NAME));</span><br><span class="line">        assertThat(result).isNotNull();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete the entire index</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteIndex</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">IndexOperations</span> <span class="variable">indexOps</span> <span class="operator">=</span> elasticsearchRestTemplate.indexOps(IndexCoordinates.of(INDEX_NAME));</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">deleted</span> <span class="operator">=</span> indexOps.delete();</span><br><span class="line">        assertThat(deleted).isTrue();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以用 kibana 开发者工具查看数据情况：</p>
<figure class="highlight txt"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查出的数据如下所示：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424095.png" alt="img"></p>
<p>几个注意事项：</p>
<ol>
<li>当你向一个不存在的索引中插入数据时，Elasticsearch 会根据文档内容自动推断字段类型，并为这些字段创建映射。这就是 ES 的 <strong>动态映射</strong>（Dynamic Mapping）功能。然而，这种自动生成的映射有一些局限性，可能导致字段类型不够规范。</li>
<li>ES 中，_开头的字段表示系统默认字段，比如 _id，如果系统不指定，会自动生成。但是不会在 _source 字段中补充 id 的值，所以建议大家手动指定，让数据更完整。</li>
<li>ES 插入和更新数据没有 MySQL 那么严格，尤其是在动态 Mapping 模式下，只要指定了相同的文档 id，ES 允许动态添加字段和更新文档。</li>
</ol>
<blockquote>
<p>ES 中下划线开头的代表是默认字段，凡是默认字段都不用明确指定。</p>
</blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 8,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 1,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 1.0,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "test_index",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 1.0,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "answer" : "Yes",</span><br><span class="line">          "createTime" : "2023-09-01 09:00:00",</span><br><span class="line">          "isDelete" : false,</span><br><span class="line">          "editTime" : "2023-09-01 10:00:00",</span><br><span class="line">          "updateTime" : "2023-09-01 10:30:00",</span><br><span class="line">          "title" : "Updated Elasticsearch Title",</span><br><span class="line">          "userId" : 1,</span><br><span class="line">          "content" : "Learn Elasticsearch basics and advanced usage.",</span><br><span class="line">          "tags" : "elasticsearch,search"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>source 代表是真正的数据，而 _id 代表文档的 id，我们最好在插入数据时指定真正数据的 id</p>
<p><strong>总结</strong></p>
<p>通过这个单元测试，我们也能基本了解 Spring Data Elasticsearch 操作 ES 的方法：</p>
<ol>
<li>构造一个 Query 对象，比如插入数据使用 IndexQuery，更新数据使用 UpdateQuery</li>
<li>调用 elasticsearchRestTemplate 的增删改查方法，传入 Query 对象和要操作的索引作为参数</li>
<li>对返回值进行处理</li>
</ol>
<p>实例代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; updates = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">updates.put(<span class="string">"title"</span>, <span class="string">"Updated Elasticsearch Title"</span>);</span><br><span class="line">updates.put(<span class="string">"updateTime"</span>, <span class="string">"2023-09-01 10:30:00"</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">UpdateQuery</span> <span class="variable">updateQuery</span> <span class="operator">=</span> UpdateQuery.builder(documentId)</span><br><span class="line">        .withDocument(Document.from(updates))</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">elasticsearchRestTemplate.update(updateQuery, IndexCoordinates.of(INDEX_NAME));</span><br><span class="line"></span><br><span class="line">Map&lt;String, Object&gt; updatedDocument = elasticsearchRestTemplate.get(documentId, Map.class, IndexCoordinates.of(INDEX_NAME));</span><br></pre></td></tr></tbody></table></figure>

<p>但是有个问题就是，上述代码都是用 Map 传递数据，不像在 MyBatis 中利用实例类传递参数。当然 Spring Data ES 也支持这种方法来传递参数</p>
<h4 id="5、编写-ES-Dao-层"><a href="#5、编写-ES-Dao-层" class="headerlink" title="5、编写 ES Dao 层"></a>5、编写 ES Dao 层</h4><p>1）在 <code>model.dto.question</code> 包中定义和 ES 对应的实体类：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = "question")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionEsDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATE_TIME_PATTERN</span> <span class="operator">=</span> <span class="string">"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String answer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; tags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建用户 id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Date, format = {}, pattern = DATE_TIME_PATTERN)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Date, format = {}, pattern = DATE_TIME_PATTERN)</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDelete;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象转包装类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> question</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> QuestionEsDTO <span class="title function_">objToDto</span><span class="params">(Question question)</span> {</span><br><span class="line">        <span class="keyword">if</span> (question == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">QuestionEsDTO</span> <span class="variable">questionEsDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuestionEsDTO</span>();</span><br><span class="line">        BeanUtils.copyProperties(question, questionEsDTO);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tagsStr</span> <span class="operator">=</span> question.getTags();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(tagsStr)) {</span><br><span class="line">            questionEsDTO.setTags(JSONUtil.toList(tagsStr, String.class));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> questionEsDTO;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 包装类转对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> questionEsDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Question <span class="title function_">dtoToObj</span><span class="params">(QuestionEsDTO questionEsDTO)</span> {</span><br><span class="line">        <span class="keyword">if</span> (questionEsDTO == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">Question</span> <span class="variable">question</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Question</span>();</span><br><span class="line">        BeanUtils.copyProperties(questionEsDTO, question);</span><br><span class="line">        List&lt;String&gt; tagList = questionEsDTO.getTags();</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(tagList)) {</span><br><span class="line">            question.setTags(JSONUtil.toJsonStr(tagList));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> question;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）定义 Dao 层</p>
<p>可以在 esdao 包中统一存放对 Elasticsearch 的操作，只需要继承 ElasticsearchRepository 类即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目 ES 操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">QuestionEsDao</span> </span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;QuestionEsDTO, Long&gt; {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>仔细了解后可以知道 ElasticsearchRepository 类为我们提供了大量现成的 CRUD 操作：</p>
<p><img src="https://pic.yupi.icu/1285/202409061424110.png" alt="img"></p>
<p>而且还支持根据方法名自动映射为查询操作，比如在 QuestionEsDao 中定义下列方法，就会自动根据 userId 查询数据。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户 id 查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;QuestionEsDTO&gt; <span class="title function_">findByUserId</span><span class="params">(Long userId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>编写一个测试类来验证下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QuestionEsDaoTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QuestionEsDao questionEsDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">findByUserId</span><span class="params">()</span> {</span><br><span class="line">        questionEsDao.findByUserId(<span class="number">1L</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>两种操作 ES 的方法，根据业务需求进行选择：</p>
<ul>
<li>第 1 种方式：Spring 默认给我们提供的操作 es 的客户端对象 ElasticsearchRestTemplate，也提供了增删改查，它的增删改查更灵活，<strong>适用于更复杂的操作</strong>，返回结果更完整，但需要自己解析。</li>
<li>第 2 种方式：ElasticsearchRepository&lt;Entity, IdType&gt;，默认提供了更简单易用的增删改查，返回结果也更直接。<strong>适用于可预期的、相对简单的操作</strong> 。</li>
</ul>
<h4 id="6、如何向-ES-写入全量数据"><a href="#6、如何向-ES-写入全量数据" class="headerlink" title="6、如何向 ES 写入全量数据"></a>6、如何向 ES 写入全量数据</h4><p>可以通过编写单次执行的任务，将 MySQL 中题目表的数据，全量写入到 Elasticsearch。</p>
<p>可以通过实现 CommandLineRunner 接口定义单次任务，也可以编写一个仅管理员可用的接口，根据需要选择就好。</p>
<p>在 <code>job/once</code> 目录下编写任务：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// todo 取消注释开启任务</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FullSyncQuestionToEs</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QuestionService questionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QuestionEsDao questionEsDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> {</span><br><span class="line">        <span class="comment">// 全量获取题目（数据量不大的情况下使用）</span></span><br><span class="line">        List&lt;Question&gt; questionList = questionService.list();</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(questionList)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 转为 ES 实体类</span></span><br><span class="line">        List&lt;QuestionEsDTO&gt; questionEsDTOList = questionList.stream()</span><br><span class="line">                .map(QuestionEsDTO::objToDto)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 分页批量插入到 ES</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> questionEsDTOList.size();</span><br><span class="line">        log.info(<span class="string">"FullSyncQuestionToEs start, total {}"</span>, total);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; total; i += pageSize) {</span><br><span class="line">            <span class="comment">// 注意同步的数据下标不能超过总数据量</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> Math.min(i + pageSize, total);</span><br><span class="line">            log.info(<span class="string">"sync from {} to {}"</span>, i, end);</span><br><span class="line">            questionEsDao.saveAll(questionEsDTOList.subList(i, end));</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"FullSyncQuestionToEs end, total {}"</span>, total);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>编写一个测试方法，将题目全量同步到 Es 中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fullSyncQuestionToEs</span><span class="params">()</span> {</span><br><span class="line">    fullSyncQuestionToEs.run();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>随后在 kibana 面板中查看所有数据，发现写入成功</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /question/_search</span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"match_all"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240915155537.png" alt="image-20240915155537307"></p>
<h4 id="7、开发-ES-搜索"><a href="#7、开发-ES-搜索" class="headerlink" title="7、开发 ES 搜索"></a>7、开发 ES 搜索</h4><p>1）QuestionService 新增查询接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Page&lt;Question&gt; <span class="title function_">searchFromEs</span><span class="params">(QuestionQueryRequest questionQueryRequest)</span> {</span><br><span class="line">    <span class="comment">// 获取参数</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> questionQueryRequest.getId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">notId</span> <span class="operator">=</span> questionQueryRequest.getNotId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">searchText</span> <span class="operator">=</span> questionQueryRequest.getSearchText();</span><br><span class="line">    List&lt;String&gt; tags = questionQueryRequest.getTags();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionQueryRequest.getQuestionBankId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> questionQueryRequest.getUserId();</span><br><span class="line">    <span class="comment">// 注意，ES 的起始页为 0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> questionQueryRequest.getCurrent() - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> questionQueryRequest.getPageSize();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sortField</span> <span class="operator">=</span> questionQueryRequest.getSortField();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sortOrder</span> <span class="operator">=</span> questionQueryRequest.getSortOrder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造查询条件</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">// 过滤</span></span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"isDelete"</span>, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="literal">null</span>) {</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"id"</span>, id));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (notId != <span class="literal">null</span>) {</span><br><span class="line">        boolQueryBuilder.mustNot(QueryBuilders.termQuery(<span class="string">"id"</span>, notId));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (userId != <span class="literal">null</span>) {</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"userId"</span>, userId));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (questionBankId != <span class="literal">null</span>) {</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"questionBankId"</span>, questionBankId));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 必须包含所有标签</span></span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isNotEmpty(tags)) {</span><br><span class="line">        <span class="keyword">for</span> (String tag : tags) {</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"tags"</span>, tag));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 按关键词检索</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(searchText)) {</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="string">"title"</span>, searchText));</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="string">"content"</span>, searchText));</span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="string">"answer"</span>, searchText));</span><br><span class="line">        boolQueryBuilder.minimumShouldMatch(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    SortBuilder&lt;?&gt; sortBuilder = SortBuilders.scoreSort();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(sortField)) {</span><br><span class="line">        sortBuilder = SortBuilders.fieldSort(sortField);</span><br><span class="line">        sortBuilder.order(CommonConstant.SORT_ORDER_ASC.equals(sortOrder) ? SortOrder.ASC : SortOrder.DESC);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 分页</span></span><br><span class="line">    <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(current, pageSize);</span><br><span class="line">    <span class="comment">// 构造查询</span></span><br><span class="line">    <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">            .withQuery(boolQueryBuilder)</span><br><span class="line">            .withPageable(pageRequest)</span><br><span class="line">            .withSorts(sortBuilder)</span><br><span class="line">            .build();</span><br><span class="line">    SearchHits&lt;QuestionEsDTO&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, QuestionEsDTO.class);</span><br><span class="line">    <span class="comment">// 复用 MySQL 的分页对象，封装返回结果</span></span><br><span class="line">    Page&lt;Question&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;();</span><br><span class="line">    page.setTotal(searchHits.getTotalHits());</span><br><span class="line">    List&lt;Question&gt; resourceList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (searchHits.hasSearchHits()) {</span><br><span class="line">        List&lt;SearchHit&lt;QuestionEsDTO&gt;&gt; searchHitList = searchHits.getSearchHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit&lt;QuestionEsDTO&gt; questionEsDTOSearchHit : searchHitList) {</span><br><span class="line">            resourceList.add(QuestionEsDTO.dtoToObj(questionEsDTOSearchHit.getContent()));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    page.setRecords(resourceList);</span><br><span class="line">    <span class="keyword">return</span> page;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>虽然看上去复杂，但不涉及什么逻辑，根据查询需求选择合适的搜索方法，不断构造搜索条件即可。</p>
<p>3）在 QuestionController 编写新的搜索接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping("/search/page/vo")</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Page&lt;QuestionVO&gt;&gt; <span class="title function_">searchQuestionVOByPage</span><span class="params">(<span class="meta">@RequestBody</span> QuestionQueryRequest questionQueryRequest,</span></span><br><span class="line"><span class="params">                                                     HttpServletRequest request)</span> {</span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> questionQueryRequest.getPageSize();</span><br><span class="line">    <span class="comment">// 限制爬虫</span></span><br><span class="line">    ThrowUtils.throwIf(size &gt; <span class="number">200</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    Page&lt;Question&gt; questionPage = questionService.searchFromEs(questionQueryRequest);</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="8、数据同步"><a href="#8、数据同步" class="headerlink" title="8、数据同步"></a>8、数据同步</h4><p>我们需要编写一个定时方法，每 5 分钟同步 MySQL 数据至 ES</p>
<p>因为 MyBatis-Plus 查询的数据是逻辑未被删除的数据，因此我们要查出所有数据并同步到 ES，因此需要再 QuestionMapper 重写一个查询所有题目的方法</p>
<p>1）编写查询所有题目的方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">QuestionMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Question&gt; {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select("select * from question where updateTime &gt;= #{minUpdateTime}")</span></span><br><span class="line">    List&lt;Question&gt; <span class="title function_">listAllQuestion</span><span class="params">(Date minUpdateTime)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）在 <code>/job/circle</code> 包下编写定时方法，保证每 5 分钟都会将题目数据同步到 ES</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IncSyncQuestionToEs</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QuestionMapper questionMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QuestionEsDao questionEsDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每分钟执行一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60 * 1000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 查询近 5 分钟内的数据</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">FIVE_MINUTES</span> <span class="operator">=</span> <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">fiveMinutesAgoDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() - FIVE_MINUTES);</span><br><span class="line">        List&lt;Question&gt; questionList = questionMapper.listQuestionWithDelete(fiveMinutesAgoDate);</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(questionList)) {</span><br><span class="line">            log.info(<span class="string">"no inc question"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        List&lt;QuestionEsDTO&gt; questionEsDTOList = questionList.stream()</span><br><span class="line">                .map(QuestionEsDTO::objToDto)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> questionEsDTOList.size();</span><br><span class="line">        log.info(<span class="string">"IncSyncQuestionToEs start, total {}"</span>, total);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; total; i += pageSize) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> Math.min(i + pageSize, total);</span><br><span class="line">            log.info(<span class="string">"sync from {} to {}"</span>, i, end);</span><br><span class="line">            questionEsDao.saveAll(questionEsDTOList.subList(i, end));</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"IncSyncQuestionToEs end, total {}"</span>, total);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="前端开发-1"><a href="#前端开发-1" class="headerlink" title="前端开发"></a>前端开发</h3><p>运行 openAPI 重新生成前端请求代码</p>
<p>更改题目列表和题目表格的查询题目接口</p>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">searchQuestionVoByPageUsingPost</span>({</span><br><span class="line">    searchText,</span><br><span class="line">    <span class="attr">pageSize</span>: pageSize,</span><br><span class="line">    <span class="attr">sortField</span>: <span class="string">'createTime'</span>,</span><br><span class="line">    <span class="attr">sortOrder</span>: <span class="string">'desc'</span>,</span><br><span class="line">});</span><br><span class="line">            <span class="keyword">const</span> {data, code} = <span class="keyword">await</span> <span class="title function_">searchQuestionVoByPageUsingPost</span>({</span><br><span class="line">                ...params,</span><br><span class="line">                sortField,</span><br><span class="line">                sortOrder,</span><br><span class="line">                ...filter,</span><br><span class="line">            } <span class="keyword">as</span> <span class="variable constant_">API</span>.<span class="property">QuestionQueryRequest</span>);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="拓展-1"><a href="#拓展-1" class="headerlink" title="拓展"></a>拓展</h3><h4 id="1、根据业务自定义-ES-词典，提高分词准确度"><a href="#1、根据业务自定义-ES-词典，提高分词准确度" class="headerlink" title="1、根据业务自定义 ES 词典，提高分词准确度"></a>1、根据业务自定义 ES 词典，提高分词准确度</h4><p>思路：可以参考 IK 分词插件的官方文档：<a target="_blank" rel="noopener" href="https://github.com/infinilabs/analysis-ik/tree/v7.17.18?tab=readme-ov-file#dictionary-configuration">https://github.com/infinilabs/analysis-ik/tree/v7.17.18?tab=readme-ov-file#dictionary-configuration</a></p>
<h4 id="2、使用-ES-查询时，关联获取题目的动态数据"><a href="#2、使用-ES-查询时，关联获取题目的动态数据" class="headerlink" title="2、使用 ES 查询时，关联获取题目的动态数据"></a>2、使用 ES 查询时，关联获取题目的动态数据</h4><p>思路：先查 ES，再从 DB 查询其他的数据</p>
<h4 id="3、ES-接口支持降级"><a href="#3、ES-接口支持降级" class="headerlink" title="3、ES 接口支持降级"></a>3、ES 接口支持降级</h4><p>需求：ES 挂了、或者未搭建 ES 环境时，照样能把项目跑起来。</p>
<p>思路：ES 如果查询报错，改为调用数据库查询；还可以根据 ES 客户端是否正确初始化来判断是否应该使用 ES。</p>
<h4 id="4、防止重复执行定时任务"><a href="#4、防止重复执行定时任务" class="headerlink" title="4、防止重复执行定时任务"></a>4、防止重复执行定时任务</h4><p>可以自定义实现一个分布式锁注解，以下仅供参考：</p>
<p>1）创建一个自定义注解 @DistributedLock</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DistributedLock {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁的名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">key</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 持锁时间，默认30秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">leaseTime</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 等待时间，默认10秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">waitTime</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间单位，默认为毫秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TimeUnit <span class="title function_">timeUnit</span><span class="params">()</span> <span class="keyword">default</span> java.util.concurrent.TimeUnit.MILLISECONDS;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）创建一个切面类，用来处理 @DistributedLock 注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockAspect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around("@annotation(distributedLock)")</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint, DistributedLock distributedLock)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> distributedLock.key();</span><br><span class="line">        <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> distributedLock.waitTime();</span><br><span class="line">        <span class="type">long</span> <span class="variable">leaseTime</span> <span class="operator">=</span> distributedLock.leaseTime();</span><br><span class="line">        <span class="type">TimeUnit</span> <span class="variable">timeUnit</span> <span class="operator">=</span> distributedLock.timeUnit();</span><br><span class="line"></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(lockKey);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">acquired</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 尝试获取锁</span></span><br><span class="line">            acquired = lock.tryLock(waitTime, leaseTime, timeUnit);</span><br><span class="line">            <span class="keyword">if</span> (acquired) {</span><br><span class="line">                <span class="comment">// 获取锁成功，执行目标方法</span></span><br><span class="line">                <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 获取锁失败，抛出异常或处理逻辑</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"Could not acquire lock: "</span> + lockKey);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(e);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span> (acquired) {</span><br><span class="line">                <span class="comment">// 释放锁</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3）在需要加锁的方法上使用 @DistributedLock 注解即可，例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@DistributedLock(key = "testLock", leaseTime = 20000, waitTime = 5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">    System.out.println(<span class="string">"print print"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<blockquote>
<p>面向管理的扩展功能</p>
<ul>
<li>题目批量管理：需求分析 + 方案设计 + 前后端开发 + 功能优化</li>
<li>自动缓存热门题库：需求分析 + 方案设计 + 开发实现</li>
</ul>
</blockquote>
<h2 id="题目批量管理"><a href="#题目批量管理" class="headerlink" title="题目批量管理"></a>题目批量管理</h2><p><strong>需求分析</strong></p>
<p>为了提高效率，管理员需要提供批量操作的功能，例如：</p>
<ul>
<li>【管理员】批量向题库添加题目</li>
<li>【管理员】批量从题库移除题目</li>
<li>【管理员】批量删除题目</li>
</ul>
<p><strong>前端设计</strong></p>
<p>如果界面允许用户选择多个题目/内容的话，就要传递多个 id 给后端</p>
<ol>
<li>批量想题库添加题目：在题目管理页面，选中多个题目后，将这些题目 id 和题库 id 传给后端，后端添加对应的题目题库关系</li>
<li>批量从题库移除题目：在题库管理页面，选中多个题目后，将这些题目 id 和题库 id 传给后端，后端删除对应的题目题库关系</li>
<li>批量删除题目，在题目管理页面，选中多条题目后，点击删除按钮，触发确认弹框，将题目 id 传给后端并执行删除</li>
</ol>
<p><strong>后端设计</strong></p>
<p>后端通过 <strong>循环</strong> 依次调用数据库完成操作。注意，由于是批量操作，需要使用事务，有任何失败都会抛出异常并回滚。</p>
<h3 id="基础后端开发"><a href="#基础后端开发" class="headerlink" title="基础后端开发"></a>基础后端开发</h3><p>1、批量向题库添加题目</p>
<p>添加前需要校验题目和题库是否存在</p>
<p>QuestionBankQuestionService.java：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchAddQuestionsToBank</span><span class="params">(List&lt;Long&gt; questionIdList, Long questionBankId, User loginUser)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"题目列表为空"</span>);</span><br><span class="line">    ThrowUtils.throwIf(questionBankId == <span class="literal">null</span> || questionBankId &lt;= <span class="number">0</span>, ErrorCode.PARAMS_ERROR, <span class="string">"题库非法"</span>);</span><br><span class="line">    ThrowUtils.throwIf(loginUser == <span class="literal">null</span>, ErrorCode.NOT_LOGIN_ERROR);</span><br><span class="line">    <span class="comment">// 检查题目 id 是否存在</span></span><br><span class="line">    List&lt;Question&gt; questionList = questionService.listByIds(questionIdList);</span><br><span class="line">    <span class="comment">// 合法的题目 id</span></span><br><span class="line">    List&lt;Long&gt; validQuestionIdList = questionList.stream()</span><br><span class="line">            .map(Question::getId)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"合法的题目列表为空"</span>);</span><br><span class="line">    <span class="comment">// 检查题库 id 是否存在</span></span><br><span class="line">    <span class="type">QuestionBank</span> <span class="variable">questionBank</span> <span class="operator">=</span> questionBankService.getById(questionBankId);</span><br><span class="line">    ThrowUtils.throwIf(questionBank == <span class="literal">null</span>, ErrorCode.NOT_FOUND_ERROR, <span class="string">"题库不存在"</span>);</span><br><span class="line">    <span class="comment">// 执行插入</span></span><br><span class="line">    <span class="keyword">for</span> (Long questionId : validQuestionIdList) {</span><br><span class="line">        <span class="type">QuestionBankQuestion</span> <span class="variable">questionBankQuestion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuestionBankQuestion</span>();</span><br><span class="line">        questionBankQuestion.setQuestionBankId(questionBankId);</span><br><span class="line">        questionBankQuestion.setQuestionId(questionId);</span><br><span class="line">        questionBankQuestion.setUserId(loginUser.getId());</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.save(questionBankQuestion);</span><br><span class="line">        <span class="keyword">if</span> (!result) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"向题库添加题目失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionBankQuestionBatchAddRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题库 id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long questionBankId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目 id 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; questionIdList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PostMapping("/add/batch")</span></span><br><span class="line"><span class="meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="title function_">batchAddQuestionsToBank</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> QuestionBankQuestionBatchAddRequest questionBankQuestionBatchAddRequest,</span></span><br><span class="line"><span class="params">        HttpServletRequest request</span></span><br><span class="line"><span class="params">)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(questionBankQuestionBatchAddRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    <span class="type">User</span> <span class="variable">loginUser</span> <span class="operator">=</span> userService.getLoginUser(request);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionBankQuestionBatchAddRequest.getQuestionBankId();</span><br><span class="line">    List&lt;Long&gt; questionIdList = questionBankQuestionBatchAddRequest.getQuestionIdList();</span><br><span class="line">    questionBankQuestionService.batchAddQuestionsToBank(questionIdList, questionBankId, loginUser);</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="literal">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>2、批量从题库移除题目</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchRemoveQuestionsFromBank</span><span class="params">(List&lt;Long&gt; questionIdList, Long questionBankId)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"题目列表为空"</span>);</span><br><span class="line">    ThrowUtils.throwIf(questionBankId == <span class="literal">null</span> || questionBankId &lt;= <span class="number">0</span>, ErrorCode.PARAMS_ERROR, <span class="string">"题库非法"</span>);</span><br><span class="line">    <span class="comment">// 执行删除关联</span></span><br><span class="line">    <span class="keyword">for</span> (Long questionId : questionIdList) {</span><br><span class="line">        <span class="comment">// 构造查询</span></span><br><span class="line">        LambdaQueryWrapper&lt;QuestionBankQuestion&gt; lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)</span><br><span class="line">                .eq(QuestionBankQuestion::getQuestionId, questionId)</span><br><span class="line">                .eq(QuestionBankQuestion::getQuestionBankId, questionBankId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.remove(lambdaQueryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (!result) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"从题库移除题目失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PostMapping("/add/batch")</span></span><br><span class="line"><span class="meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="title function_">batchAddQuestionsToBank</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> QuestionBankQuestionBatchAddRequest questionBankQuestionBatchAddRequest,</span></span><br><span class="line"><span class="params">        HttpServletRequest request</span></span><br><span class="line"><span class="params">)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(questionBankQuestionBatchAddRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    <span class="type">User</span> <span class="variable">loginUser</span> <span class="operator">=</span> userService.getLoginUser(request);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionBankQuestionBatchAddRequest.getQuestionBankId();</span><br><span class="line">    List&lt;Long&gt; questionIdList = questionBankQuestionBatchAddRequest.getQuestionIdList();</span><br><span class="line">    questionBankQuestionService.batchAddQuestionsToBank(questionIdList, questionBankId, loginUser);</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="literal">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionBankQuestionBatchAddRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题库 id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long questionBankId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目 id 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; questionIdList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: <span class="number">8080</span></span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /api</span><br><span class="line">    session:</span><br><span class="line">      cookie:</span><br><span class="line">        domain: hejiajun.icu</span><br><span class="line">        same-site: lax</span><br><span class="line">        secure: <span class="literal">false</span></span><br><span class="line"><span class="meta">@PostMapping("/remove/batch")</span></span><br><span class="line"><span class="meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="title function_">batchRemoveQuestionsFromBank</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> QuestionBankQuestionBatchRemoveRequest questionBankQuestionBatchRemoveRequest,</span></span><br><span class="line"><span class="params">        HttpServletRequest request</span></span><br><span class="line"><span class="params">)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(questionBankQuestionBatchRemoveRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionBankQuestionBatchRemoveRequest.getQuestionBankId();</span><br><span class="line">    List&lt;Long&gt; questionIdList = questionBankQuestionBatchRemoveRequest.getQuestionIdList();</span><br><span class="line">    questionBankQuestionService.batchRemoveQuestionsFromBank(questionIdList, questionBankId);</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="literal">true</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PostMapping("/remove/batch")</span></span><br><span class="line"><span class="meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="title function_">batchRemoveQuestionsFromBank</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> QuestionBankQuestionBatchRemoveRequest questionBankQuestionBatchRemoveRequest,</span></span><br><span class="line"><span class="params">        HttpServletRequest request</span></span><br><span class="line"><span class="params">)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(questionBankQuestionBatchRemoveRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionBankQuestionBatchRemoveRequest.getQuestionBankId();</span><br><span class="line">    List&lt;Long&gt; questionIdList = questionBankQuestionBatchRemoveRequest.getQuestionIdList();</span><br><span class="line">    questionBankQuestionService.batchRemoveQuestionsFromBank(questionIdList, questionBankId);</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="literal">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3、批量删除题目</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchDeleteQuestions</span><span class="params">(List&lt;Long&gt; questionIdList)</span> {</span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isEmpty(questionIdList)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.PARAMS_ERROR, <span class="string">"要删除的题目列表为空"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> (Long questionId : questionIdList) {</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.removeById(questionId);</span><br><span class="line">        <span class="keyword">if</span> (!result) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"删除题目失败"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 移除题目题库关系</span></span><br><span class="line">        LambdaQueryWrapper&lt;QuestionBankQuestion&gt; lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)</span><br><span class="line">                .eq(QuestionBankQuestion::getQuestionId, questionId);</span><br><span class="line">        result = questionBankQuestionService.remove(lambdaQueryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (!result) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"删除题目题库关联失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionBatchDeleteRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目 id 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; questionIdList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PostMapping("/delete/batch")</span></span><br><span class="line"><span class="meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="title function_">batchDeleteQuestions</span><span class="params">(<span class="meta">@RequestBody</span> QuestionBatchDeleteRequest questionBatchDeleteRequest,</span></span><br><span class="line"><span class="params">                                                  HttpServletRequest request)</span> {</span><br><span class="line">    ThrowUtils.throwIf(questionBatchDeleteRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    questionService.batchDeleteQuestions(questionBatchDeleteRequest.getQuestionIdList());</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="literal">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping("/remove/batch")</span></span><br><span class="line"><span class="meta">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;Boolean&gt; <span class="title function_">batchRemoveQuestionsFromBank</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> QuestionBankQuestionBatchRemoveRequest questionBankQuestionBatchRemoveRequest,</span></span><br><span class="line"><span class="params">        HttpServletRequest request</span></span><br><span class="line"><span class="params">)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(questionBankQuestionBatchRemoveRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionBankQuestionBatchRemoveRequest.getQuestionBankId();</span><br><span class="line">    List&lt;Long&gt; questionIdList = questionBankQuestionBatchRemoveRequest.getQuestionIdList();</span><br><span class="line">    questionBankQuestionService.batchRemoveQuestionsFromBank(questionIdList, questionBankId);</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="literal">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="前端开发-2"><a href="#前端开发-2" class="headerlink" title="前端开发"></a>前端开发</h3><p>主要是修改题目管理页面，增加批量操作能力。</p>
<p>1、批量操作</p>
<p>Ant Design ProComponents 的 ProTable 组件自带批量操作功能，可以参考 <a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/table?tab=api&amp;current=1&amp;pageSize=5#packages-table-src-components-table-tab-api-demo-batchoption">官方文档</a> 。</p>
<ol>
<li>给 ProTable 组件增加如下属性，要重点注意修改 ProTable 组件的 rowKey=”id”，作为多选行的唯一标识。</li>
<li>为什么我选了一行，表格中所有行都会被选中，那是因为选中某行是根据 rowKey 判断的，我们只需将 rowKey 改为 id 即可</li>
<li>对月某些比较危险的操作，我们可以添加弹出框来防止管理执行了不当操作，此时我们可以通过 ant design 的 popconfirm 组件实现，<a target="_blank" rel="noopener" href="https://ant-design.antgroup.com/components/popconfirm-cn">https://ant-design.antgroup.com/components/popconfirm-cn</a></li>
</ol>
<figure class="highlight tsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ProTable</span>&lt;<span class="variable constant_">API</span>.<span class="property">Question</span>&gt;</span><br><span class="line">  rowKey=<span class="string">"id"</span></span><br><span class="line">  rowSelection={{</span><br><span class="line">    <span class="comment">// 自定义选择项参考: https://ant.design/components/table-cn/#components-table-demo-row-selection-custom</span></span><br><span class="line">    <span class="comment">// 注释该行则默认不显示下拉选项</span></span><br><span class="line">    <span class="attr">selections</span>: [<span class="title class_">Table</span>.<span class="property">SELECTION_ALL</span>, <span class="title class_">Table</span>.<span class="property">SELECTION_INVERT</span>],</span><br><span class="line">  }}</span><br><span class="line">  tableAlertRender={<span class="function">(<span class="params">{</span></span></span><br><span class="line"><span class="params"><span class="function">    selectedRowKeys,</span></span></span><br><span class="line"><span class="params"><span class="function">    selectedRows,</span></span></span><br><span class="line"><span class="params"><span class="function">    onCleanSelected,</span></span></span><br><span class="line"><span class="params"><span class="function">  }</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">Space</span> <span class="attr">size</span>=<span class="string">{24}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          已选 {selectedRowKeys.length} 项</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">{{</span> <span class="attr">marginInlineStart:</span> <span class="attr">8</span> }} <span class="attr">onClick</span>=<span class="string">{onCleanSelected}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            取消选择</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Space</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  }}</span><br><span class="line">  tableAlertOptionRender={<span class="function">(<span class="params">{</span></span></span><br><span class="line"><span class="params"><span class="function">    selectedRowKeys,</span></span></span><br><span class="line"><span class="params"><span class="function">    selectedRows,</span></span></span><br><span class="line"><span class="params"><span class="function">    onCleanSelected,</span></span></span><br><span class="line"><span class="params"><span class="function">  }</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">Space</span> <span class="attr">size</span>=<span class="string">{16}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-xml">            // 打开弹窗</span></span><br><span class="line"><span class="language-xml">          }}</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          批量向题库添加题目</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-xml">            // 打开弹窗</span></span><br><span class="line"><span class="language-xml">          }}</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          批量从题库移除题目</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Popconfirm</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">title</span>=<span class="string">"确认删除"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">description</span>=<span class="string">"你确定要删除这些题目么？"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onConfirm</span>=<span class="string">{()</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-xml">            // 批量删除题目</span></span><br><span class="line"><span class="language-xml">          }}</span></span><br><span class="line"><span class="language-xml">          okText="Yes"</span></span><br><span class="line"><span class="language-xml">          cancelText="No"</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Button</span> <span class="attr">danger</span>&gt;</span>批量删除题目<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Popconfirm</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Space</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  }}</span><br><span class="line">/&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>此外，我们上述的代码还有一些其他的问题，比如：1608639807578177538_0.04534199560803276</p>
<ul>
<li>稳定性低，有一道题目报错，就全部出错了</li>
<li>性能较低，同时操作的题目较多时，执行时间会很长</li>
</ul>
<h2 id="批处理操作优化"><a href="#批处理操作优化" class="headerlink" title="批处理操作优化"></a>批处理操作优化</h2><p>一般情况下，我们可以从以下多个角度对批处理任务进行优化。</p>
<ul>
<li>健壮性</li>
<li>稳定性</li>
<li>性能</li>
<li>数据一致性</li>
<li>可观测性</li>
</ul>
<h3 id="健壮性"><a href="#健壮性" class="headerlink" title="健壮性"></a>健壮性</h3><p>健壮性是指系统在面对 <strong>异常情况或不合法输入</strong> 时仍能表现出合理的行为。一个健壮的系统能够 <strong>预见和处理异常</strong>，并且即使发生错误，也不会崩溃或产生不可预期的行为。</p>
<p>1、参数校验提前</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchAddQuestionsToBank</span><span class="params">(List&lt;Long&gt; questionIdList, Long questionBankId, User loginUser)</span> {</span><br><span class="line">        <span class="comment">// 参数校验</span></span><br><span class="line">        ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"题目列表为空"</span>);</span><br><span class="line">        ThrowUtils.throwIf(questionBankId == <span class="literal">null</span> || questionBankId &lt;= <span class="number">0</span>, ErrorCode.PARAMS_ERROR, <span class="string">"题库非法"</span>);</span><br><span class="line">        ThrowUtils.throwIf(loginUser == <span class="literal">null</span>, ErrorCode.NOT_LOGIN_ERROR);</span><br><span class="line">        <span class="comment">// 检查题目 id 是否存在</span></span><br><span class="line">        List&lt;Question&gt; questionList = questionService.listByIds(questionIdList);</span><br><span class="line">        <span class="comment">// 合法的题目 id</span></span><br><span class="line">        List&lt;Long&gt; validQuestionIdList = questionList.stream()</span><br><span class="line">                .map(Question::getId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"合法的题目列表为空"</span>);</span><br><span class="line">        <span class="comment">// 检查哪些题目还不存在于题库中，避免重复插入</span></span><br><span class="line">LambdaQueryWrapper&lt;QuestionBankQuestion&gt; lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)</span><br><span class="line">        .eq(QuestionBankQuestion::getQuestionBankId, questionBankId)</span><br><span class="line">        .in(QuestionBankQuestion::getQuestionId, validQuestionIdList);</span><br><span class="line">List&lt;QuestionBankQuestion&gt; existQuestionList = <span class="built_in">this</span>.list(lambdaQueryWrapper);</span><br><span class="line">        <span class="comment">// 已存在于题库中的题目 id</span></span><br><span class="line">Set&lt;Long&gt; existQuestionIdSet = existQuestionList.stream()</span><br><span class="line">        .map(QuestionBankQuestion::getId)</span><br><span class="line">        .collect(Collectors.toSet());</span><br><span class="line">        <span class="comment">// 已存在于题库中的题目 id，不需要再次添加</span></span><br><span class="line">validQuestionIdList = validQuestionIdList.stream().filter(questionId -&gt; {</span><br><span class="line">    <span class="keyword">return</span> !existQuestionIdSet.contains(questionId);</span><br><span class="line">}).collect(Collectors.toList());</span><br><span class="line">ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"所有题目都已存在于题库中"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查题库 id 是否存在</span></span><br><span class="line">        <span class="type">QuestionBank</span> <span class="variable">questionBank</span> <span class="operator">=</span> questionBankService.getById(questionBankId);</span><br><span class="line">        ThrowUtils.throwIf(questionBank == <span class="literal">null</span>, ErrorCode.NOT_FOUND_ERROR, <span class="string">"题库不存在"</span>);</span><br><span class="line">        <span class="comment">// 执行插入</span></span><br><span class="line">        <span class="keyword">for</span> (Long questionId : validQuestionIdList) {</span><br><span class="line">            <span class="type">QuestionBankQuestion</span> <span class="variable">questionBankQuestion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuestionBankQuestion</span>();</span><br><span class="line">            questionBankQuestion.setQuestionBankId(questionBankId);</span><br><span class="line">            questionBankQuestion.setQuestionId(questionId);</span><br><span class="line">            questionBankQuestion.setUserId(loginUser.getId());</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.save(questionBankQuestion);</span><br><span class="line">            <span class="keyword">if</span> (!result) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"向题库添加题目失败"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>2、异常处理</p>
<p>目前虽然已经对每一次插入操作的结果都进行了判断，并且抛出自定义异常，但是有些特殊的异常并没有被捕获。比如：</p>
<ul>
<li>数据唯一键重复插入问题，会抛出 <code>DataIntegrityViolationException</code>。</li>
<li>数据库连接问题、事务问题等导致操作失败时抛出 <code>DataAccessException</code>。</li>
<li>其他的异常可以通过日志记录详细错误信息，便于后期追踪（全局异常处理器也有这个能力）。</li>
</ul>
<h3 id="稳定性"><a href="#稳定性" class="headerlink" title="稳定性"></a>稳定性</h3><p>1、避免长事务问题</p>
<p>批量操作中，一次性处理过多数据会导致事务过长，影响数据库性能。可以通过 <strong>分批处理</strong> 来避免长事务问题，确保部分数据异常不会影响整个批次的数据保存。</p>
<p>假设操作 10w 条数据，其中有 1 条数据操作异常，如果是长事务，那么修改的 10w 条数据都需要回滚，而分批事务仅需回滚一批既可，降低长事务带来的资源消耗，同时也提升了稳定性。</p>
<p>编写一个新的方法，用于对某一批操作进行事务管理：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchAddQuestionsToBankInner</span><span class="params">(List&lt;QuestionBankQuestion&gt; questionBankQuestions)</span> {</span><br><span class="line">    <span class="keyword">for</span> (QuestionBankQuestion questionBankQuestion : questionBankQuestions) {</span><br><span class="line">        <span class="type">long</span> <span class="variable">questionId</span> <span class="operator">=</span> questionBankQuestion.getQuestionId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">questionBankId</span> <span class="operator">=</span> questionBankQuestion.getQuestionBankId();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.save(questionBankQuestion);</span><br><span class="line">            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, <span class="string">"向题库添加题目失败"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (DataIntegrityViolationException e) {</span><br><span class="line">            log.error(<span class="string">"数据库唯一键冲突或违反其他完整性约束，题目 id: {}, 题库 id: {}, 错误信息: {}"</span>,</span><br><span class="line">                    questionId, questionBankId, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"题目已存在于该题库，无法重复添加"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (DataAccessException e) {</span><br><span class="line">            log.error(<span class="string">"数据库连接问题、事务问题等导致操作失败，题目 id: {}, 题库 id: {}, 错误信息: {}"</span>,</span><br><span class="line">                    questionId, questionBankId, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"数据库操作失败"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="comment">// 捕获其他异常，做通用处理</span></span><br><span class="line">            log.error(<span class="string">"添加题目到题库时发生未知错误，题目 id: {}, 题库 id: {}, 错误信息: {}"</span>,</span><br><span class="line">                    questionId, questionBankId, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"向题库添加题目失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意：在 Spring 中调用标注有 @Transactional 方法是不能直接调用的，否则事务不会生效，因为 @Transactional 是基于代理实现的，因次我们调用这个方法需要通过代理类来调用</p>
<p><strong>那该如何开启代理并调用代理类？</strong></p>
<p>1）首先在 Spring Boot 启动类，加上一下注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)</span></span><br></pre></td></tr></tbody></table></figure>

<p>2）通过以下方法获取代理对象</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">QuestionBankQuestionServiceImpl</span> <span class="variable">questionBankQuestionService</span> <span class="operator">=</span> (QuestionBankQuestionServiceImpl) AopContext.currentProxy();</span><br></pre></td></tr></tbody></table></figure>

<p>3）通过代理对象调用批量插入题库的方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);</span><br></pre></td></tr></tbody></table></figure>

<p>完整代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchAddQuestionsToBank</span><span class="params">(List&lt;Long&gt; questionIdList, Long questionBankId, User loginUser)</span> {</span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    ThrowUtils.throwIf(CollUtil.isEmpty(questionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"题目列表为空"</span>);</span><br><span class="line">    ThrowUtils.throwIf(questionBankId == <span class="literal">null</span> || questionBankId &lt;= <span class="number">0</span>, ErrorCode.PARAMS_ERROR, <span class="string">"题库非法"</span>);</span><br><span class="line">    ThrowUtils.throwIf(loginUser == <span class="literal">null</span>, ErrorCode.NOT_LOGIN_ERROR);</span><br><span class="line">    <span class="comment">// 检查题目 id 是否存在</span></span><br><span class="line">    List&lt;Question&gt; questionList = questionService.listByIds(questionIdList);</span><br><span class="line">    <span class="comment">// 合法的题目 id</span></span><br><span class="line">    List&lt;Long&gt; validQuestionIdList = questionList.stream()</span><br><span class="line">            .map(Question::getId)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"合法的题目列表为空"</span>);</span><br><span class="line">    <span class="comment">// 检查哪些题目不存在于题库中，避免重复插入</span></span><br><span class="line">    LambdaQueryWrapper&lt;QuestionBankQuestion&gt; lambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)</span><br><span class="line">            .eq(QuestionBankQuestion::getQuestionId, questionBankId)</span><br><span class="line">            .notIn(QuestionBankQuestion::getQuestionId, validQuestionIdList);</span><br><span class="line">    List&lt;QuestionBankQuestion&gt; notExistQuestionList = <span class="built_in">this</span>.list(lambdaQueryWrapper);</span><br><span class="line">    validQuestionIdList = notExistQuestionList.stream().map(QuestionBankQuestion::getQuestionId).collect(Collectors.toList());</span><br><span class="line">    ThrowUtils.throwIf(CollUtil.isEmpty(validQuestionIdList), ErrorCode.PARAMS_ERROR, <span class="string">"所有题目都已存在于题库中"</span>);</span><br><span class="line">    <span class="comment">// 检查题库 id 是否存在</span></span><br><span class="line">    <span class="type">QuestionBank</span> <span class="variable">questionBank</span> <span class="operator">=</span> questionBankService.getById(questionBankId);</span><br><span class="line">    ThrowUtils.throwIf(questionBank == <span class="literal">null</span>, ErrorCode.NOT_FOUND_ERROR, <span class="string">"题库不存在"</span>);</span><br><span class="line">    <span class="comment">// 分批处理，避免长事务，假设每次处理 1000 条</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> validQuestionIdList.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; total; i += batchSize) {</span><br><span class="line">        <span class="comment">// 生成每批次的数据</span></span><br><span class="line">        List&lt;Long&gt; subQuestionList = validQuestionIdList.subList(i, Math.min(i + batchSize, total));</span><br><span class="line">        List&lt;QuestionBankQuestion&gt; questionBankQuestions = subQuestionList.stream().map(questionId -&gt; {</span><br><span class="line">            <span class="type">QuestionBankQuestion</span> <span class="variable">questionBankQuestion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuestionBankQuestion</span>();</span><br><span class="line">            questionBankQuestion.setQuestionBankId(questionBankId);</span><br><span class="line">            questionBankQuestion.setQuestionId(questionId);</span><br><span class="line">            questionBankQuestion.setUserId(loginUser.getId());</span><br><span class="line">            <span class="keyword">return</span> questionBankQuestion;</span><br><span class="line">        }).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 使用事务处理每批次数据</span></span><br><span class="line">        <span class="comment">// 获取代理对象</span></span><br><span class="line">        <span class="type">QuestionBankQuestionServiceImpl</span> <span class="variable">questionBankQuestionService</span> <span class="operator">=</span> (QuestionBankQuestionServiceImpl) AopContext.currentProxy();</span><br><span class="line">        questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<ol>
<li>无论接口方法是否加上 @Transactional 注解，只要实现类方法加上，事务都不会失效</li>
<li>在同一个对象中调用含有 @Transactional 注解的方法会导致事务失效，要通过代理对象调用</li>
</ol>
</blockquote>
<p>2、重试机制</p>
<p>由于网络不稳定等原因导致操作失败了，可以设计 <strong>重试机制</strong> 来保证系统的稳定性，适用于执行时间很长的操作</p>
<p>注意重试机制得有一个上限</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; retryCount; i++) {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 执行插入操作</span></span><br><span class="line">        <span class="comment">// 成功则跳出重试循环</span></span><br><span class="line">        <span class="keyword">break</span>; </span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        log.warn(<span class="string">"插入失败，重试次数: {}"</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (i == retryCount - <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"多次重试后操作仍然失败"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3、中断恢复</p>
<p>如果在批量插入过程中由于某种原因（如数据库宕机、服务器重启）导致批处理中断，建议设计一种机制来进行 <strong>增量恢复</strong>。比如可以为每次操作打上批次标记，在操作未完成时记录操作状态（如部分题目成功添加），并在恢复时继续执行未完成的操作。</p>
<p>可以设计一个数据库表存储批次的状态：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> question_batch_status (</span><br><span class="line">  batch_id <span class="type">bigint</span> <span class="keyword">primary</span> key,</span><br><span class="line">  question_bank_id <span class="type">bigint</span>,</span><br><span class="line">  total_questions <span class="type">int</span>,</span><br><span class="line">  processed_questions <span class="type">int</span>,</span><br><span class="line">  status <span class="type">varchar</span>(<span class="number">20</span>) <span class="comment">-- running, completed, failed</span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>

<p>通过该表可以跟踪每次批处理的进度，并在失败时根据批次继续处理。</p>
<p>但对于我们的题目管理功能，不用那么复杂，可以直接通过判断数据是否已经满足要求来对要新处理的数据进行过滤。比如添加题目到题库前，先查一下是否已经添加到题库里了，如果已添加就不用重复添加了。（前面 <code>参数校验提前</code> 就已经实现了这个功能）</p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p>1、批量操作</p>
<p>当前代码中，每个题目是单独插入数据库的，这会产生频繁的数据库交互。</p>
<p>大多数 ORM 框架和数据库驱动都支持批量插入，可以通过批量插入来优化性能，比如 MyBatis Plus 提供了 saveBatch 方法。</p>
<p>优化后的代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchAddQuestionsToBankInner</span><span class="params">(List&lt;QuestionBankQuestion&gt; questionBankQuestions)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.saveBatch(questionBankQuestions);</span><br><span class="line">            ThrowUtils.throwIf(!result, ErrorCode.OPERATION_ERROR, <span class="string">"向题库添加题目失败"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (DataIntegrityViolationException e) {</span><br><span class="line">            log.error(<span class="string">"数据库唯一键冲突或违反其他完整性约束, 错误信息: {}"</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"题目已存在于该题库，无法重复添加"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (DataAccessException e) {</span><br><span class="line">            log.error(<span class="string">"数据库连接问题、事务问题等导致操作失败 错误信息: {}"</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"数据库操作失败"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="comment">// 捕获其他异常，做通用处理</span></span><br><span class="line">            log.error(<span class="string">"添加题目到题库时发生未知错误， 错误信息: {}"</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.OPERATION_ERROR, <span class="string">"向题库添加题目失败"</span>);</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>批量操作的好处：</p>
<ol>
<li>降低数据库连接和提交的频率</li>
<li>避免频繁的数据库交互，减少 I/O 操作，显著提升性能</li>
</ol>
<p>💡类似的，Redis 也提供了批处理方法，比如 Pipeline。</p>
<p>2、SQL 优化</p>
<p>我们操作数据库的时候，可以用一些 SQL 优化的技巧</p>
<p>最经典的优化技巧就是 select 需要的列而不是 select *，降低内存的占用</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LambdaQueryWrapper&lt;Question&gt; questionLambdaQueryWrapper = Wrappers.lambdaQuery(Question.class).select(Question::getId).in(Question::getId, questionIdList);</span><br><span class="line">List&lt;Long&gt; validQuestionIdList = questionService.listObjs(questionLambdaQueryWrapper, obj -&gt; (Long) obj);</span><br></pre></td></tr></tbody></table></figure>

<p>3、并发编程</p>
<p>由于我们已经将操作分批处理，在操作较多、追求处理时间的情况下，可以通过并发编程让每批操作同时执行，而不是一批处理完再执行下一批，能够大幅提升性能。</p>
<p>Java 中，可以利用并发包中的 <strong>CompletableFuture + 线程池</strong> 来并发处理多个任务。</p>
<p>CompletableFuture 是 Java 8 中引入的一个类，用于表示异步操作的结果。它是 Future 的增强版本，不仅可以表示一个异步计算，还可以对异步计算的结果进行组合、转换和处理，<strong>实现异步任务的编排</strong>。</p>
<p>比如下列代码，将任务拆分为多个子任务，并发执行，最后通过 <code>CompletableFuture.allOf</code> 方法阻塞等待，只有所有的子任务都完成，才会执行后续代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>CompletableFuture 默认使用 Java 7 引入的 ForkJoinPool 线程池来并发执行任务。该线程池特别适合需要分治法来处理的大量并发任务，支持递归任务拆分。Java 8 中的并行流默认也是使用了 ForkJoinPool 进行并发处理</p>
<p>ForkJoinPool 的主要特性：</p>
<ul>
<li>工作窃取算法（Work-Stealing）：线程可以从其他线程的工作队列中“窃取”任务，以提高 CPU 的使用率和程序的并行性。</li>
<li>递归任务处理：支持将大任务拆分为多个小任务并行执行，然后再将结果合并。</li>
</ul>
<p>💡 但是要注意，CompletableFuture 默认使用的是 <code>ForkJoinPool.commonPool()</code> 方法得到的线程池，这是一个全局共享的线程池，如果有多种不同的任务都依赖该线程池进行处理，可能会导致资源争抢、代码阻塞等不确定的问题。<strong>所以建议针对每种任务，自定义线程池来处理，实现线程池资源的隔离。</strong></p>
<p>Java 内置了很多种不同的线程池，比如单线程的线程池、固定线程的线程池、自定义线程池等等，一般情况下我们会根据业务和资源情况 <strong>自定义线程池</strong>。下面是一个示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义线程池</span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">customExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">        <span class="number">4</span>,                         <span class="comment">// 核心线程数</span></span><br><span class="line">        <span class="number">10</span>,                        <span class="comment">// 最大线程数</span></span><br><span class="line">        <span class="number">60L</span>,                       <span class="comment">// 线程空闲存活时间</span></span><br><span class="line">        TimeUnit.SECONDS,           <span class="comment">// 存活时间单位</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>),  <span class="comment">// 阻塞队列容量</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// 拒绝策略：由调用线程处理任务</span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>

<p>此处画个重点，大家只要记住一个公式：</p>
<ol>
<li>对于计算密集型任务（消耗 CPU 资源）， 设置核心线程数为 <code>n+1</code> 或者 <code>n</code>（n 是 CPU 核心数），可以充分利用 CPU， 多一个线程是为了可以在某些线程短暂阻塞或执行调度时，确保有足够的线程保持 CPU 繁忙，最大化 CPU 的利用率。</li>
<li>对于 IO 密集型任务（消耗 IO 资源），可以增大核心线程数为 CPU 核心数的 2 - 4 倍，可以提升并发执行任务的数量。</li>
</ol>
<p>注意，虽然并发编程能够提升性能，但也会占用更多的资源，并且给系统引入更多的不确定性。比如某个任务出现异常时，其他任务可能正在执行，产生不确定的影响。对此，可以根据情况给异步任务补充异常处理行为，通过 <code>exceptionally</code> 方法就能实现，示例代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; {</span><br><span class="line">    questionBankQuestionService.batchAddQuestionsToBankInner(questionBankQuestions);</span><br><span class="line">}, customExecutor).exceptionally(ex -&gt; {</span><br><span class="line">    log.error(<span class="string">"批处理任务执行失败"</span>, ex);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>4、异步任务优化</p>
<p>将批量操作的处理变成提交一个后台任务，提交后台任务后，接口可以直接给前端返回已提交的任务 id。后台可以根据情况选择时机去执行之前提交的后台任务（比如通过定时任务或者消息队列）。</p>
<p>业务流程对应的示例代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping("/start")</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">startTask</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 生成唯一任务 id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">taskId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步提交或执行任务</span></span><br><span class="line">    executeLongRunningTask(taskId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回任务 id</span></span><br><span class="line">    <span class="keyword">return</span> taskId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>前端可以通过轮询调用接口、WebSocket、SSE 等方式得知任务的执行进度。比如后端提供一个根据任务 id 查询状态的接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询任务状态</span></span><br><span class="line"><span class="keyword">public</span> TaskStatus <span class="title function_">queryTaskStatus</span><span class="params">(String taskId)</span> {</span><br><span class="line">    <span class="keyword">return</span> taskService.getTaskStatus(taskId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，这种方案相当于改造了业务流程，成本较大，适合需要较长执行时间、或者需要对任务状态进行记录复盘的场景。</p>
<p><strong>怎么实现异步任务呢？</strong></p>
<p>1）立即执行异步任务</p>
<p>可以直接给要异步执行的方法加上 Spring 提供的 <code>@Async</code> 注解，或者手动使用 <code>CompletableFuture</code> 来异步执行任务。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchAddQuestionsToBankInner</span><span class="params">(List&lt;QuestionBankQuestion&gt; questionBankQuestions)</span> {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）定时任务</p>
<p>可以将任务信息保存到数据库中，通过 Spring Scheduler 定时任务持续扫描数据库中 <strong>未执行的任务</strong> 来执行。</p>
<p>3）通过消息队列进行任务分发</p>
<p>对于长时间的批量任务，还可以考虑使用 <strong>消息队列</strong>（如 RabbitMQ、Kafka）来异步处理任务。将任务放入消息队列，由消费者（后台服务）异步执行任务。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping("/start")</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">startTask</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 生成唯一任务 id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">taskId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将任务发送到消息队列</span></span><br><span class="line">    messageQueueService.sendMessage(<span class="keyword">new</span> <span class="title class_">TaskMessage</span>(taskId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回任务 id</span></span><br><span class="line">    <span class="keyword">return</span> taskId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>后台消费者接收到消息后处理：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = "batch-task-queue")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBatchTask</span><span class="params">(TaskMessage taskMessage)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> taskMessage.getTaskId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询数据库，根据 taskId 获取任务信息</span></span><br><span class="line">    <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> getById(taskId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行任务</span></span><br><span class="line">    doSomething(task);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行完成后，记得更新任务的状态</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>5、数据库连接池调优</p>
<p>数据库连接池是用于管理与数据库之间连接的资源池，它能够 <strong>复用</strong> 现有的数据库连接，而不是在每次请求时都新建和销毁连接，从而提升系统的性能和响应速度。</p>
<p>常见的数据库连接池有 2 种：</p>
<p>1）HikariCP：被认为是市场上最快的数据库连接池之一，具有非常低的延迟和高效的性能。它以其轻量级和简洁的设计闻名，占用较少的内存和 CPU 资源。</p>
<p>Spring Boot 2.x 版本及以上默认使用 HikariCP 作为数据库连接池。</p>
<p>2）<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">Druid</a>：由阿里巴巴开发的开源数据库连接池，提供了丰富的监控和管理功能，包括 SQL 分析、性能监控和慢查询日志等。适合需要深度定制和监控的企业级应用。</p>
<p>在使用 Spring Boot 2.x 的情况下，默认 HikariCP 连接池大小是 10，当前请求量大起来之后，如果数据库执行的不够快，那么请求都会被阻塞等待获取连接池的连接上。</p>
<p>比如鱼皮自己业务中出现的情况，获取数据库连接等待时间花了 17.43s，这就是典型的数据库连接不够用。如果项目的数据库连接池较小，此时应该调大数据库连接池的大小：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445591.png" alt="img"></p>
<p>如何进行数据库连接池调优呢？肯定不是凭感觉猜测，而是要通过监控或测试进行分析。</p>
<p>本项目使用 Druid 来做数据库连接池，因为它提供了丰富的监控和管理功能，更适合学习上手数据库连接池调优。</p>
<h4 id="引入-Druid-连接池"><a href="#引入-Druid-连接池" class="headerlink" title="引入 Druid 连接池"></a>引入 Druid 连接池</h4><p>可以参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki">官方文档</a> 引入（虽然也没什么好参考的）。</p>
<p>1）通过 Maven 引入 Druid，并且排除默认引入的 HikariCP：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 排除默认的 HikariCP --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>2）修改 application.yml 文件配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mianshiya</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment"># 指定数据源类型</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="comment"># Druid 配置</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="comment"># 配置初始化大小、最小、最大</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">minIdle:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">10</span></span><br><span class="line">      <span class="comment"># 配置获取连接等待超时的时间(单位：毫秒)</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span><br><span class="line">      <span class="attr">time-between-eviction-runs-millis:</span> <span class="number">2000</span></span><br><span class="line">      <span class="comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span></span><br><span class="line">      <span class="attr">min-evictable-idle-time-millis:</span> <span class="number">600000</span></span><br><span class="line">      <span class="attr">max-evictable-idle-time-millis:</span> <span class="number">900000</span></span><br><span class="line">      <span class="comment"># 用来测试连接是否可用的SQL语句,默认值每种数据库都不相同,这是mysql</span></span><br><span class="line">      <span class="attr">validationQuery:</span> <span class="string">select</span> <span class="number">1</span></span><br><span class="line">      <span class="comment"># 应用向连接池申请连接，并且testOnBorrow为false时，连接池将会判断连接是否处于空闲状态，如果是，则验证这条连接是否可用</span></span><br><span class="line">      <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 如果为true，默认是false，应用向连接池申请连接时，连接池会判断这条连接是否是可用的</span></span><br><span class="line">      <span class="attr">testOnBorrow:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># 如果为true（默认false），当应用使用完连接，连接池回收连接的时候会判断该连接是否还可用</span></span><br><span class="line">      <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># 是否缓存preparedStatement，也就是PSCache。PSCache对支持游标的数据库性能提升巨大，比如说oracle</span></span><br><span class="line">      <span class="attr">poolPreparedStatements:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 要启用PSCache，必须配置大于0，当大于0时， poolPreparedStatements自动触发修改为true，</span></span><br><span class="line">      <span class="comment"># 在Druid中，不会存在Oracle下PSCache占用内存过多的问题，</span></span><br><span class="line">      <span class="comment"># 可以把这个数值配置大一些，比如说100</span></span><br><span class="line">      <span class="attr">maxOpenPreparedStatements:</span> <span class="number">20</span></span><br><span class="line">      <span class="comment"># 连接池中的minIdle数量以内的连接，空闲时间超过minEvictableIdleTimeMillis，则会执行keepAlive操作</span></span><br><span class="line">      <span class="attr">keepAlive:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># Spring 监控，利用aop 对指定接口的执行时间，jdbc数进行记录</span></span><br><span class="line">      <span class="attr">aop-patterns:</span> <span class="string">"com.springboot.template.dao.*"</span></span><br><span class="line">      <span class="comment">########### 启用内置过滤器（第一个 stat 必须，否则监控不到SQL）##########</span></span><br><span class="line">      <span class="attr">filters:</span> <span class="string">stat,wall,log4j2</span></span><br><span class="line">      <span class="comment"># 自己配置监控统计拦截的filter</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="comment"># 开启druiddatasource的状态监控</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">db-type:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="comment"># 开启慢sql监控，超过2s 就认为是慢sql，记录到日志中</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment"># 日志监控，使用slf4j 进行日志输出</span></span><br><span class="line">        <span class="attr">slf4j:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">statement-log-error-enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">statement-create-after-log-enabled:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">statement-close-after-log-enabled:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">result-set-open-after-log-enabled:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">result-set-close-after-log-enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment">########## 配置WebStatFilter，用于采集web关联监控的数据 ##########</span></span><br><span class="line">      <span class="attr">web-stat-filter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span>                   <span class="comment"># 启动 StatFilter</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/*</span> <span class="comment"># 过滤所有url</span></span><br><span class="line">        <span class="attr">exclusions:</span> <span class="string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"</span> <span class="comment"># 排除一些不必要的url</span></span><br><span class="line">        <span class="attr">session-stat-enable:</span> <span class="literal">true</span>       <span class="comment"># 开启session统计功能</span></span><br><span class="line">        <span class="attr">session-stat-max-count:</span> <span class="number">1000</span> <span class="comment"># session的最大个数,默认100</span></span><br><span class="line">      <span class="comment">########## 配置StatViewServlet（监控页面），用于展示Druid的统计信息 ##########</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span>                   <span class="comment"># 启用StatViewServlet</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span> <span class="comment"># 访问内置监控页面的路径，内置监控页面的首页是/druid/index.html</span></span><br><span class="line">        <span class="attr">reset-enable:</span> <span class="literal">false</span>              <span class="comment"># 不允许清空统计数据,重新计算</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">root</span> <span class="comment"># 配置监控页面访问密码</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123</span></span><br><span class="line">        <span class="attr">allow:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># 允许访问的地址，如果allow没有配置或者为空，则允许所有访问</span></span><br><span class="line">        <span class="attr">deny:</span> <span class="comment"># 拒绝访问的地址，deny优先于allow，如果在deny列表中，就算在allow列表中，也会被拒绝</span></span><br></pre></td></tr></tbody></table></figure>

<p>3）启动后访问监控面板：<a target="_blank" rel="noopener" href="http://localhost:8101/api/druid/index.html">http://localhost:8101/api/druid/index.html</a></p>
<p>去除底部广告</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(DruidDataSourceAutoConfigure.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = "spring.datasource.druid.stat-view-servlet.enabled",</span></span><br><span class="line"><span class="meta">        havingValue = "true", matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoveDruidAdConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法名: removeDruidAdFilterRegistrationBean</span></span><br><span class="line"><span class="comment">     * 方法描述 除去页面底部的广告</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties com.alibaba.druid.spring.boot.autoconfigure.properties.DruidStatProperties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> org.springframework.boot.web.servlet.FilterRegistrationBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">removeDruidAdFilterRegistrationBean</span><span class="params">(DruidStatProperties properties)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取web监控页面的参数</span></span><br><span class="line">        DruidStatProperties.<span class="type">StatViewServlet</span> <span class="variable">config</span> <span class="operator">=</span> properties.getStatViewServlet();</span><br><span class="line">        <span class="comment">// 提取common.js的配置路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pattern</span> <span class="operator">=</span> config.getUrlPattern() != <span class="literal">null</span> ? config.getUrlPattern() : <span class="string">"/druid/*"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">commonJsPattern</span> <span class="operator">=</span> pattern.replaceAll(<span class="string">"\\*"</span>, <span class="string">"js/common.js"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">"support/http/resources/js/common.js"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建filter进行过滤</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException {}</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException {</span><br><span class="line">                chain.doFilter(request, response);</span><br><span class="line">                <span class="comment">// 重置缓冲区，响应头不会被重置</span></span><br><span class="line">                response.resetBuffer();</span><br><span class="line">                <span class="comment">// 获取common.js</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> Utils.readFromResource(filePath);</span><br><span class="line">                <span class="comment">// 正则替换banner, 除去底部的广告信息</span></span><br><span class="line">                text = text.replaceAll(<span class="string">"&lt;a.*?banner\"&gt;&lt;/a&gt;&lt;br/&gt;"</span>, <span class="string">""</span>);</span><br><span class="line">                text = text.replaceAll(<span class="string">"powered.*?shrek.wang&lt;/a&gt;"</span>, <span class="string">""</span>);</span><br><span class="line">                response.getWriter().write(text);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> {}</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>();</span><br><span class="line">        registrationBean.setFilter(filter);</span><br><span class="line">        registrationBean.addUrlPatterns(commonJsPattern);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="使用-Druid-监控"><a href="#使用-Druid-监控" class="headerlink" title="使用 Druid 监控"></a>使用 Druid 监控</h4><p>我们将数据库连接数改为 1，获取等待超时时间为 2s：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">druid:</span></span><br><span class="line">  <span class="comment"># 配置初始化大小、最小、最大</span></span><br><span class="line">  <span class="attr">initial-size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">minIdle:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">max-active:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># 配置获取连接等待超时的时间(单位：毫秒)</span></span><br><span class="line">  <span class="attr">max-wait:</span> <span class="number">2000</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后任意执行一次对数据库的批量操作，比如插入 20 条数据，每批 2 条，一共 10 批，会随机报错：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445673.png" alt="img"></p>
<p>查看 Druid 监控，可以看到最大并发为 1，因为连接池的连接数量只有 1：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445703.png" alt="img"></p>
<p>除了 SQL 的监控，还有 URI 的监控，可以看到是哪个接口调用了数据库，执行了多少时间。以后出现线上数据库卡死的问题时，很快就能定位到是哪个接口、哪个 SQL 出现了问题（或者访问频率过高）。</p>
<p><img src="https://pic.yupi.icu/1285/202409091445000.png" alt="img"></p>
<p>💡 Druid 的 URI 监控是怎么实现的？</p>
<p>核心实现方法如下：</p>
<ol>
<li>通过基于 Servlet 的过滤器 <code>WebStatFilter</code> 来拦截请求，该过滤器会收集关于请求的相关信息，比如请求的 URI、执行时长、请求期间执行的 SQL 语句数等。</li>
<li>统计 URI 和 SQL 执行情况是怎么关联起来的呢？ 每次执行 SQL 时，Druid 会在内部统计该 SQL 的执行情况，而 <code>WebStatFilter</code> 会把 SQL 执行信息与当前的 HTTP 请求 URI 关联起来。</li>
</ol>
<p><strong>何时该调整数据库连接数呢？</strong></p>
<p>有的时候，即使我们服务器 JVM 的内存和 CPU 占用都非常低，其他的中间件比如 MySQL 和 Redis 的占用也非常低，但系统依然会出现响应慢、卡死的情况。这可能就是因为一些配置错误，所以了解这些知识还是非常有必要的。</p>
<h4 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h4><p>1、事务管理</p>
<p>我们目前已经使用了 <code>@Transactional(rollbackFor = Exception.class)</code> 来保证数据一致性。如果任意一步操作失败，整个事务会回滚，确保数据一致性。</p>
<p>2、并发管理</p>
<p>在高并发场景下，如果多个管理员同时向同一个题库添加题目，可能会导致冲突或性能问题。为了解决并发问题，确保数据一致性和稳定性，可以有 2 种常见的策略：</p>
<p>1）增加 <strong>分布式锁</strong> 来防止同一个接口（或方法）在同一时间被多个管理员同时操作，比如使用 Redis + Redisson 实现分布式锁。</p>
<p>2）如果要精细地对某个数据进行并发控制，可以选用 <strong>乐观锁</strong>。比如通过给 <code>QuestionBank</code> 表增加一个 <code>version</code> 字段，在更新时检查版本号是否一致，确保对同一个题库的并发操作不会相互干扰。</p>
<p>伪代码实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新题库前，先查询版本号</span></span><br><span class="line"><span class="type">QuestionBank</span> <span class="variable">questionBank</span> <span class="operator">=</span> questionBankService.getById(questionBankId);</span><br><span class="line"><span class="type">Long</span> <span class="variable">currentVersion</span> <span class="operator">=</span> questionBank.getVersion();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新时，检查版本号是否一致</span></span><br><span class="line"><span class="type">int</span> <span class="variable">rowsAffected</span> <span class="operator">=</span> questionBankService.updateVersionById(questionBankId, currentVersion);</span><br><span class="line"><span class="keyword">if</span> (rowsAffected == <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ErrorCode.CONCURRENT_MODIFICATION, <span class="string">"数据已被其他用户修改"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>💡 在 MySQL 中，还可以采用 <code>SELECT ... FOR UPDATE</code> 来强行锁定某一行数据，直到当前事务提交或回滚之前，防止其他事务对这行数据进行修改。</p>
<p>本项目中，由于关联表有唯一键约束，保证不会重复，所以不需要用这种方案。</p>
<h4 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h4><p>可观测性的关键在于以下三个方面：</p>
<ol>
<li>可见性：系统需要能够报告它的内部状态。这个优化方案通过返回 <code>BatchAddResult</code> 提供了丰富的状态反馈。</li>
<li>追踪性：通过详细的错误原因和具体失败项，可以轻松地追踪问题源头。</li>
<li>诊断性：明确的反馈信息有助于快速诊断问题，而不仅仅是提供一个简单的 “成功” 或 “失败”。</li>
</ol>
<p>2、监控</p>
<p>监控是实现可观测性的主流手段，你可以对服务器、JVM、请求、以及项目中引入的各种组件进行监控。</p>
<p>常用的监控工具有 Grafana，如果你给项目引入了某个技术组件，一般都会自带监控，比如项目调用数据库的情况可以通过 Druid 监控、Elasticsearch 可以通过 Kibana 监控等等、Spring Boot 内置了 Spring Boot Actuator 来监控应用运行状态等。</p>
<p>💡 如果你使用的是第三方云服务，比如 XX 云的云数据库，一般都会自带成熟的监控面板，有时间建议大家多去逛逛云服务平台，能看到很多业界成熟的监控方案。</p>
<p>3、返回值优化</p>
<p>目前我们的方法返回的是 <code>void</code>，这意味着在执行过程中没有明确反馈操作的结果。为了提升可观测性，我们可以根据任务的执行状态返回更加详细的结果，帮助调用者了解任务的执行情况。</p>
<p>可以定义一个返回结果对象，包含每个题目的处理状态、成功和失败的数量，以及失败的原因。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchAddResult</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> total;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> successCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> failureCount;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; failureReasons;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在批量操作中出现问题时，可以不抛出异常并中断其他的操作，只是记录部分失败的操作情况。这样一来，管理员可以知道哪些题目操作成功、哪些失败，更好地进行后续处理。</p>
<p>以下为示例代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> BatchAddResult <span class="title function_">batchAddQuestionsToBank</span><span class="params">(List&lt;Long&gt; questionIdList, Long questionBankId, User loginUser)</span> {</span><br><span class="line">    <span class="type">BatchAddResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BatchAddResult</span>();</span><br><span class="line">    result.setTotal(questionIdList.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行批量插入逻辑</span></span><br><span class="line">    <span class="keyword">for</span> (Long questionId : questionIdList) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 插入操作</span></span><br><span class="line">            saveQuestionToBank(questionId, questionBankId, loginUser);</span><br><span class="line">            result.setSuccessCount(result.getSuccessCount() + <span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            result.setFailureCount(result.getFailureCount() + <span class="number">1</span>);</span><br><span class="line">            result.getFailureReasons().add(<span class="string">"题目ID "</span> + questionId + <span class="string">" 插入失败："</span> + e.getMessage());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result; <span class="comment">// 返回批量处理的结果</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>OK，学到了这么多优化方法，大家可以自己根据情况选用。</p>
<h2 id="自动缓存热门题库"><a href="#自动缓存热门题库" class="headerlink" title="自动缓存热门题库"></a>自动缓存热门题库</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p>随着用户的日益增长，对系统的性能和稳定性的要求也越来越高</p>
<p>对于本系统，为了减少用户题目和加载网页的时间，可以对经常访问的数据进行缓存，而不是每次都从数据库查询</p>
<p>重用的缓存就是 Redis + Caffine，因此本项目可以引入缓存将热门题目缓存，减少题目的加载时间</p>
<p>由于有的数据被经常访问，有的不会，我们需要自动监测哪些是热点数据，并将这些热点数据缓存起来，保证系统的稳定性和用户体验</p>
<h3 id="为什么需要自动发现热点？"><a href="#为什么需要自动发现热点？" class="headerlink" title="为什么需要自动发现热点？"></a>为什么需要自动发现热点？</h3><p>因为热点的瞬时流量大，需要及时发现与缓存。如果靠人为来手动设置，可能刚打开后台页面，系统就已经崩溃了，一般要求秒级发现热点且自动缓存。</p>
<blockquote>
<p>那么回归到本项目的需求，我们希望自动为频繁访问的题库增加缓存。</p>
<p>具体的规则是：对于获取题库详情的请求，如果 5 秒内访问 &gt;= 10 次，就要使用本地缓存将题库详情缓存 10 分钟，之后都从本地缓存读取。</p>
</blockquote>
<h3 id="方案设计-1"><a href="#方案设计-1" class="headerlink" title="方案设计"></a>方案设计</h3><p>自动缓存热门题库需要以下五个步骤：</p>
<p>1、记录访问：用户每访问一次题库，统计次数 +1</p>
<p>2、统计访问：统计一段时间内题库的访问次数。<strong>这是最难实现的一部分。</strong></p>
<p>3、阈值判断：访问频率超过一定的阈值，变为热点数据。</p>
<p>4、缓存数据：缓存热点数据</p>
<p>5、获取数据：后续访问时，从缓存中获取数据</p>
<p>当然，还有很多注意事项，比如热点数据如何更新？如何恢复为正常数据等等。</p>
<p>让你自己实现的话，你能搞定么？</p>
<h3 id="hotkey-入门"><a href="#hotkey-入门" class="headerlink" title="hotkey 入门"></a>hotkey 入门</h3><p>京东提供了一个轻量级通用的热 key 探测中间件 <a target="_blank" rel="noopener" href="https://gitee.com/jd-platform-opensource/hotkey">hotkey</a>。</p>
<p>根据官方仓库描述：hotkey 是京东APP后台热数据探测框架，历经多次高压压测和京东 618、双 11 大促考验。</p>
<p>在上线运行的这段时间内，<strong>每天探测的 key 数量数十亿计</strong>，精准捕获了大量爬虫、刷子用户，另准确探测大量热门商品并毫秒级推送到各个服务端内存，大幅降低了热数据对数据层的查询压力，提升了应用性能。<strong>在大促期间，hotkey 的 worker 集群秒级吞吐量达到 1500 万级别。</strong></p>
<p>根据官方压测：一台 8 核 8G 的机器，每秒可以处理来自于数千台服务器发来的高达 16 万个的待测 key，8 核单机吞吐量在 16 万，16 核机器每秒可达 30 万以上探测量，所以仅采用 10 台机器，即可完成每秒近 300 万次的 key 探测任务。</p>
<p>这是一个真正经历过实战的高性能热点 key 探测框架，整体架构如下：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445533.png" alt="img"></p>
<h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><p>它的主要核心组件如下：</p>
<p>1）Etcd 集群</p>
<p>Etcd 作为一个高性能的配置中心，可以以极小的资源占用，提供高效的监听订阅服务。主要用于存放规则配置，各 worker 的 ip 地址，以及探测出的热 key、手工添加的热 key 等。</p>
<p>Etcd 常用于配置中心和注册中心，鱼皮在 <a target="_blank" rel="noopener" href="https://www.code-nav.cn/course/1768543954720022530">编程导航的手写 RPC 项目</a> 中讲解过。</p>
<p>2）client 端 jar 包</p>
<p>就是在服务中添加的引用 jar，引入后，就可以便捷地去判断某 key 是否热 key。同时，该 jar 完成了 key 上报、监听 Etcd 里的 rule 变化、worker 信息变化、热 key 变化，对热 key 进行本地 Caffeine 缓存等。</p>
<p>3）worker 端集群</p>
<p>worker 端是一个独立部署的 Java 程序，启动后会连接 Etcd，并定期上报自己的 ip 信息，供 client 端获取地址并进行长连接。之后，主要就是对各个 client 发来的待测 key 进行 <strong>累加计算</strong>，当达到 Etcd 里设定的 rule 阈值后，将热 key 推送到各个 client。</p>
<p>4）dashboard 控制台</p>
<p>控制台是一个带可视化界面的 Java 程序，也是连接到 Etcd，之后在控制台设置各个 APP 的 key 规则，譬如 2 秒出现 20 次算热 key。然后当 worker 探测出来热 key 后，会将 key 发往 etcd，dashboard 也会监听热 key 信息，进行入库保存记录。同时，dashboard 也可以手工添加、删除热 key，供各个 client 端监听。</p>
<h3 id="后端开发（hotkey-实战）"><a href="#后端开发（hotkey-实战）" class="headerlink" title="后端开发（hotkey 实战）"></a>后端开发（hotkey 实战）</h3><p>hotkey 搭建可以直接参考 <a target="_blank" rel="noopener" href="https://gitee.com/jd-platform-opensource/hotkey#%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B">官方的安装教程</a></p>
<h4 id="1、安装-etcd"><a href="#1、安装-etcd" class="headerlink" title="1、安装 etcd"></a>1、安装 etcd</h4><p>直接从<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases"> github</a> 上下载最新版本的 Etcd 即可，选择对应的操作系统版本：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445564.png" alt="img"></p>
<p>下载后解压压缩包，会得到 3 个脚本：</p>
<ul>
<li>etcd：etcd 服务本身</li>
<li>etcdctl：客户端，用于操作 etcd，比如读写数据</li>
<li>etcdutl：备份恢复工具</li>
</ul>
<p><img src="https://pic.yupi.icu/1285/202409091445614.png" alt="img"></p>
<p>执行 etcd 脚本后，可以启动 etcd 服务，服务默认占用 2379 和 2380 端口，作用分别如下：</p>
<ul>
<li>2379：提供 HTTP API 服务，和 etcdctl 交互</li>
<li>2380：集群中节点间通讯</li>
</ul>
<h4 id="2、安装-hotkey-worker"><a href="#2、安装-hotkey-worker" class="headerlink" title="2、安装 hotkey worker"></a>2、安装 hotkey worker</h4><p>从 <a target="_blank" rel="noopener" href="https://gitee.com/jd-platform-opensource/hotkey">hotkey 官方仓库</a> 下载源码，注意，本项目使用的是 hotkey v0.0.4 版本，<strong>JDK 的版本必须小于 17！否则会报找不到类的错误！</strong></p>
<p>项目导入 IDEA 后，打开 worker 模块。worker 是一个 Spring Boot 项目，启动前需要先修改 applicaiton.yml 中的配置。比如端口配置（本项目使用 8900）：</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240916162517.png" alt="image-20240916162517295"></p>
<blockquote>
<p>disruptor 是 worker 一个统计热点 key 访问次数的算法</p>
</blockquote>
<p>修改完配置，点击 WorkerApplication 即可运行</p>
<p>如下图，此时 worker 就已经正常启动，并且连接上 Etcd 了：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445352.png" alt="img"></p>
<p>后续如果要打包部署，可以通过 Maven 打包得到 worker 的 jar 包，比如在整个 hotkey 项目根目录执行 mvn package，会依次对各模块打包。</p>
<p><img src="https://pic.yupi.icu/1285/202409091445683.png" alt="img"></p>
<p>然后可以通过命令启动 worker，可以携带参数来修改配置：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar worker-0.0.4-SNAPSHOT.jar --etcd.server=127.0.0.1:2379</span><br></pre></td></tr></tbody></table></figure>

<h4 id="3、启动-hotkey-控制台"><a href="#3、启动-hotkey-控制台" class="headerlink" title="3、启动 hotkey 控制台"></a>3、启动 hotkey 控制台</h4><p>接着打开 dashboard 项目，执行 resource 目录下的 db.sql 文件，创建 dashboard 所需的库表。hotkey 依赖 MySQL 来存储用户账号信息、热点阈值规则等。</p>
<p>在执行脚本前，记得先配置好 MySQL 连接，并且在 SQL 脚本文件中创建和指定数据库：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create database hotkey_db;</span><br><span class="line">use hotkey_db;</span><br></pre></td></tr></tbody></table></figure>

<p>执行脚本如下：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445191.png" alt="img"></p>
<p>从 db.sql 可以看到内置的控制台账号密码，默认是 admin/123456</p>
<p>然后修改下 application.yml 配置文件，包括 dashboard 占用端口号（本教程使用 8121）、数据库配置和 etcdServer 地址等：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8901</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">${MYSQL_USER:root}</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">${MYSQL_PASS:123456}</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://${MYSQL_HOST:localhost}:3306/hotkey_db?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=UTC&amp;useTimezone=true&amp;serverTimezone=GMT</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">${etcdServer:http://127.0.0.1:2379}</span></span><br></pre></td></tr></tbody></table></figure>

<p>dashboard 也是一个 SpringBoot 项目，直接在 IDEA 内执行 DashboardApplication 启动即可。</p>
<p>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8901/">http://127.0.0.1:8901，即可看到界面：</a></p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240916165801.png" alt="image-20240916165800919"></p>
<p>登录成功的界面：</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240916170055.png" alt="image-20240916170055553"></p>
<p>初次使用时需要先添加 APP。建议先在用户管理菜单中，添加一个新用户，设置昵称为 APP 名称、并填写所属 APP，如 mianshiya，密码此处就设置为 123456。之后就可以登录这个新建的用户来给应用设置规则了 (当然也可以使用 admin 账户添加)，而且系统会自动创建一个 APP。</p>
<p><img src="https://pic.yupi.icu/1285/202409091445601.png" alt="img"></p>
<p>随后，在规则配置中，选择对应的 APP，新增对应的热点探测规则：</p>
<p><img src="https://pic.yupi.icu/1285/202409091445631.png" alt="img"></p>
<p>如下图就是一组规则：</p>
<p><img src="https://pic.yupi.icu/1285/202409091446034.png" alt="img"></p>
<ul>
<li>duration：持续时间</li>
<li>interval：统计的间隔</li>
<li>key：对哪些 key 生效</li>
<li>prefix：前缀</li>
<li>threshold：阈值</li>
<li>desc：描述</li>
</ul>
<p><strong>对第二个案例就是，以 as__ 开头的 key，在 2s 内访问此时超过 10 次就缓存 60s</strong></p>
<h4 id="4、引入-hotkey-client"><a href="#4、引入-hotkey-client" class="headerlink" title="4、引入 hotkey client"></a>4、引入 hotkey client</h4><p>有 2 种引入 hotkey client 的方式：</p>
<ol>
<li>手动源码打包</li>
<li>通过 <a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.github.ck-jesse/jd-hotkey-client">Maven 远程仓库</a> 引入</li>
</ol>
<p>本项目中使用方式 1</p>
<p><img src="https://pic.yupi.icu/1285/202409091446142.png" alt="img"></p>
<p>从生成的 target 中找到 <code>with-dependencies</code> 的 jar 包，可以修改名称为 <code>hotkey-client-0.0.4-SNAPSHOT.jar</code>：</p>
<p><img src="https://pic.yupi.icu/1285/202409091446188.png" alt="img"></p>
<p>接着在要引入 hotkey client 的项目中创建 lib 文件夹，放入 client 的 jar 包。注意要把该 jar 包添加到 Git 仓库中，否则其他人无法正常运行你的项目。</p>
<p><img src="https://pic.yupi.icu/1285/202409091446238.png" alt="img"></p>
<p>然后通过 Maven 引入即可：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hotkey-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jd.platform.hotkey<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.4-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>${project.basedir}/lib/hotkey-client-0.0.4-SNAPSHOT.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>但是在本项目中引入该依赖后，项目无法运行，因为 Hutool 依赖库版本冲突了。</p>
<p>💡 注意，使用 <code>system</code> 作用域并不是最佳实践，原因是 <code>system</code> 作用域的依赖具有 <strong>最高优先级</strong>。它会跳过 Maven 的依赖解析机制，直接使用你指定的本地 JAR 文件，因此它的优先级会高于其他任何来自依赖树中的传递依赖或外层依赖声明。</p>
<p>具体来说：</p>
<ol>
<li>跳过依赖管理：<code>system</code> 作用域会跳过 Maven 的依赖管理和版本解析。你必须手动管理依赖版本和路径，Maven 无法帮你解析冲突、升级版本或使用传递依赖。</li>
<li>无法排除依赖：由于 <code>system</code> 作用域是强制性的，任何试图通过 <code>exclusions</code> 排除这个依赖的尝试都会失败。其他模块或依赖项中的冲突问题也无法通过正常的 <code>dependencyManagement</code> 或 <code>exclusions</code> 机制来解决。</li>
<li>不可传递：<code>system</code> 作用域的依赖不会传递给其他模块。也就是说，如果你的项目被其他项目依赖，<code>system</code> 作用域的依赖不会自动传递给依赖你的项目。这可能导致构建或运行时的依赖问题。</li>
<li>路径硬编码：<code>system</code> 作用域的依赖路径是硬编码的，并且指定为本地文件系统的绝对路径或相对路径。这使得项目在不同开发环境中变得难以移植，也不符合 Maven 的通用依赖管理原则。</li>
</ol>
<p>所以一般建议将依赖包通过 Maven 安装（install）到本地仓库，或者上传包到 Maven 官方库，或者在团队内部使用 Maven 私服来管理依赖。</p>
<p>但这里我们不这么做，考虑到教程项目，要让开发者更容易地使用项目。所以还是直接拷贝 jar，开发者就不用自己 mvn install 来安装包了，否则还可能出现报错。</p>
<p>其实还有更粗暴的方法，直接爆改源码中使用的 hutool 版本，但是一般不建议这么做，毕竟你不了解别人的项目，还是该自己的方便一些。</p>
<p>所以我们的做法是，降低项目的 hutool 版本，改动点也不多，所以还好。</p>
<p>比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(tagsStr)) {</span><br><span class="line">    questionEsDTO.setTags(JSONUtil.toList(JSONUtil.parseArray(tagsStr), String.class));</span><br><span class="line">}</span><br><span class="line"><span class="type">String</span> <span class="variable">fileSuffix</span> <span class="operator">=</span> FileNameUtil.getSuffix(multipartFile.getOriginalFilename());</span><br></pre></td></tr></tbody></table></figure>



<p>引入依赖后，在代码中编写初始化 client 的配置类，会读取配置文件并执行初始化逻辑：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "hotkey")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotKeyConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Etcd 服务器完整地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">etcdServer</span> <span class="operator">=</span> <span class="string">"http://127.0.0.1:2379"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> <span class="string">"app"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地缓存最大数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">caffeineSize</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量推送 key 的间隔时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">pushPeriod</span> <span class="operator">=</span> <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 hotkey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initHotkey</span><span class="params">()</span> {</span><br><span class="line">        ClientStarter.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientStarter</span>.Builder();</span><br><span class="line">        <span class="type">ClientStarter</span> <span class="variable">starter</span> <span class="operator">=</span> builder.setAppName(appName)</span><br><span class="line">                .setCaffeineSize(caffeineSize)</span><br><span class="line">                .setPushPeriod(pushPeriod)</span><br><span class="line">                .setEtcdServer(etcdServer)</span><br><span class="line">                .build();</span><br><span class="line">        starter.startPipeline();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>💡 如何在 Spring Boot 启动时执行初始化代码？可以参考这道面试题：<a target="_blank" rel="noopener" href="https://www.mianshiya.com/question/1800329866123747329">https://www.mianshiya.com/question/1800329866123747329</a></p>
<p>更改 application.yml 配置，注意应用名称必须和控制台创建的一致：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 热 key 探测</span></span><br><span class="line"><span class="attr">hotkey:</span></span><br><span class="line">  <span class="attr">app-name:</span> <span class="string">mianshiya</span></span><br><span class="line">  <span class="attr">caffeine-size:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">push-period:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">etcd-server:</span> <span class="string">http://localhost:2379</span></span><br></pre></td></tr></tbody></table></figure>

<p>启动，能够看到 1 个客户端连接：</p>
<p><img src="https://pic.yupi.icu/1285/202409091446254.png" alt="img"></p>
<p>这样就能项目中使用了。</p>
<h4 id="5、了解开发者模式"><a href="#5、了解开发者模式" class="headerlink" title="5、了解开发者模式"></a>5、了解开发者模式</h4><p>只要使用 JdHotKeyStore 这个类即可非常方便地判断 key 是否成为热点和获取热点 key 对应的本地缓存。</p>
<p>这个类主要有如下 4 个方法可供使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> JdHotKeyStore.isHotKey(String key)</span><br><span class="line">Object JdHotKeyStore.get(String key)</span><br><span class="line"><span class="keyword">void</span> JdHotKeyStore.smartSet(String key, Object value)</span><br><span class="line">Object JdHotKeyStore.getValue(String key)</span><br></pre></td></tr></tbody></table></figure>

<p>1）boolean isHotKey(String key)</p>
<p>该方法会返回该 key 是否是热 key，如果是返回 true，如果不是返回 false，并且会将 key 上报到探测集群进行数量计算。该方法通常用于判断只需要判断 key 是否热、不需要缓存 value 的场景，如刷子用户、接口访问频率等。</p>
<p>2）Object get(String key)</p>
<p>该方法返回该 key 本地缓存的 value 值，可用于判断是热 key 后，再去获取本地缓存的 value 值，通常用于 redis 热 key 缓存。</p>
<p>3）void smartSet(String key, Object value)</p>
<p>方法给热 key 赋值 value，如果是热 key，该方法才会赋值，非热 key，什么也不做</p>
<p>4）Object getValue(String key)</p>
<p>该方法是一个整合方法，相当于 isHotKey 和 get 两个方法的整合，该方法直接返回本地缓存的 value。 如果是热 key，则存在两种情况</p>
<ol>
<li>是返回 value</li>
<li>是返回 null</li>
</ol>
<p>返回 null 是因为尚未给它 set 真正的 value，返回非 null 说明已经调用过 set 方法了，本地缓存 value 有值了。 如果不是热 key，则返回 null，并且将 key 上报到探测集群进行数量探测。</p>
<p><strong>官方推荐的最佳实践</strong></p>
<p>1）判断用户是否是刷子：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (JdHotKeyStore.isHotKey(“pin__” + thePin)) {</span><br><span class="line">    <span class="comment">// 进行限流</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）判断商品 id 是否是热点：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">skuInfo</span> <span class="operator">=</span> JdHotKeyStore.getValue(<span class="string">"skuId__"</span> + skuId);</span><br><span class="line"><span class="keyword">if</span>(skuInfo == <span class="literal">null</span>) {</span><br><span class="line">    JdHotKeyStore.smartSet(<span class="string">"skuId__"</span> + skuId, theSkuInfo);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// 使用缓存好的 value 即可</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>个人更推荐这种写法，更加清晰：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (JdHotKeyStore.isHotKey(key)) {</span><br><span class="line">    //注意是get，不是getValue。getValue会获取并上报，get是纯粹的本地获取</span><br><span class="line">    Object skuInfo = JdHotKeyStore.get("skuId__" + skuId);</span><br><span class="line">    if(skuInfo == null) {</span><br><span class="line">        JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);</span><br><span class="line">    } else {</span><br><span class="line">        //使用缓存好的value即可</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6、配置-hotkey-规则"><a href="#6、配置-hotkey-规则" class="headerlink" title="6、配置 hotkey 规则"></a>6、配置 hotkey 规则</h4><p>根据我们的需求，判断 <code>bank_detail_</code> 开头的 key，如果 5 秒访问 10 次，就会被推送到 jvm 内存中，将这个热 key 缓存 10 分钟。</p>
<p>对应的规则配置如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "duration": 600,</span><br><span class="line">        "key": "bank_detail_",</span><br><span class="line">        "prefix": true,</span><br><span class="line">        "interval": 5,</span><br><span class="line">        "threshold": 10,</span><br><span class="line">        "desc": "热门题库缓存"</span><br><span class="line">    }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

<p>在控制台新增规则：</p>
<p><img src="https://pic.yupi.icu/1285/202409091446299.png" alt="img"></p>
<h4 id="7、项目应用-hotkey"><a href="#7、项目应用-hotkey" class="headerlink" title="7、项目应用 hotkey"></a>7、项目应用 hotkey</h4><p>获取题库接口 getQuestionBankVOById，先通过 isHotKey 判断当前题目是否是热点题目，如果是，则从数据库获取后放入本地缓存；之后直接从本地缓存获取即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/get/vo")</span></span><br><span class="line"><span class="keyword">public</span> BaseResponse&lt;QuestionBankVO&gt; <span class="title function_">getQuestionBankVOById</span><span class="params">(QuestionBankQueryRequest questionBankQueryRequest, HttpServletRequest request)</span> {</span><br><span class="line">    ThrowUtils.throwIf(questionBankQueryRequest == <span class="literal">null</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> questionBankQueryRequest.getId();</span><br><span class="line">    ThrowUtils.throwIf(id &lt;= <span class="number">0</span>, ErrorCode.PARAMS_ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成 key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">"bank_detail_"</span> + id;</span><br><span class="line">    <span class="comment">// 如果是热 key</span></span><br><span class="line">    <span class="keyword">if</span> (JdHotKeyStore.isHotKey(key)) {</span><br><span class="line">        <span class="comment">// 从本地缓存中获取缓存值</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">cachedQuestionBankVO</span> <span class="operator">=</span> JdHotKeyStore.get(key);</span><br><span class="line">        <span class="keyword">if</span> (cachedQuestionBankVO != <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 如果缓存中有值，直接返回缓存的值</span></span><br><span class="line">            <span class="keyword">return</span> ResultUtils.success((QuestionBankVO) cachedQuestionBankVO);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原本查询数据的逻辑（查数据库）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置本地缓存</span></span><br><span class="line">    JdHotKeyStore.smartSet(key, questionBankVO);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取封装类</span></span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(questionBankVO);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="8、测试验证"><a href="#8、测试验证" class="headerlink" title="8、测试验证"></a>8、测试验证</h4><p>不设置规则是不会判断热点 key 的</p>
<p><img src="https://pic.yupi.icu/1285/202409091446572.png" alt="img"></p>
<p>通过接口文档 5 秒内先访问 10 次，能够看到实时热点：</p>
<p><img src="https://pic.yupi.icu/1285/202409091446597.png" alt="img"> <img src="https://pic.yupi.icu/1285/202409091446683.png" alt="img"></p>
<p>debug 程序，第 11 次请求的时候虽然会判断为 hotkey，但还是不会走缓存，本次请求会设置缓存。后续就能查询缓存了。</p>
<p>JdHotKeyStore.smartSet 方法只有是热 key 的情况下才会设置缓存，所以第 11 次请求虽然判断已经是热 key，但由于缓存未设置因此读的还是数据库</p>
<h3 id="拓展知识"><a href="#拓展知识" class="headerlink" title="拓展知识"></a>拓展知识</h3><h4 id="1、如何更新本地缓存"><a href="#1、如何更新本地缓存" class="headerlink" title="1、如何更新本地缓存"></a>1、如何更新本地缓存</h4><p>需要有一个入口让缓存失效，进行人工干预。</p>
<p>hotkey 提供了 <code>JdHotKeyStore.remove()</code> 方法，可以手动删除本地缓存并移除热点 key。</p>
<p>还可以利用控制台手动删除：</p>
<p><img src="https://pic.yupi.icu/1285/202409091446363.png" alt="img"></p>
<p>不过一般情况下，热点信息一般都是不太会变更的数据，过期时间设置短一点即可。</p>
<h4 id="2、是否能够和-redis-分布式缓存结合？"><a href="#2、是否能够和-redis-分布式缓存结合？" class="headerlink" title="2、是否能够和 redis 分布式缓存结合？"></a>2、是否能够和 redis 分布式缓存结合？</h4><p>当然可以，热 key 探测 = 热 key 发现 + 本地缓存。可以只利用热 key 的判断方法，不利用热 key 的存储方法即可。</p>
<ol>
<li>不是热 key，就查数据库。对于热 key，写缓存时，再判断一下是否为热 key，是热 key 才设置 Redis 分布式缓存。后续的热 key 就可以从分布式缓存中获取值。（缓存存储的技术或者位置变了）</li>
<li>利用热 key 探测的本地缓存，将原本查数据库的逻辑改为查 Redis，Redis 查不到才查询数据库，形成多级缓存。（获取原始数据的方法改变了）</li>
</ol>
<h4 id="3、热-key-会自动续期么？否则可能出现缓存雪崩的问题？"><a href="#3、热-key-会自动续期么？否则可能出现缓存雪崩的问题？" class="headerlink" title="3、热 key 会自动续期么？否则可能出现缓存雪崩的问题？"></a>3、热 key 会自动续期么？否则可能出现缓存雪崩的问题？</h4><p>可以先自己测试一下。比如针对某个热点 key 再多次发送请求查询缓存，发现在热 key 生效（缓存生效）期间，如果该 key 仍然被不断访问，并不会刷新缓存时间，直到过期。</p>
<p>然后看下源码，就知道为什么了。源码中的逻辑是，如果已经是热 key 则不会再 push，离过期还有 2 秒内的时候，会再次 push，这样这个 key 可能被继续设置为热 key。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isHotKey</span><span class="params">(String key)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (!inRule(key)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isHot</span> <span class="operator">=</span> isHot(key);</span><br><span class="line">            <span class="keyword">if</span> (!isHot) {</span><br><span class="line">                HotKeyPusher.push(key, (KeyType)<span class="literal">null</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="type">ValueModel</span> <span class="variable">valueModel</span> <span class="operator">=</span> getValueSimple(key);</span><br><span class="line">                <span class="keyword">if</span> (isNearExpire(valueModel)) {</span><br><span class="line">                    HotKeyPusher.push(key, (KeyType)<span class="literal">null</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            KeyHandlerFactory.getCounter().collect(<span class="keyword">new</span> <span class="title class_">KeyHotModel</span>(key, isHot));</span><br><span class="line">            <span class="keyword">return</span> isHot;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception var3) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isNearExpire</span><span class="params">(ValueModel valueModel)</span> {</span><br><span class="line">    <span class="keyword">if</span> (valueModel == <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> valueModel.getCreateTime() + (<span class="type">long</span>)valueModel.getDuration() - System.currentTimeMillis() &lt;= <span class="number">2000L</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>也就是说，如果一个 key 持续被访问，很有可能在过期前一直被设置为热点，减少了出现雪崩问题的可能性。</p>
<h3 id="扩展-1"><a href="#扩展-1" class="headerlink" title="扩展"></a>扩展</h3><p>1）热点题目增加自动缓存</p>
<p>思路：跟本教程演示的热点题库完全一致。</p>
<p>2）编写一个注解，自动对该方法进行热 key 探测，并将返回值作为本地缓存</p>
<p>思路：参考 Spring Data Redis 提供的 @Cacheable 注解，可以利用 AOP 扫描注解实现。</p>
<h2 id="流量安全性优化"><a href="#流量安全性优化" class="headerlink" title="流量安全性优化"></a>流量安全性优化</h2><ul>
<li>网站流量控制和熔断（基于 Sentinel）</li>
<li>动态 IP 黑白名单过滤（基于 Nacos）</li>
</ul>
<h3 id="网站流量控制和熔断"><a href="#网站流量控制和熔断" class="headerlink" title="网站流量控制和熔断"></a>网站流量控制和熔断</h3><p>流量安全优化的目标可以简单概括为：确保数据在传输过程中的机密性、完整性和可用性，防止未经授权的访问、篡改、泄露和攻击，同时提升网络传输效率与性能。</p>
<p>而从流量控制和熔断的角度来看，流量安全优化的目标又可以概括为：防止系统过载、保障服务可用性、抵御恶意流量，并确保系统能够快速从故障中恢复。这也是本期教程中我们追求的目标。</p>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><p>随着网站的发展，用户量逐渐增大，特别是互联网公司，用户量更是呈指数型增长，此时一旦出现促销活动，网站的流量会大大超越平均水平，在高并发请求下系统很可能会崩溃。</p>
<p>对应到我们的面试刷题平台，在金三银四或金九银十面试高峰期，网站流量会变大，还可能会有各种爬虫和恶意攻击。为了避免系统崩溃和保护服务稳定性，我们需要对网站做一定的防护措施。1608639807578177538_0.1294413323883763</p>
<p>常见的防护措施就是 <strong>流量控制</strong>：限制系统进入的请求数量，防止过载。</p>
<p>除此之外，为了进一步隔离和保护系统，防止某些组件异常时影响系统的稳定性，还会采用 <strong>熔断机制 + 降级策略</strong> 进行兜底处理，提升系统的健壮性和可用性。</p>
<p>下面分别对流量控制、熔断和降级进行解释</p>
<h4 id="1、流量控制"><a href="#1、流量控制" class="headerlink" title="1、流量控制"></a>1、流量控制</h4><p>流量控制是为了 <strong>防止系统被过多的请求压垮</strong>，确保资源合理分配并保持服务的可用性，比如对请求数量的限制。</p>
<p>流量控制的 3 个主要优势：1608639807578177538_0.7754967842504696</p>
<ol>
<li>防止过载：当瞬间涌入的请求量超出系统处理能力时，会导致资源枯竭，如 CPU 和内存耗尽。流量控制通过限制系统能处理的请求数，确保不会发生过载。</li>
<li>避免雪崩效应：高负载下某个服务崩溃可能引发其他依赖服务的崩溃，形成连锁反应。流量控制可以有效预防这种连锁故障，避免系统雪崩。</li>
<li>优化用户体验：即便部分请求被拒绝或延迟处理，流量控制也能确保大部分用户的请求能够正常响应，避免全局响应时间过长的情况。1608639807578177538_0.7763346884741562</li>
</ol>
<p>常见的实现流量控制方法有 2 种：</p>
<ul>
<li>限流：通过固定窗口、令牌桶或漏桶等算法限制单位时间内的请求数量。</li>
<li>排队：当请求量超出处理能力时，部分请求进入等待队列，防止立即超载。</li>
<li>1608639807578177538_0.4708111848381056</li>
</ul>
<p>主要有以下常见的流量控制类型：</p>
<p>1）请求频率限制：限制单位时间内单用户、单 IP 的请求数（如每秒最多 100 次请求）。</p>
<p><img src="https://pic.yupi.icu/1285/202409131712877.png" alt="img"></p>
<p>2）带宽限制：控制访问系统时消耗的带宽量或者下载速度。</p>
<p><img src="https://pic.yupi.icu/1285/202409131712936.png" alt="img"></p>
<p>3）总流量限制：限制用户或系统整体的数据传输量。</p>
<p>1608639807578177538_0.20668252984600444</p>
<p><img src="https://pic.yupi.icu/1285/202409131712954.png" alt="img"></p>
<p>4）细粒度控制：根据接口、用户等特定维度进行组合限流。比如限制访问特定接口时，每个用户每分钟只能访问 60 次。</p>
<h4 id="2、熔断机制"><a href="#2、熔断机制" class="headerlink" title="2、熔断机制"></a>2、熔断机制</h4><p>可以参考：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/circuit-breaking.html">https://sentinelguard.io/zh-cn/docs/circuit-breaking.html</a></p>
<p>熔断机制的目的是 <strong>避免当下游服务发生异常时，整个系统继续耗费资源重复发起失败请求</strong>，从而防止连锁故障。</p>
<p>这类似于电路中的断路器，当检测到异常情况时，熔断器会自动切断对故障服务的调用，防止问题扩大。1608639807578177538_0.30931350357585163</p>
<p>工作机制：</p>
<ol>
<li>监控服务健康状态：系统会实时监控服务的调用情况，例如请求成功率、响应时间等，判断服务的健康状况。</li>
<li>进入熔断状态：当某个服务的错误率达到设定阈值（如响应时间过长或出错率过高）时，系统会 <strong>激活熔断器</strong>，暂时停止对该服务的调用，避免消耗不必要的资源和让错误进一步扩散。</li>
<li>快速失败：在熔断状态下，系统不会再等待超时，而是直接返回失败响应，减少系统资源占用，并避免因长时间等待导致用户体验的恶化。（也可以降级处理）1608639807578177538_0.013142651290177776</li>
<li>熔断恢复机制：熔断并非永久状态。在一段时间后，熔断器会进入 <strong>半开状态</strong>，允许少量请求测试服务的健康情况。如果恢复正常，熔断器将关闭，恢复正常服务调用；如果仍有问题，则继续保持熔断。</li>
</ol>
<p>熔断流程：</p>
<p>1608639807578177538_0.4432245777087911</p>
<p><img src="https://pic.yupi.icu/1285/202409131712997.jpeg" alt="img"></p>
<p>举个例子，一个支付服务由于高负载频繁超时，此时熔断器会检测到支付服务的健康状况恶化，暂时切断对它的调用，防止前端系统继续发出请求。如果不采取熔断措施，支付服务的异常可能会拖垮整个系统，甚至影响其他依赖的服务模块或系统资源（比如请求连接）。</p>
<h4 id="3、降级机制"><a href="#3、降级机制" class="headerlink" title="3、降级机制"></a>3、降级机制</h4><p>降级的目的是在某个服务的响应能力下降、或该服务不可用时，提供简化版的功能或返回默认值作为 <strong>兜底</strong>，保持系统的部分功能可用，确保用户体验的连续性，避免系统频繁报错。</p>
<p>降级可以是手动配置，也可以根据系统负载自动触发。系统可能由于多种原因（如高负载、外部依赖不可用等）触发降级，返回简化的响应或默认值。</p>
<p>降级机制的好处：1608639807578177538_0.2694092122438603</p>
<ol>
<li>优雅地处理故障：在降级状态下，系统不会直接返回错误信息，而是提供一个替代方案。例如，某个数据查询服务不可用时，系统可以返回缓存数据，确保用户看到的是有效信息，而非错误页面。</li>
<li>降低服务压力：降级有助于减轻系统对非核心服务的依赖，确保核心功能的稳定运行。例如，当推荐系统或广告服务出现故障时，降级可以减少对这些服务的调用，保护系统的整体稳定性。</li>
</ol>
<p>举个例子，在一个电商网站上，如果商品推荐系统由于外部服务故障无法正常运行，可以触发降级机制，显示一组静态的推荐商品列表。这确保用户仍然能够顺利浏览商品页面，而不是直接看到错误信息。</p>
<p>是不是有点 try…catch… 的感觉？但降级这个概念显然比异常处理要更“高大上”一些，不一定是出了异常才降级，响应较慢或者受到其他服务影响可能也会触发降级。</p>
<h4 id="4、熔断和降级的区别"><a href="#4、熔断和降级的区别" class="headerlink" title="4、熔断和降级的区别"></a>4、熔断和降级的区别</h4><p>初学者很容易把这两个概念搞混，二者是完全不同的概念，只不过经常结合使用罢了。</p>
<p>熔断不一定要降级，只是切断调用；降级也不一定需要熔断，单次调用失败也可以降级（比如数据库查询失败返回内存的数据）。1608639807578177538_0.8400012094483926</p>
<p>具体来说：</p>
<ul>
<li>熔断是当服务健康状况恶化时，通过 <strong>切断调用</strong> 避免系统资源浪费或服务间故障扩散。</li>
<li>降级是在系统压力过大或某个服务不可用时，通过 <strong>提供简化的替代方案</strong> ，保持系统的可用性和用户体验。</li>
</ul>
<p>两者经常结合使用，先触发熔断后再进行降级。</p>
<h4 id="扩展知识-有损服务"><a href="#扩展知识-有损服务" class="headerlink" title="扩展知识 - 有损服务"></a>扩展知识 - 有损服务</h4><p>有损服务指的是在系统资源有限或负载较高的情况下，系统 <strong>有意识地</strong> 舍弃部分非核心服务或数据，来保证系统整体的稳定性和核心功能的可用性。简单来说，就是“丢车保帅”。</p>
<p>举些例子：1608639807578177538_0.6523680530059925</p>
<ul>
<li>视频流媒体：在网络带宽不足时，流媒体平台会动态降低视频质量（如从高清降到标清），以避免中断视频播放。这就是典型的“有损”策略，牺牲画质来保证视频的流畅播放。</li>
<li>实时数据采集：在高并发环境下，系统可以通过丢弃部分非重要的日志或监控数据，减少数据处理压力，优先保证核心业务流程。</li>
</ul>
<p>什么时候使用有损服务和降级？</p>
<ul>
<li>有损服务：适用于需要在性能和质量之间做出平衡的场景，特别是 <strong>当系统资源不足</strong> 时，选择牺牲某些服务的质量来保证整体稳定。</li>
<li>降级：适用于需要保证系统核心功能在高负载或部分服务不可用的情况下仍能继续提供的场景。降级更多是 <strong>在功能层面进行简化</strong> ，而非直接丢弃数据或服务。</li>
<li>1608639807578177538_0.34153155897027343</li>
</ul>
<p>可以这么理解：有损服务更倾向于 <strong>整体视角</strong> 上资源的取舍，降级更倾向于保证 <strong>某个功能</strong> 的可用。</p>
<h3 id="需求分析（限流熔断规则）"><a href="#需求分析（限流熔断规则）" class="headerlink" title="需求分析（限流熔断规则）"></a>需求分析（限流熔断规则）</h3><p>本项目的具体需求：要对什么资源进行限流熔断？规则是怎么样的？</p>
<p>我们来完成两个有代表性的需求：</p>
<ol>
<li>对单个接口整体限流</li>
<li>对单个 IP 访问单个接口限流</li>
</ol>
<h4 id="1、查看题库列表接口限流熔断"><a href="#1、查看题库列表接口限流熔断" class="headerlink" title="1、查看题库列表接口限流熔断"></a>1、查看题库列表接口限流熔断</h4><p>资源：listQuestionBankVOByPage 接口</p>
<p>目的：控制对耗时较长的、经常访问的接口的请求频率，防止过多请求导致系统过载。</p>
<p>限流规则：1608639807578177538_0.5895519431203375</p>
<ul>
<li>策略：整个接口每秒钟不超过 10 次请求</li>
<li>阻塞操作：提示“系统压力过大，请耐心等待”</li>
</ul>
<p>熔断规则：</p>
<ul>
<li>熔断条件：如果接口异常率超过 10%，或者慢调用（响应时长 &gt; 3 秒）的比例大于 20%，触发 60 秒熔断。</li>
<li>熔断操作：直接返回本地数据（缓存或空数据）</li>
</ul>
<h4 id="2、单-IP-查看题目列表限流熔断"><a href="#2、单-IP-查看题目列表限流熔断" class="headerlink" title="2、单 IP 查看题目列表限流熔断"></a>2、<strong>单 IP 查看题目列表限流熔断</strong></h4><p>资源：listQuestionVoByPage 接口</p>
<p>限流规则：1608639807578177538_0.5206259383646323</p>
<ul>
<li>策略：每个 IP 地址每分钟允许查看题目列表的次数不能超过 60 次。</li>
<li>阻塞操作：提示“访问过于频繁，请稍后再试”</li>
</ul>
<p>熔断规则：</p>
<ul>
<li>熔断条件：如果接口异常率超过 10%，或者慢调用（响应时长 &gt; 3 秒）的比例大于 20%，触发 60 秒熔断。</li>
<li>熔断操作：直接返回本地数据（缓存或空数据）</li>
<li>1608639807578177538_0.9334369382223324</li>
</ul>
<h4 id="扩展知识-更多规则"><a href="#扩展知识-更多规则" class="headerlink" title="扩展知识 - 更多规则"></a>扩展知识 - 更多规则</h4><p>以下规则感兴趣的同学可自主实现：</p>
<p>1）题目搜索</p>
<p>限流规则：每个 IP 地址每分钟允许进行的题目搜索次数，例如 100 次。</p>
<p>熔断操作：直接返回本地数据（缓存或空数据）</p>
<p>2）用户注册</p>
<p>限流规则：每个 IP 地址每分钟允许注册的次数，例如 5 次。超过阈值则返回用户注册频繁的错误提示，防止恶意注册。</p>
<p>熔断规则：如果用户注册服务出现异常率高于 5%（例如连续 5 分钟内的失败请求占总请求的比例），则触发熔断，给用户一个友好的错误提示。</p>
<p>3）用户登录1608639807578177538_0.07382706348810664</p>
<p>限流规则：每个 IP 地址每分钟允许尝试登录的次数，例如 10 次。对于频繁的失败登录尝试，可以限制登录尝试次数，防止暴力破解攻击。</p>
<p>熔断规则：如果登录服务的失败率超过 10% 或登录尝试次数过多（例如每分钟超过 1000 次），则触发熔断，给用户一个友好的错误提示。</p>
<h3 id="实现方案（技术选型）"><a href="#实现方案（技术选型）" class="headerlink" title="实现方案（技术选型）"></a>实现方案（技术选型）</h3><p>除了网关层（Nginx 等）实现的限流，在 Java 项目中常用来实现限流熔断相关的技术主要有以下几种：</p>
<h4 id="1、Sentinel"><a href="#1、Sentinel" class="headerlink" title="1、Sentinel"></a>1、Sentinel</h4><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html">Sentinel</a> 是阿里巴巴开源的限流、熔断、降级组件，旨在为分布式系统提供可靠的保护机制。它设计用于解决高并发流量下的稳定性问题，并且支持与 Dubbo、Spring Cloud 等多种框架集成。1608639807578177538_0.5598448193889138</p>
<p>它的功能：</p>
<ul>
<li>限流：支持基于 QPS、并发数量等条件的限流，支持滑动窗口、预热、漏桶等算法。</li>
<li>熔断降级：支持失败率、慢调用比例等指标触发熔断，并提供自动恢复机制。</li>
<li>热点参数限流：可以基于特定的参数进行限流，如限制特定用户 ID 的请求频率。1608639807578177538_0.22365088046550397</li>
<li>系统负载保护：可以根据系统的实际负载（如 CPU、内存）动态调整流量。</li>
<li>丰富的规则配置：通过配置中心或控制台动态调整限流和熔断规则。</li>
</ul>
<p>优势：功能丰富、提供控制台、更新较频繁、社区活跃、文档清晰，能够快速入门上手。</p>
<h4 id="2、Hystrix"><a href="#2、Hystrix" class="headerlink" title="2、Hystrix"></a>2、Hystrix</h4><p><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix">Hystrix</a> 是 Netflix 开源的一个限流、熔断和降级库。它通过熔断器模式在检测到下游服务失败率过高时中断请求，以防止系统资源耗尽。</p>
<p>它的功能：</p>
<ul>
<li>熔断：当调用失败或响应超时时，触发熔断，停止调用失败的服务。</li>
<li>降级：在触发熔断后，调用备用逻辑或默认返回值。</li>
<li>隔离：Hystrix 使用线程池或信号量来隔离服务调用，防止单个服务的资源消耗影响全局。</li>
<li>熔断恢复：当下游服务恢复时，逐步恢复调用。</li>
</ul>
<p>还提供了丰富的监控和告警功能，可以通过 Hystrix Dashboard 进行实时监控。</p>
<p>但是 <strong>它目前已经进入维护状态，不再进行新的功能更新</strong>，所以新项目就没必要使用了：1608639807578177538_0.34314973197738485</p>
<p><img src="https://pic.yupi.icu/1285/202409131712009.png" alt="img"></p>
<h4 id="3、Resilience4j"><a href="#3、Resilience4j" class="headerlink" title="3、Resilience4j"></a>3、Resilience4j</h4><p><a target="_blank" rel="noopener" href="https://github.com/resilience4j/resilience4j">Resilience4j</a> 是一个轻量级的熔断、限流、隔离、重试库，它设计灵感来源于 Netflix 的 Hystrix 框架，专门设计为响应式编程和 Java 8+ 风格下的熔断库。</p>
<p>优点：它很轻量级，没有外部依赖，特别适合响应式编程风格。</p>
<p>缺点：相比 Sentinel，功能相对较少，尤其在限流功能上不够丰富。</p>
<h4 id="4、Guava-RateLimiter"><a href="#4、Guava-RateLimiter" class="headerlink" title="4、Guava RateLimiter"></a>4、Guava RateLimiter</h4><p>RateLimiter 是 <a target="_blank" rel="noopener" href="https://github.com/google/guava">Guava</a> 提供的一个限流工具，基于令牌桶算法实现，主要用于对系统的流量进行控制。</p>
<p>缺点：它仅支持限流，且功能相对单一，不能处理熔断等复杂场景。适合不需要复杂熔断或隔离功能的小型项目，主要用于 <strong>单机系统</strong> 的流量控制。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每秒允许 2 个请求</span></span><br><span class="line"><span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> RateLimiter.create(<span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">    <span class="comment">// 阻塞直到可以获取到许可</span></span><br><span class="line">    rateLimiter.acquire();</span><br><span class="line">    System.out.println(<span class="string">"请求 "</span> + i + <span class="string">" 在 "</span> + System.currentTimeMillis() + <span class="string">" 执行"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5、Redisson-RRateLimiter"><a href="#5、Redisson-RRateLimiter" class="headerlink" title="5、Redisson RRateLimiter"></a>5、Redisson RRateLimiter</h4><p>Redisson 是一个基于 Redis 的 Java 驱动程序，它提供了丰富的分布式工具和数据结构，其中包括分布式锁、计数器、队列、信号量，以及限流（Rate Limiter）等功能。1608639807578177538_0.2775543579144386</p>
<p>Redisson 提供了 <code>RRateLimiter</code> 接口来支持限流操作。你可以定义时间窗口内允许的最大请求数，超出限制的请求将被阻塞或拒绝。它的限流基于 Redis 的计数器来控制访问频率，确保即使在多台服务器之间，也能有效地限制请求速率。</p>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化Redisson客户端</span></span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取限流器对象</span></span><br><span class="line"><span class="type">RRateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> redisson.getRateLimiter(<span class="string">"myRateLimiter"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化限流器，设置速率：每1秒钟最多3个请求</span></span><br><span class="line">rateLimiter.trySetRate(RRateLimiter.RateType.OVERALL, <span class="number">3</span>, <span class="number">1</span>, RRateLimiter.IntervalUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求限流器获取许可</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">acquired</span> <span class="operator">=</span> rateLimiter.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">"Request "</span> + (i + <span class="number">1</span>) + <span class="string">" is allowed: "</span> + acquired);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>💡<a target="_blank" rel="noopener" href="https://www.code-nav.cn/course/1790980531403927553">编程导航的智能 BI 项目</a> 中，就是通过 Redisson RRateLimiter 实现了限流，感兴趣的同学可以学习。</p>
<h4 id="选型策略"><a href="#选型策略" class="headerlink" title="选型策略"></a>选型策略</h4><p>1）从功能全面、生态成熟角度：如果需要全面的熔断、限流、降级、监控功能，同时兼容 Spring Cloud、Spring Boot、Dubbo 等微服务架构，Sentinel 是最佳选择，在我们国内公司中有较广泛应用。</p>
<p>2）从轻量级、响应式编程角度：如果项目采用响应式编程模型，或希望使用轻量级的熔断限流组件，Resilience4j 是非常好的选择。</p>
<p>3）已有 Hystrix 集成的系统：如果现有系统已经集成了 Hystrix，可以继续使用，但需要考虑未来的技术更新，推荐逐渐过渡到 Sentinel。</p>
<p>4）单机限流需求：对于不需要复杂熔断功能的小型应用，Guava RateLimiter 可以快速实现简单的限流。1608639807578177538_0.35619406910300677</p>
<p>5）分布式限流需求：对于不需要复杂熔断功能的分布式应用，Redisson 的 RRateLimiter 可以快速实现简单的限流。</p>
<p><strong>本项目中，我们选择使用 Sentinel</strong>，带大家学习一个功能强大，支持多种限流、熔断策略，支持多种框架集成的网站流量控制和熔断组件。</p>
<p>Sentinel 官方给出的组件对比：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712023.png" alt="img"></p>
<h3 id="Sentinel-入门"><a href="#Sentinel-入门" class="headerlink" title="Sentinel 入门"></a>Sentinel 入门</h3><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html1608639807578177538_0.7696198441551441">https://sentinelguard.io/zh-cn/index.html1608639807578177538_0.7696198441551441</a></p>
<h4 id="1、核心概念"><a href="#1、核心概念" class="headerlink" title="1、核心概念"></a>1、核心概念</h4><p>1）资源：表示要保护的业务逻辑或代码块。我们说的资源，可以是任何东西，服务、服务里的方法、甚至是一段代码。</p>
<p>使用 Sentinel 来进行资源保护，主要分为几个步骤：</p>
<ol>
<li>定义资源</li>
<li>定义规则</li>
<li>检验规则是否生效1608639807578177538_0.6919617170598169</li>
</ol>
<p><strong>先把可能需要保护的资源定义好，之后再配置规则。</strong>也可以理解为，只要有了资源，我们就可以在任何时候灵活地定义各种流量控制规则。在编码的时候，只需要考虑这个代码是否需要保护，如果需要保护，就将之定义为一个资源。</p>
<p>有多种定义资源的方法，比如编程式和注解式，<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html">参考官方文档</a> 。</p>
<p>2）规则：Sentinel 使用规则来定义对资源的保护策略。</p>
<p>可以 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html">参考官方文档</a> 来了解规则，比如：</p>
<ul>
<li>限流规则：用于控制流量的规则，设置 QPS（每秒查询量）等参数，防止系统过载。</li>
<li>熔断规则：用于实现熔断降级的规则，当某个资源的异常比例或响应时间超过阈值时，触发熔断，短时间内不再访问该资源。</li>
<li>系统规则：根据系统的整体负载（如 CPU 使用率、内存使用率等）进行保护，适合在系统级别进行流量控制。</li>
<li>热点参数规则：用于限制某个方法的某些热点参数的访问频率，避免某些参数导致流量过大。</li>
<li>授权规则：用于定义黑白名单的授权规则，控制资源访问的权限。</li>
</ul>
<p>3）控制台： Sentinel 控制台是一个可视化的管理工具，主要用于监控、管理和配置 Sentinel 的流控规则、熔断规则等。它提供了一个友好的界面，让用户可以轻松地操作。这是 Sentinel 的核心优势，可以提升可观测性，没有 Sentinel 控制台，感觉就失去了使用它的灵魂。</p>
<p>4）客户端：是指集成了 Sentinel 的应用程序，通常是通过引入 Sentinel 的依赖来接入。客户端负责在本地对资源进行监控、限流、熔断，并将 <strong>数据上报</strong> 给控制台。</p>
<h4 id="2、架构设计"><a href="#2、架构设计" class="headerlink" title="2、架构设计"></a>2、架构设计</h4><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/basic-implementation.html">参考官方文档的基本原理</a>，总体架构设计如下：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712131.png" alt="img"></p>
<p>Sentinel 将 <code>ProcessorSlot</code> 作为 SPI 接口进行扩展，使得 Slot Chain 具备了扩展的能力。您可以自行加入自定义的 slot 并编排 slot 间的顺序，从而可以给 Sentinel 添加自定义的功能。1608639807578177538_0.13882980675285173</p>
<p><img src="https://pic.yupi.icu/1285/202409131712234.png" alt="img"></p>
<p>对于限流系统，指标的统计依然是实现关键，Sentinel 中使用高性能的环形计数器（滑动窗口）来实现：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712285.png" alt="img"></p>
<h4 id="3、Sentinel-入门-Demo"><a href="#3、Sentinel-入门-Demo" class="headerlink" title="3、Sentinel 入门 Demo"></a>3、Sentinel 入门 Demo</h4><p>1）引入依赖：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.8.8&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>2）编写 Sentinel 测试类：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 限流测试</span><br><span class="line"> */</span><br><span class="line">public class SentinelTest {</span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        // 配置规则</span><br><span class="line">        initFlowRules();</span><br><span class="line"></span><br><span class="line">        while (true) {</span><br><span class="line">            // 1.5.0 版本开始可以直接利用 try-with-resources 特性</span><br><span class="line">            try (Entry entry = SphU.entry("HelloWorld")) {</span><br><span class="line">                // 被保护的逻辑</span><br><span class="line">                System.out.println("hello world");</span><br><span class="line">            } catch (BlockException ex) {</span><br><span class="line">                // 处理被流控的逻辑</span><br><span class="line">                System.out.println("blocked!");</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 定义限流规则，限制 QPS 为 20</span><br><span class="line">     */</span><br><span class="line">    private static void initFlowRules(){</span><br><span class="line">        List&lt;FlowRule&gt; rules = new ArrayList&lt;&gt;();</span><br><span class="line">        FlowRule rule = new FlowRule();</span><br><span class="line">        rule.setResource("HelloWorld");</span><br><span class="line">        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">        // Set limit QPS to 20.</span><br><span class="line">        rule.setCount(20);</span><br><span class="line">        rules.add(rule);</span><br><span class="line">        FlowRuleManager.loadRules(rules);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3）运行效果：</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240919120500.png" alt="image-20240919120500549"></p>
<p>Demo 运行之后，我们可以在日志 <code>~/logs/csp/${appName}-metrics.log.xxx</code> 里看到下面的输出:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|--timestamp-|------date time----|--resource-|p |block|s |e|rt</span><br><span class="line">1529998904000|2018-06-26 15:41:44|hello world|20|0    |20|0|0</span><br><span class="line">1529998905000|2018-06-26 15:41:45|hello world|20|5579 |20|0|728</span><br><span class="line">1529998906000|2018-06-26 15:41:46|hello world|20|15698|20|0|0</span><br><span class="line">1529998907000|2018-06-26 15:41:47|hello world|20|19262|20|0|0</span><br><span class="line">1529998908000|2018-06-26 15:41:48|hello world|20|19502|20|0|0</span><br><span class="line">1529998909000|2018-06-26 15:41:49|hello world|20|18386|20|0|0</span><br></pre></td></tr></tbody></table></figure>

<p>其中 <code>p</code> 代表通过的请求, <code>block</code> 代表被阻止的请求, <code>s</code> 代表成功执行完成的请求个数, <code>e</code> 代表用户自定义的异常, <code>rt</code> 代表平均响应时长。</p>
<blockquote>
<p>可以根据使用的框架引入适配依赖，<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/open-source-framework-integrations.html">参考官方文档</a>。</p>
</blockquote>
<p>此处直接运行 Main 方法来演示效果，JVM 参数为：<code>-Dcsp.sentinel.dashboard.server=localhost:8131</code></p>
<p><img src="https://pic.yupi.icu/1285/202409131712884.png" alt="img"></p>
<p>可以 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/quick-start.html">参考官网编写入门 Demo</a>，在本地通过 Main 方法运行一个 Sentinel 客户端程序。</p>
<p>运行成功后，可以在当前用户根目录下（~/logs/csp/${appName}-metrics.log.xxx）看到输出：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712315.png" alt="img"></p>
<h4 id="4、下载并启动-Sentinel-控制台"><a href="#4、下载并启动-Sentinel-控制台" class="headerlink" title="4、下载并启动 Sentinel 控制台"></a>4、下载并启动 Sentinel 控制台</h4><p>可以 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/dashboard.html">参考官方文档</a> 进行安装。</p>
<p>1）下载控制台 jar 包并在本地启动，可以访问从 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">github</a> 上下载 release的 jar 包。</p>
<p>我为大家提供了软件包：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA">https://pan.baidu.com/s/1u73-Nlolrs8Rzb1_b6X6HA</a> ，提取码：c2sd</p>
<p>2）直接在命令行窗口启动 Sentinel 控制台：</p>
<p>注意：启动 Sentinel 控制台需要 JDK 版本为 1.8 及以上版本。</p>
<p>命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8131 -jar sentinel-dashboard-1.8.8.jar</span><br></pre></td></tr></tbody></table></figure>

<p>启动成功：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712402.png" alt="img"></p>
<p>本地访问 <a target="_blank" rel="noopener" href="http://localhost:8131/%EF%BC%88%E4%BD%A0%E5%A1%AB%E7%9A%84%E7%AB%AF%E5%8F%A3%EF%BC%89%EF%BC%8C%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%8C**%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81%E9%83%BD%E6%98%AF">http://localhost:8131/（你填的端口），即可访问控制台，**默认账号和密码都是</a> sentinel**</p>
<p><img src="https://pic.yupi.icu/1285/202409131712701.png" alt="img"></p>
<p>4）客户端接入控制台</p>
<p>引入 Maven 依赖，用于和 Sentinel 控制台通讯：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;sentinel-transport-simple-http&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.8.8&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>程序启动时需要加入 JVM 参数 <code>-Dcsp.sentinel.dashboard.server=consoleIp:port</code> 指定控制台地址和端口。若启动多个应用，则需要通过 <code>-Dcsp.sentinel.api.port=xxxx</code> 指定客户端监控 API 的端口（默认是 8719）。</p>
<p><img src="https://hejiajun-img-bucket.oss-cn-wuhan-lr.aliyuncs.com/img/20240919125849.png" alt="image-20240919125849751"></p>
<p>Sentinel 非常贴心，提供了很多框架整合的依赖，便于开发，比如 Spring Web 项目支持将所有的接口自动识别为资源：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712858.png" alt="img"></p>
<p>还有更多的配置，比如更改日志目录等，可以看 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/startup-configuration.html">官方文档</a> 了解。</p>
<p><strong>确保客户端有访问量</strong>，Sentinel 会在 <strong>客户端首次调用的时候</strong> 进行初始化，开始向控制台发送心跳包。通过控制台可以查看到实时访问情况：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712906.png" alt="img"></p>
<p>查看机器列表和健康情况：</p>
<p><img src="https://pic.yupi.icu/1285/202409131712922.png" alt="img"></p>
<p>簇点链路（单机调用链路）页面实时的去拉取指定客户端资源的运行情况。它一共提供两种展示模式：一种用树状结构展示资源的调用链路，另外一种则不区分调用链路展示资源的运行情况。如图：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713463.png" alt="img"></p>
<h4 id="5、规则管理和推送"><a href="#5、规则管理和推送" class="headerlink" title="5、规则管理和推送"></a>5、规则管理和推送</h4><p>问题：Sentinel 的规则存储在哪里呢？又是如何通过控制台修改规则之后，将规则同步给客户端进行限流熔断的呢？</p>
<p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/dashboard.html">官方文档</a> 有详细地介绍：Sentinel 控制台同时提供简单的规则管理以及推送的功能。规则推送分为 3 种模式，包括 “原始模式”、”Pull 模式” 和 “Push 模式”。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713501.png" alt="img"></p>
<p>目前控制台的规则推送也是通过 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8#%E6%9F%A5%E8%AF%A2%E6%9B%B4%E6%94%B9%E8%A7%84%E5%88%99">规则查询更改 HTTP API</a> 来更改规则。<strong>这也意味着这些规则仅在内存态生效，应用重启之后，该规则会丢失。</strong></p>
<p>以上是原始模式。当了解了原始模式之后，官方建议通过 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html">动态规则</a> 并结合各种外部存储来定制自己的规则源。我们推荐通过动态配置源的控制台来进行规则写入和推送，而不是通过 Sentinel 客户端直接写入到动态配置源中。</p>
<p>在生产环境中，官方推荐 push 模式，支持自定义存储规则的配置中心，控制台改变规则后，会 push 到配置中心。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713519.png" alt="img"></p>
<p>更多规则管理和推送规则可以阅读：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel">在生产环境使用 Sentinel</a>。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713532.png" alt="img"></p>
<h4 id="6、整合-Spring-Boot"><a href="#6、整合-Spring-Boot" class="headerlink" title="6、整合 Spring Boot"></a>6、整合 Spring Boot</h4><p>基于 Spring Boot Starter + 注解模式开发 + 原始规则推送模式开发1608639807578177538_0.11239088707580192</p>
<p>Spring Boot 项目可以轻松和 Sentinel 集成，直接引入一个 starter，使用 <a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">Spring Cloud Alibaba Sentinel</a> 即可。</p>
<p><strong>在引入整合依赖时，一定要注意版本号！</strong></p>
<p>建议 <a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E">参考官方文档选择版本</a>。由于 Spring Boot 3.0，Spring Boot 2.7~2.4 和 2.4 以下版本之间变化较大，目前企业级客户老项目相关 Spring Boot 版本仍停留在 Spring Boot 2.4 以下，为了同时满足存量用户和新用户不同需求，社区以 Spring Boot 3.0 和 2.4 分别为分界线，同时维护 2022.x、2021.x、2.2.x 三个分支迭代。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713550.png" alt="img"></p>
<p>本项目 Spring Boot 用的是 2.7，因此使用 Sentinel Starter 的版本 2021.0.5.0。在项目中引入依赖：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-sentinel --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2021.0.5.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，该依赖自动整合了 Sentinel 的 core 包、客户端通讯包、注解开发包、webmvc 适配包、热点参数限流包等：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713569.png" alt="img"></p>
<p>整合包支持自动将所有的接口根据 url 路径识别为资源。启动项目后，通过接口文档测试就能看到监控效果：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713993.png" alt="img"></p>
<p><img src="https://pic.yupi.icu/1285/202409131713080.png" alt="img"></p>
<p>注意：无论是整合 Spring Boot 的 Sentinle 还是简单的 Demo 都要加上 vm 选项：<code>-Dcsp.sentinel.dashboard.server=localhost:8131</code>，这样才能保证数据上报到 Sentinel 控制台</p>
<h4 id="7、开发模式"><a href="#7、开发模式" class="headerlink" title="7、开发模式"></a>7、开发模式</h4><p>Sentinel 的开发主要包括定义资源和定义规则。</p>
<p><strong>1）定义资源</strong>：支持通过代码、引入框架适配、<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/annotation-support.html">注解方式</a> 定义资源。</p>
<p>通过代码定义资源，更灵活：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Entry entry = null;</span><br><span class="line">// 务必保证finally会被执行</span><br><span class="line">try {</span><br><span class="line">  // 资源名可使用任意有业务语义的字符串</span><br><span class="line">  entry = SphU.entry("自定义资源名");</span><br><span class="line">  // 被保护的业务逻辑</span><br><span class="line">  // do something...</span><br><span class="line">} catch (BlockException e1) {</span><br><span class="line">  // 资源访问阻止，被限流或被降级</span><br><span class="line">  // 进行相应的处理操作</span><br><span class="line">} finally {</span><br><span class="line">  if (entry != null) {</span><br><span class="line">    entry.exit();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过注解定义资源，更快捷可读：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class TestService {</span><br><span class="line"></span><br><span class="line">    // 对应的 `handleException` 函数需要位于 `ExceptionUtil` 类中，并且必须为 static 函数.</span><br><span class="line">    @SentinelResource(value = "test", blockHandler = "handleException", blockHandlerClass = {ExceptionUtil.class})</span><br><span class="line">    public void test() {</span><br><span class="line">        System.out.println("Test");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 原函数</span><br><span class="line">    @SentinelResource(value = "hello", blockHandler = "exceptionHandler", fallback = "helloFallback")</span><br><span class="line">    public String hello(long s) {</span><br><span class="line">        return String.format("Hello at %d", s);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    // Fallback 函数，函数签名与原函数一致或加一个 Throwable 类型的参数.</span><br><span class="line">    public String helloFallback(long s) {</span><br><span class="line">        return String.format("Halooooo %d", s);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // Block 异常处理函数，参数最后多一个 BlockException，其余与原函数一致.</span><br><span class="line">    public String exceptionHandler(long s, BlockException ex) {</span><br><span class="line">        // Do some log here.</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        return "Oops, error occurred at " + s;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>@SentinelResource</code> 注解的配置优先于自动识别的配置。这意味着，如果注解中定义了特定的限流或熔断策略，这些策略将覆盖默认的或自动识别的配置。</p>
<p><strong>推荐开发模式：优先使用适配包来自动识别资源，然后能运用注解尽量运用注解，最后再选择主动编码定义资源。</strong></p>
<p><strong>2）定义规则：</strong>支持通过代码、控制台（推荐）、配置文件来定义规则。</p>
<p>比如通过代码定义一个限流规则，更灵活：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private static void initFlowQpsRule() {</span><br><span class="line">    List&lt;FlowRule&gt; rules = new ArrayList&lt;&gt;();</span><br><span class="line">    FlowRule rule1 = new FlowRule();</span><br><span class="line">    rule1.setResource(resource);</span><br><span class="line">    // Set max qps to 20</span><br><span class="line">    rule1.setCount(20);</span><br><span class="line">    rule1.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    rule1.setLimitApp("default");</span><br><span class="line">    rules.add(rule1);</span><br><span class="line">    FlowRuleManager.loadRules(rules);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过控制台配置，更高效：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713120.png" alt="img"></p>
<p><strong>一般推荐使用控制台来配置规则，但如果希望开发者更快启动和学习项目，可以通过编码定义规则，这样不用搭建控制台、而且每次启动项目都会确保规则被创建。</strong></p>
<h4 id="8、其他特性"><a href="#8、其他特性" class="headerlink" title="8、其他特性"></a>8、其他特性</h4><p>除了限流外，Sentinel 还提供了多种规则，都可以通过官方文档来了解。</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/circuit-breaking.html">熔断降级</a>：用于实现熔断降级的规则，当某个资源的异常比例或响应时间超过阈值时，触发熔断，短时间内不再访问该资源。</li>
<li><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/system-adaptive-protection.html">系统自适应保护</a>：根据系统的整体负载（如 CPU 使用率、内存使用率等）进行保护，适合在系统级别进行流量控制。</li>
<li><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html">热点参数限流</a>：用于限制某个方法的某些热点参数的访问频率，避免某些参数导致流量过大。</li>
<li><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/origin-authority-control.html">来源访问控制</a>：用于定义黑白名单的授权规则，控制资源访问的权限。</li>
</ol>
<p>接下来，我们通过本项目的需求实现，带大家实战 Sentinel 开发。</p>
<h3 id="后端开发（Sentinel-实战）"><a href="#后端开发（Sentinel-实战）" class="headerlink" title="后端开发（Sentinel 实战）"></a>后端开发（Sentinel 实战）</h3><h4 id="1、查看题库列表接口限流熔断-1"><a href="#1、查看题库列表接口限流熔断-1" class="headerlink" title="1、查看题库列表接口限流熔断"></a>1、查看题库列表接口限流熔断</h4><p>资源：listQuestionBankVOByPage 接口</p>
<p>目的：控制对耗时较长的、经常访问的接口的请求频率，防止过多请求导致系统过载。</p>
<p>限流规则：</p>
<ul>
<li>策略：整个接口每秒钟不超过 10 次请求</li>
<li>阻塞操作：提示“系统压力过大，请耐心等待”</li>
</ul>
<p>熔断规则：</p>
<ul>
<li>熔断条件：如果接口异常率超过 10%，或者慢调用（响应时长 &gt; 3 秒）的比例大于 20%，触发 60 秒熔断。</li>
<li>熔断操作：直接返回本地数据（缓存或空数据）</li>
</ul>
<p><strong>开发模式：用注解定义资源 + 基于控制台定义规则</strong></p>
<p>1）定义资源。给需要限流的接口添加 @SentinelResource 注解：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping("/list/page/vo")</span><br><span class="line">@SentinelResource(value = "listQuestionBankVOByPage",</span><br><span class="line">        blockHandler = "handleBlockException",</span><br><span class="line">        fallback = "handleFallback")</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionBankVO&gt;&gt; listQuestionBankVOByPage(</span><br><span class="line">    @RequestBody QuestionBankQueryRequest questionBankQueryRequest,</span><br><span class="line">    HttpServletRequest request) {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>定义阻塞异常要多加一个BlockException 参数，其余参数与原接口一致，定义降级操作要多一个 Throwable 参数，其余也和原接口一样，注意两个方法名称要与注解定义的名称一致</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * listQuestionBankVoByPage 流程操作</span><br><span class="line"> * 限流：提示“系统压力过大，请耐心等待”</span><br><span class="line"> */</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionBankVO&gt;&gt; handleBlockException(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,</span><br><span class="line">                                                               HttpServletRequest request, BlockException ex) {</span><br><span class="line">    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "系统压力过大，请耐心等待");</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * listQuestionBankVoByPage 降级操作：直接返回本地数据</span><br><span class="line"> */</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionBankVO&gt;&gt; handleFallback(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,</span><br><span class="line">                                                         HttpServletRequest request, Throwable ex) {</span><br><span class="line">    return ResultUtils.success(null);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>BlockException 处理时所有限流和所有熔断之后的降级异常，而 Fallback 处理的是所有的业务异常</p>
</blockquote>
<p>启动项目成功并且访问接口后，可以在控制台看到刚定义的资源：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713164.png" alt="img"></p>
<p>2）实现限流阻塞和熔断降级方法。注意遵循 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/annotation-support.html">官方文档的方法定义规则</a>：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713182.png" alt="img"></p>
<p>为了实现方便，尽快验证效果，我们先在接口相同的 Controller 中编写限流阻塞和降级方法：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * listQuestionBankVOByPage 降级操作：直接返回本地数据</span><br><span class="line"> */</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionBankVO&gt;&gt; handleFallback(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,</span><br><span class="line">                                                         HttpServletRequest request, Throwable ex) {</span><br><span class="line">    // 可以返回本地数据或空数据</span><br><span class="line">    return ResultUtils.success(null);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * listQuestionBankVOByPage 流控操作</span><br><span class="line"> * 限流：提示“系统压力过大，请耐心等待”</span><br><span class="line"> */</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionBankVO&gt;&gt; handleBlockException(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,</span><br><span class="line">                                                               HttpServletRequest request, BlockException ex) {</span><br><span class="line">    // 限流操作</span><br><span class="line">    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "系统压力过大，请耐心等待");</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3）通过控制台定义规则</p>
<p>限流规则：根据需求配置即可</p>
<p><img src="https://pic.yupi.icu/1285/202409131713648.png" alt="img"></p>
<p><img src="https://pic.yupi.icu/1285/202409131713692.png" alt="img"></p>
<p>熔断规则：新增两条熔断规则，注意设置最小请求数、统计时长</p>
<p><img src="https://pic.yupi.icu/1285/202409131713708.png" alt="img"></p>
<p><img src="https://pic.yupi.icu/1285/202409131713727.png" alt="img"></p>
<p>4）测试</p>
<p>为便于测试，可以先将限流熔断规则调整到容易触发的值，然后通过接口文档测试调用，查看效果。</p>
<p>连续快速发送多次请求，触发限流，执行了 <code>blockHandler</code> 处理器的逻辑：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713779.png" alt="img"></p>
<p>注意，只有业务异常（比如请求参数错误、或者数据库操作失败等问题），才会算到熔断条件中，限流熔断本身的异常 BlockException 是不计算的。</p>
<p>测试熔断的时候，可以故意给 sortField 请求参数传一个不存在的字段，触发业务异常。可以尝试下熔断的触发和恢复：</p>
<ol>
<li>先通过传错业务参数触发异常，导致熔断</li>
<li>等待熔断结束后，再触发一次异常，还会继续熔断</li>
<li>过一段时间，再触发一次正常请求，则熔断解除</li>
</ol>
<p>测试发现，任何业务异常（不仅仅是被熔断了），都会触发 <code>fallbackHandler</code>，该方法可作为一个通用的降级逻辑处理器。</p>
<p>测试发现，如果 <code>blockHandler</code> 和 <code>fallbackHandler</code> 同时配置，当熔断器打开后，仍然会进入 <code>blockHandler</code> 进行处理，因此需要在该方法中处理因为熔断触发的降级逻辑：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * listQuestionBankVOByPage 流控操作</span><br><span class="line"> * 限流：提示“系统压力过大，请耐心等待”</span><br><span class="line"> * 熔断：执行降级操作</span><br><span class="line"> */</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionBankVO&gt;&gt; handleBlockException(@RequestBody QuestionBankQueryRequest questionBankQueryRequest,</span><br><span class="line">                                                               HttpServletRequest request, BlockException ex) {</span><br><span class="line">    // 降级操作</span><br><span class="line">    if (ex instanceof DegradeException) {</span><br><span class="line">        return handleFallback(questionBankQueryRequest, request, ex);</span><br><span class="line">    }</span><br><span class="line">    // 限流操作</span><br><span class="line">    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "系统压力过大，请耐心等待");</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Sentinel 的 <code>blockHandler</code> 处理的是<code>BlockException</code>，该异常表示系统受到流量控制限制（如限流或熔断），这些不是业务逻辑中的异常，因此 <code>fallback</code> 不会处理这些异常。如果不配置 <code>blockHandler</code>，才会在熔断时，进入到 <code>fallbackHandler</code> 中进行兜底。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713830.png" alt="img"></p>
<p>总结一下：</p>
<ul>
<li><code>blockHandler</code> 处理 Sentinel 流量控制异常，如 <code>BlockException</code>。</li>
<li><code>fallback</code> 处理业务逻辑中的异常，比如我们自己的 <code>BusinessException</code>。</li>
</ul>
<p>可以根据自己的实际情况配置。</p>
<h4 id="2、单-IP-查看题目列表限流熔断-1"><a href="#2、单-IP-查看题目列表限流熔断-1" class="headerlink" title="2、单 IP 查看题目列表限流熔断"></a><strong>2、单 IP 查看题目列表限流熔断</strong></h4><p>资源：listQuestionVoByPage 接口</p>
<p>限流规则：</p>
<ul>
<li>策略：每个 IP 地址每分钟允许查看题目列表的次数不能超过 60 次。</li>
<li>阻塞操作：提示“访问过于频繁，请稍后再试”</li>
</ul>
<p>熔断规则：</p>
<ul>
<li>熔断条件：如果接口异常率超过 10%，或者慢调用（响应时长 &gt; 3 秒）的比例大于 20%，触发 60 秒熔断。</li>
<li>熔断操作：直接返回本地数据（缓存或空数据）</li>
</ul>
<p>由于需要针对每个用户进一步精细化限流，而不是整体接口限流，可以采用 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html">热点参数限流机制</a>，允许根据参数控制限流触发条件。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713355.png" alt="img"></p>
<p>对于我们的需求，可以将 IP 地址作为热点参数。</p>
<p>1）定义资源</p>
<p>对于 <code>@SentinelResource</code> 注解方式定义的资源，若注解作用的方法上有参数，Sentinel 会将它们作为参数传入 <code>SphU.entry(res, args)</code>。比如以下的方法里面 <code>uid</code> 和 <code>type</code> 会分别作为第一个和第二个参数传入 Sentinel API，从而可以用于热点规则判断：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SentinelResource("myMethod")</span><br><span class="line">public Result doSomething(String uid, int type) {</span><br><span class="line">  // some logic here...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>由于 Controller 接口参数较杂乱，使用编程式定义资源的方法。</p>
<p>💡 这里建议新写一个接口，不要污染原有接口，等测试稳定后，再进行切换。</p>
<p>代码如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 基于 IP 限流</span><br><span class="line">String remoteAddr = request.getRemoteAddr();</span><br><span class="line">Entry entry = null;</span><br><span class="line">try  {</span><br><span class="line">    entry = SphU.entry("listQuestionVOByPage", EntryType.IN, 1, remoteAddr);</span><br><span class="line">    // 被保护的业务逻辑</span><br><span class="line">    // 查询数据库</span><br><span class="line">    Page&lt;Question&gt; questionPage = questionService.listQuestionByPage(questionQueryRequest);</span><br><span class="line">    // 获取封装类</span><br><span class="line">    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));</span><br><span class="line">} catch (BlockException ex) {</span><br><span class="line">    // 资源访问阻止，被限流或被降级</span><br><span class="line">    if (ex instanceof DegradeException) {</span><br><span class="line">        return handleFallback(questionQueryRequest, request, ex);</span><br><span class="line">    }</span><br><span class="line">    // 限流操作</span><br><span class="line">    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "访问过于频繁，请稍后再试");</span><br><span class="line">} finally {</span><br><span class="line">    if (entry != null) {</span><br><span class="line">        entry.exit(1, remoteAddr);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>💡需要特别注意！</p>
<ol>
<li>若 entry 的时候传入了热点参数，那么 exit 的时候也一定要带上对应的参数（<code>exit(count, args)</code>），否则可能会有统计错误。<strong>这个时候不能使用 try-with-resources 的方式。</strong></li>
<li><code>SphU.entry(xxx)</code> 需要与 <code>entry.exit()</code> 方法成对出现，匹配调用，否则会导致调用链记录异常，抛出 <code>ErrorEntryFreeException</code> 异常。</li>
</ol>
<p><strong>注意 Sentinel 的降级仅针对业务异常，对 Sentinel 限流降级本身的异常 <code>BlockException</code> 不生效。为了统计异常比例或异常数，需要手动通过 <code>Tracer.trace(ex)</code> 记录业务异常。示例：</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Entry entry = null;</span><br><span class="line">try {</span><br><span class="line">  entry = SphU.entry(resource);</span><br><span class="line"></span><br><span class="line">  // Write your biz code here.</span><br><span class="line">  // &lt;&lt;BIZ CODE&gt;&gt;</span><br><span class="line">} catch (Throwable t) {</span><br><span class="line">  if (!BlockException.isBlockException(t)) {</span><br><span class="line">    Tracer.trace(t);</span><br><span class="line">  }</span><br><span class="line">} finally {</span><br><span class="line">  if (entry != null) {</span><br><span class="line">    entry.exit();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，通过 <code>Tracer.trace(ex)</code> 来统计异常信息时，由于 try-with-resources 语法中 catch 调用顺序的问题，会导致无法正确统计异常数，因此统计异常信息时也不能在 try-with-resources 的 catch 块中调用 <code>Tracer.trace(ex)</code>。</p>
<p>💡 为什么上一个需求中，我们不用手动调用 Tracer 上报异常呢？因为使用 Sentinel 的开源整合模块，如 Sentinel Dubbo Adapter, Sentinel Web Servlet Filter 或 <code>@SentinelResource</code> 注解会自动统计业务异常，无需手动调用。</p>
<p>需要给我们的资源定义增加异常统计代码：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">catch (Throwable ex) {</span><br><span class="line">    // 业务异常</span><br><span class="line">    if (!BlockException.isBlockException(ex)) {</span><br><span class="line">        Tracer.trace(ex);</span><br><span class="line">        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "系统错误");</span><br><span class="line">    }</span><br><span class="line">    // 降级操作</span><br><span class="line">    if (ex instanceof DegradeException) {</span><br><span class="line">        return handleFallback(questionQueryRequest, request, ex);</span><br><span class="line">    }</span><br><span class="line">    // 限流操作</span><br><span class="line">    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "访问过于频繁，请稍后再试");</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>2）编写阻塞和降级操作代码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">try {</span><br><span class="line">    entry = SphU.entry("listQuestionVOByPage", EntryType.IN, 1, remoteAddr);</span><br><span class="line">    // 被保护的业务逻辑</span><br><span class="line">    // 查询数据库</span><br><span class="line">    Page&lt;Question&gt; questionPage = questionService.listQuestionByPage(questionQueryRequest);</span><br><span class="line">    // 获取封装类</span><br><span class="line">    return ResultUtils.success(questionService.getQuestionVOPage(questionPage, request));</span><br><span class="line">} catch (Throwable ex) {</span><br><span class="line">    // 业务异常</span><br><span class="line">    if (!BlockException.isBlockException(ex)) {</span><br><span class="line">        Tracer.trace(ex);</span><br><span class="line">        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "系统错误");</span><br><span class="line">    }</span><br><span class="line">    // 降级操作</span><br><span class="line">    if (ex instanceof DegradeException) {</span><br><span class="line">        return handleFallback(questionQueryRequest, request, ex);</span><br><span class="line">    }</span><br><span class="line">    // 限流操作</span><br><span class="line">    return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "访问过于频繁，请稍后再试");</span><br><span class="line">} finally {</span><br><span class="line">    if (entry != null) {</span><br><span class="line">        entry.exit(1, remoteAddr);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * listQuestionVOByPage 降级操作：直接返回本地数据</span><br><span class="line"> */</span><br><span class="line">public BaseResponse&lt;Page&lt;QuestionVO&gt;&gt; handleFallback(QuestionQueryRequest questionQueryRequest,</span><br><span class="line">                                                         HttpServletRequest request, Throwable ex) {</span><br><span class="line">    // 可以返回本地数据或空数据</span><br><span class="line">    return ResultUtils.success(null);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>3）通过编码方式定义规则。可以新建 <code>sentinel</code> 包并定义一个单独的 Manager 作为 Bean，利用 @PostConstruct 注解，在 Bean 加载后创建规则。代码如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class SentinelRulesManager {</span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void initRules() {</span><br><span class="line">        initFlowRules();</span><br><span class="line">        initDegradeRules();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 限流规则</span><br><span class="line">    public void initFlowRules() {</span><br><span class="line">        // 单 IP 查看题目列表限流规则</span><br><span class="line">        ParamFlowRule rule = new ParamFlowRule("listQuestionVOByPage")</span><br><span class="line">                .setParamIdx(0) // 对第 0 个参数限流，即 IP 地址</span><br><span class="line">                .setCount(60) // 每分钟最多 60 次</span><br><span class="line">                .setDurationInSec(60); // 规则的统计周期为 60 秒</span><br><span class="line">        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 降级规则</span><br><span class="line">    public void initDegradeRules() {</span><br><span class="line">        // 单 IP 查看题目列表熔断规则</span><br><span class="line">        DegradeRule slowCallRule = new DegradeRule("listQuestionVOByPage")</span><br><span class="line">                .setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType())</span><br><span class="line">                .setCount(0.2) // 慢调用比例大于 20%</span><br><span class="line">                .setTimeWindow(60) // 熔断持续时间 60 秒</span><br><span class="line">                .setStatIntervalMs(30 * 1000) // 统计时长 30 秒</span><br><span class="line">                .setMinRequestAmount(10) // 最小请求数</span><br><span class="line">                .setSlowRatioThreshold(3); // 响应时间超过 3 秒</span><br><span class="line"></span><br><span class="line">        DegradeRule errorRateRule = new DegradeRule("listQuestionVOByPage")</span><br><span class="line">                .setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType())</span><br><span class="line">                .setCount(0.1) // 异常率大于 10%</span><br><span class="line">                .setTimeWindow(60) // 熔断持续时间 60 秒</span><br><span class="line">                .setStatIntervalMs(30 * 1000) // 统计时长 30 秒</span><br><span class="line">                .setMinRequestAmount(10); // 最小请求数</span><br><span class="line"></span><br><span class="line">        // 加载规则</span><br><span class="line">        DegradeRuleManager.loadRules(Arrays.asList(slowCallRule, errorRateRule));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>4）测试</p>
<p>启动项目就能看到规则：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713487.png" alt="img"></p>
<p>为了测试方便，可以先将规则的阈值调整小一点，然后通过接口文档验证效果。</p>
<p>限流效果：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713613.png" alt="img"></p>
<p>测试降级效果的时候，可以故意将 sortField 传一个不存在的字段。效果如图，触发了 DegradeException：</p>
<p><img src="https://pic.yupi.icu/1285/202409131713637.png" alt="img"></p>
<blockquote>
<p>Sentinel 的 熔断器恢复时是出于半开状态的，如果刚解除封印会根据第一次请求是否异常来判断是否开闭，如果无异常就恢复，否则继续出于关的状态。</p>
</blockquote>
<h3 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h3><h4 id="1、仅对部分-URL-进行统计（性能优化）"><a href="#1、仅对部分-URL-进行统计（性能优化）" class="headerlink" title="1、仅对部分 URL 进行统计（性能优化）"></a>1、仅对部分 URL 进行统计（性能优化）</h4><p>参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#%E9%85%8D%E7%BD%AE">https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#%E9%85%8D%E7%BD%AE</a>‘</p>
<p>可以修改监听的 URL 规则配置：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.sentinel.filter.url-patterns=/*</span><br></pre></td></tr></tbody></table></figure>

<h4 id="2、规则配置本地持久化"><a href="#2、规则配置本地持久化" class="headerlink" title="2、规则配置本地持久化"></a>2、规则配置本地持久化</h4><p>参考官方文档的配置：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html">https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html</a></p>
<p>官方提供了 Demo，可以用文件来本地持久化配置，这样重启项目后配置就不会丢失了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-dynamic-file-rule/src/main/java/com/alibaba/csp/sentinel/demo/file/rule/FileDataSourceInit.java">读写本地文件 Demo</a>（先看这个）</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-dynamic-file-rule/src/main/java/com/alibaba/csp/sentinel/demo/file/rule/FileDataSourceDemo.java">读本地文件 Demo</a></li>
</ul>
<p><img src="https://pic.yupi.icu/1285/202409131713649.png" alt="img"></p>
<p>示例代码如下，可以在 SentinelManager 的初始化逻辑中调用：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 持久化配置为本地文件</span><br><span class="line"> */</span><br><span class="line">public void listenRules() throws Exception {</span><br><span class="line">    // 获取项目根目录</span><br><span class="line">    String rootPath = System.getProperty("user.dir");</span><br><span class="line">    // sentinel 目录路径</span><br><span class="line">    File sentinelDir = new File(rootPath, "sentinel");</span><br><span class="line">    // 目录不存在则创建</span><br><span class="line">    if (!FileUtil.exist(sentinelDir)) {</span><br><span class="line">        FileUtil.mkdir(sentinelDir);</span><br><span class="line">    }</span><br><span class="line">    // 规则文件路径</span><br><span class="line">    String flowRulePath = new File(sentinelDir, "FlowRule.json").getAbsolutePath();</span><br><span class="line">    String degradeRulePath = new File(sentinelDir, "DegradeRule.json").getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    // Data source for FlowRule</span><br><span class="line">    ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleDataSource = new FileRefreshableDataSource&lt;&gt;(flowRulePath, flowRuleListParser);</span><br><span class="line">    // Register to flow rule manager.</span><br><span class="line">    FlowRuleManager.register2Property(flowRuleDataSource.getProperty());</span><br><span class="line">    WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowWds = new FileWritableDataSource&lt;&gt;(flowRulePath, this::encodeJson);</span><br><span class="line">    // Register to writable data source registry so that rules can be updated to file</span><br><span class="line">    WritableDataSourceRegistry.registerFlowDataSource(flowWds);</span><br><span class="line"></span><br><span class="line">    // Data source for DegradeRule</span><br><span class="line">    FileRefreshableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleDataSource</span><br><span class="line">            = new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">            degradeRulePath, degradeRuleListParser);</span><br><span class="line">    DegradeRuleManager.register2Property(degradeRuleDataSource.getProperty());</span><br><span class="line">    WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeWds = new FileWritableDataSource&lt;&gt;(degradeRulePath, this::encodeJson);</span><br><span class="line">    // Register to writable data source registry so that rules can be updated to file</span><br><span class="line">    WritableDataSourceRegistry.registerDegradeDataSource(degradeWds);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">private Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser = source -&gt; JSON.parseObject(source,</span><br><span class="line">        new TypeReference&lt;List&lt;FlowRule&gt;&gt;() {</span><br><span class="line">        });</span><br><span class="line">private Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser = source -&gt; JSON.parseObject(source,</span><br><span class="line">        new TypeReference&lt;List&lt;DegradeRule&gt;&gt;() {</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">private &lt;T&gt; String encodeJson(T t) {</span><br><span class="line">    return JSON.toJSONString(t);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后可以测试读写效果。</p>
<h4 id="3、代码组织结构优化"><a href="#3、代码组织结构优化" class="headerlink" title="3、代码组织结构优化"></a>3、代码组织结构优化</h4><p>限流阻塞和降级方法可以单独抽成独立的类，Sentinel 的资源名称也可以单独定义为常量，统一放到 sentinel 包中，更模块化。</p>
<p>常量类：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Sentinel 限流熔断常量</span><br><span class="line"> */</span><br><span class="line">public interface SentinelConstant {</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 分页获取题库列表接口限流</span><br><span class="line">     */</span><br><span class="line">    String listQuestionBankVOByPage = "listQuestionBankVOByPage";</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 分页获取题目列表接口限流</span><br><span class="line">     */</span><br><span class="line">    String listQuestionVOByPage = "listQuestionVOByPage";</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4、封装限流组件为-Spring-Boot-Starter"><a href="#4、封装限流组件为-Spring-Boot-Starter" class="headerlink" title="4、封装限流组件为 Spring Boot Starter"></a>4、封装限流组件为 Spring Boot Starter</h4><p>为了简化项目的配置和依赖管理，减少限流组件的接入成本，我们通过 Starter 封装限流组件，将多个相关的依赖打包成一个 Maven 依赖，用户只需引入一个依赖即可完成配置，而不需要手动引入每个模块的依赖。</p>
<p>1）创建一个 spring boot 项目</p>
<p>将无用的默认依赖都移除，例如默认的配置文件、启动文件、test 相关等。</p>
<p>2）引入需要的依赖。完整 pom 文件如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">xml复制代码&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span><br><span class="line">         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.7.2&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.yupi&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;limit-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;limit-spring-boot-starter&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;limit-spring-boot-starter&lt;/description&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;sentinel-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;sentinel-transport-simple-http&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;sentinel-annotation-aspectj&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;sentinel-parameter-flow-control&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>3）创建配置文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">java复制代码@ConfigurationProperties(prefix = "spring")</span><br><span class="line">public class LimitProperties {</span><br><span class="line">    private String sentinelDashboard;</span><br><span class="line">    private List&lt;LimitRule&gt; limitRules;</span><br><span class="line"></span><br><span class="line">    public List&lt;LimitRule&gt; getLimitRules() {</span><br><span class="line">        return limitRules;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public void setLimitRules(List&lt;LimitRule&gt; limitRules) {</span><br><span class="line">        this.limitRules = limitRules;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public String getSentinelDashboard() {</span><br><span class="line">        return sentinelDashboard;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public void setSentinelDashboard(String sentinelDashboard) {</span><br><span class="line">        this.sentinelDashboard = sentinelDashboard;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static class LimitRule {</span><br><span class="line">        private String resource;</span><br><span class="line">        private int grade;</span><br><span class="line">        private int count;</span><br><span class="line"></span><br><span class="line">        public String getResource() {</span><br><span class="line">            return resource;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public void setResource(String resource) {</span><br><span class="line">            this.resource = resource;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public int getGrade() {</span><br><span class="line">            return grade;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public void setGrade(int grade) {</span><br><span class="line">            this.grade = grade;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public int getCount() {</span><br><span class="line">            return count;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        public void setCount(int count) {</span><br><span class="line">            this.count = count;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>4）创建自动配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">java复制代码<span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(LimitProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LimitAutoConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LimitProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> SentinelResourceAspect <span class="title function_">sentinelResourceAspect</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SentinelResourceAspect</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initLimit</span><span class="params">()</span> {</span><br><span class="line">        initDefaultRule();</span><br><span class="line">        initDashboard();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDefaultRule</span><span class="params">()</span> {</span><br><span class="line">        List&lt;LimitProperties.LimitRule&gt; limitRules = properties.getLimitRules();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(limitRules)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        List&lt;FlowRule&gt; rules = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (LimitProperties.LimitRule limitRule : limitRules) {</span><br><span class="line">            <span class="type">FlowRule</span> <span class="variable">rule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlowRule</span>();</span><br><span class="line">            rule.setResource(limitRule.getResource());</span><br><span class="line">            rule.setGrade(limitRule.getGrade());</span><br><span class="line">            rule.setCount(limitRule.getCount());</span><br><span class="line">            rules.add(rule);</span><br><span class="line">        }</span><br><span class="line">        FlowRuleManager.loadRules(rules);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDashboard</span><span class="params">()</span> {</span><br><span class="line">        SentinelConfig.setConfig(<span class="string">"csp.sentinel.dashboard.server"</span>, properties.getSentinelDashboard());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>5）创建 spring.factories 文件。</p>
<p>在 src/main/resources/META-INF 目录下创建 spring.factories 文件，并在其中定义自动配置类。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713667.png" alt="img"></p>
<p>文件内容：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plain复制代码org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  com.yupi.limitspringbootstarter.LimitAutoConfiguration</span><br></pre></td></tr></tbody></table></figure>

<p>6）本地 install</p>
<p><img src="https://pic.yupi.icu/1285/202409131713778.png" alt="img"></p>
<p>这样本地仓库就有了当前的 starter。</p>
<p>7）使用。后端项目引入此 starter：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xml复制代码  &lt;dependency&gt;</span><br><span class="line">      &lt;artifactId&gt;limit-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">      &lt;groupId&gt;com.yupi&lt;/groupId&gt;</span><br><span class="line">      &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>application.yml 文件中填写对应限流配置：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yaml复制代码spring:</span><br><span class="line">  # sentinel 控制台地址</span><br><span class="line">  sentinelDashboard: localhost:7878 </span><br><span class="line">  # 限流规则</span><br><span class="line">  limitRules:</span><br><span class="line">    - resource: "QuestionBank"</span><br><span class="line">      count: 5</span><br><span class="line">      grade: 1</span><br></pre></td></tr></tbody></table></figure>

<p>项目中同样还是使用 <code>@SentinelResource</code>注解，也可以通过控制台动态配置限流。</p>
<h3 id="自主扩展"><a href="#自主扩展" class="headerlink" title="自主扩展"></a>自主扩展</h3><p>1）自主实现 push 规则推送模式，定义自己的持久化规则</p>
<p>参考文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html%EF%BC%88%E7%BB%93%E5%B0%BE%E6%8F%90%E5%88%B0%EF%BC%89">https://sentinelguard.io/zh-cn/docs/basic-api-resource-rule.html（结尾提到）</a></li>
<li><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html">https://sentinelguard.io/zh-cn/docs/dynamic-rule-configuration.html</a></li>
</ul>
<p><img src="https://pic.yupi.icu/1285/202409131713258.png" alt="img"></p>
<p>2）自主实现更多限流功能，比如本文需求分析部分提到的用户登录和用户注册的保护</p>
<h2 id="动态-IP-黑名单过滤"><a href="#动态-IP-黑名单过滤" class="headerlink" title="动态 IP 黑名单过滤"></a>动态 IP 黑名单过滤</h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h3><p>一些恶意用户（可能是黑客、爬虫、DDoS 攻击者）可能频繁请求服务器资源，导致资源占用过高。因此我们需要一定的手段实时阻止可疑或恶意的用户，减少攻击风险。</p>
<p>通过 IP 封禁，可以有效拉黑攻击者，防止资源被滥用，保障合法用户的正常访问。</p>
<p>对于我们的需求，不让拉进黑名单的 IP 访问任何接口。</p>
<h3 id="方案设计-2"><a href="#方案设计-2" class="headerlink" title="方案设计"></a>方案设计</h3><h4 id="1、设计过程"><a href="#1、设计过程" class="headerlink" title="1、设计过程"></a>1、设计过程</h4><p>其实前面讲到的 Sentinel 本身就支持请求来源的 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E6%8E%A7%E5%88%B6">黑白名单判断</a>，但默认是对应用级别进行判断，需要改造来源的获取方式为获取请求客户端的 IP，可参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37128815/article/details/131942363">这篇文章</a> 自定义来源。</p>
<p>但其实引入 Sentinel 是需要一定成本的，本节主要分享更轻量的动态 IP 黑白名单过滤的常用设计和实现方法。</p>
<p>想要自主实现动态 IP 黑名单，主要考虑以下几点：</p>
<ol>
<li>IP 黑名单存储在哪里？</li>
<li>如何便捷地动态修改 IP 黑名单？</li>
<li>黑白名单的判断逻辑应在哪里处理？</li>
<li>使用何种数据结构保存黑名单？如何快速匹配用户请求的 IP 是否在黑名单中？</li>
</ol>
<p>下面分别设计：</p>
<p>1）IP 黑名单存储在哪里？</p>
<p>最简单的方式就是存储在内存中，但一般 IP 黑名单是动态增加的、需要持久化保存。常见的持久化方式包括数据库、配置文件或分布式存储系统（如 Redis），可以根据需要选择。</p>
<p>2）如何便捷地动态修改 IP 黑名单？</p>
<p>为了方便动态修改 IP 黑名单，通常会提供一个管理页面，供管理员进行增删改查操作。</p>
<p>许多企业会将配置统一放入 <strong>配置中心</strong>，通过配置中心的管理页面，开发人员可以便捷地动态修改黑名单规则。Java 项目中，常用的配置中心是 Nacos。</p>
<p>3）黑白名单的判断逻辑应在哪里处理？</p>
<p>黑白名单逻辑通常部署在高性能的网关或 CDN 上，<strong>能够更早地拦截非法请求</strong>，减轻后端压力。在小型项目中，也可以直接在应用程序的过滤器中处理。</p>
<p>4）使用何种结构保存黑名单？如何快速匹配？</p>
<p>为了高效判断每个用户请求的 IP 是否在黑名单中，首先建议将 IP 黑名单从持久化存储同步到本地缓存中，避免频繁查询远程数据源。对于黑名单数据较小的场景，可以使用简单的 <code>Set</code> 数据结构存储。而对于大规模黑名单，推荐使用 <strong>布隆过滤器或 DFA</strong> 来存储和过滤黑名单，可以节约内存空间、提高检测效率。</p>
<h4 id="2、最终方案"><a href="#2、最终方案" class="headerlink" title="2、最终方案"></a>2、最终方案</h4><p>总结一下最终方案：</p>
<p>1）使用 Nacos 配置中心存储和管理 IP 黑名单</p>
<p>2）后端服务利用 Web 过滤器判断每个用户请求的 IP</p>
<p>3）后端服务利用布隆过滤器过滤 IP 黑名单</p>
<h4 id="3、扩展知识-布隆过滤器"><a href="#3、扩展知识-布隆过滤器" class="headerlink" title="3、扩展知识 - 布隆过滤器"></a>3、扩展知识 - 布隆过滤器</h4><p>Bloom Filter 是一种高效的、基于概率的数据结构，用于判断一个元素是否存在于集合中。</p>
<p>原理是利用多个哈希函数将元素映射到固定的点位上（位数组中），因此面对海量数据它占据的空间也非常小。</p>
<p>例如某个 key 通过 hash-1 和 hash-2 两个哈希函数，定位到数组中的值都为 1，则说明它存在。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713296.png" alt="img"></p>
<p>如果布隆过滤器判断一个元素不存在集合中，那么这个元素一定不在集合中，如果判断元素存在集合中则不一定是真的，因为哈希可能会存在冲突。因此布隆过滤器 <strong>有误判的概率</strong> 。</p>
<p><img src="https://pic.yupi.icu/1285/202409131713737.png" alt="img"></p>
<p>而且它不好删除元素，只能新增，如果想要删除，只能重建。</p>
<p>显然，它的主要特点包括：</p>
<ol>
<li>空间效率高：相比于传统的数据结构（如哈希表），Bloom Filter 能用较少的空间存储大量的数据。</li>
<li>时间复杂度低：查询操作非常快速，通常是常数时间复杂度 <code>O(1)</code>。</li>
<li>允许误判：Bloom Filter 允许假阳性，即有时候会错误地判断某个元素在集合中，而实际该元素并不在集合中。不过，它不允许假阴性，也就是说，如果 Bloom Filter 判断某个元素不存在，那么它一定是不存在的。比如对于我们的需求，Bloom Filter <strong>可能错误地判断一个不在黑名单中的元素为在黑名单中</strong>，导致误封。</li>
</ol>
<p>Bloom Filter 的误判率与以下因素有关：</p>
<ul>
<li>位数组的大小：位数组越大，误判率越低，但空间开销会增大。（值会更离散）</li>
<li>哈希函数的个数：哈希函数越多，误判率越低，但计算成本会增加。（Hash 一次冲突，那我就多 Hash 几次，减少冲突概率）</li>
<li>元素数量：存入的元素越多，误判率会增加。</li>
</ul>
<p>通过 <strong>合理设计位数组的大小和哈希函数的个数</strong>，可以控制 Bloom Filter 的误判率在一个可接受的范围内。例如，在很多实际场景中，可以将误判率控制在 <strong>1%</strong> 或更低。</p>
<ul>
<li>假设场景 1：存储 1000 个元素，位数组大小为 10000 位，哈希函数数量为 7。误判率大约为 0.8%。</li>
<li>假设场景 2：存储 100000 个元素，位数组大小为 1,000,000 位，哈希函数数量为 7。误判率大约为 1%。</li>
<li>假设场景 3：存储 1,000,000 个元素，位数组大小为 10,000,000 位，哈希函数数量为 7。误判率大约为 1%。</li>
</ul>
<p>如果误判的代价较高，但仍想使用 Bloom Filter，可以采取一些补救措施：</p>
<ul>
<li>双层验证：在 Bloom Filter 判断元素在黑名单中后，进一步查验实际的黑名单（例如，查数据库中的黑名单详细记录）。</li>
<li>结合其他数据结构：可以使用 Bloom Filter 进行初步筛选，如果 Bloom Filter 判断为在黑名单中，再用哈希表等精确的数据结构进行最终确认。</li>
</ul>
<p>但这两种方式都无法处理攻击 IP 的大量请求，个人也不建议采用。</p>
<p>因此，布隆过滤器适用于对准确性要求不高的、大规模数据量匹配的场景，比如垃圾邮件过滤、爬虫 URL 去重、缓存穿透防护等。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">雪荷</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/09/06/%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/">http://example.com/2024/09/06/%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">雪荷的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/React/">React</a><a class="post-meta__tags" href="/tags/Next-js/">Next.js</a><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95%E7%8B%97/">面试狗</a></div><div class="post_share"><div class="social-share" data-image="/img/post_2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/21/JUC-%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JUC 面试题"><img class="cover" src="/img/post_1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JUC 面试题</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/12/Redisson-%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8/" title="Redisson 详细使用"><img class="cover" src="/img/post_1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redisson 详细使用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/07/26/EasyExcel-%E5%88%9D%E4%BD%BF%E7%94%A8%E2%80%94%E2%80%94-Java-%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%A7%8D%E5%86%99%E5%85%A5-Excel-%E5%8A%9F%E8%83%BD-CSDN%E5%8D%9A%E5%AE%A2/" title="EasyExcel 初使用—— Java 实现多种写入 Excel 功能-CSDN博客"><img class="cover" src="/img/post_2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-26</div><div class="title">EasyExcel 初使用—— Java 实现多种写入 Excel 功能-CSDN博客</div></div></a></div><div><a href="/2024/07/22/EasyExcel-%E5%88%9D%E4%BD%BF%E7%94%A8%E2%80%94%E2%80%94-Java-%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%8F%96-Excel-%E5%8A%9F%E8%83%BD/" title="EasyExcel 初使用—— Java 实现读取 Excel 功能"><img class="cover" src="/img/post_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-22</div><div class="title">EasyExcel 初使用—— Java 实现读取 Excel 功能</div></div></a></div><div><a href="/2024/09/22/JVM-%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JVM 面试题"><img class="cover" src="/img/post_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-22</div><div class="title">JVM 面试题</div></div></a></div><div><a href="/2024/07/02/Java%E4%BA%8C%E7%BA%A7/" title="Java二级"><img class="cover" src="/img/post_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-02</div><div class="title">Java二级</div></div></a></div><div><a href="/2024/07/02/Java%20%E5%85%AB%E8%82%A1%E6%96%87/" title="Java 八股文"><img class="cover" src="/img/post_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-02</div><div class="title">Java 八股文</div></div></a></div><div><a href="/2024/07/02/JUC%E7%AC%94%E8%AE%B0/" title="JUC笔记"><img class="cover" src="/img/post_2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-02</div><div class="title">JUC笔记</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/ava.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">雪荷</div><div class="author-info__description">热爱生活，热爱编程</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">面试狗 - interviewdog 项目笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">前端初始化配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Next-js-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83"><span class="toc-number">1.2.</span> <span class="toc-text">Next.js 开发规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%BA%A6%E5%AE%9A%E5%BC%8F%E8%B7%AF%E7%94%B1"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、约定式路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87%E5%BD%A2%E5%BC%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、文件组织形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E9%A1%B5%E9%9D%A2%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83"><span class="toc-number">1.2.4.</span> <span class="toc-text">4、页面开发规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%85%B6%E4%BB%96%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.2.5.</span> <span class="toc-text">5、其他注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%B8%87%E8%83%BD%E6%A8%A1%E6%9D%BF%E5%BC%80%E5%8F%91"><span class="toc-number">1.3.</span> <span class="toc-text">前端万能模板开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%80%9A%E7%94%A8%E5%B8%83%E5%B1%80"><span class="toc-number">1.3.1.</span> <span class="toc-text">全局通用布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%AF%B7%E6%B1%82%E5%BA%93"><span class="toc-number">1.3.2.</span> <span class="toc-text">安装请求库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.</span> <span class="toc-text">全局状态管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">全局权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.1.</span> <span class="toc-text">实现方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.2.</span> <span class="toc-text">开发实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6-Markdown-%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-number">1.6.</span> <span class="toc-text">通用组件 - Markdown 富文本编辑器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="toc-number">1.7.</span> <span class="toc-text">前端页面开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.7.1.</span> <span class="toc-text">1、用户登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.7.2.</span> <span class="toc-text">2、用户注册页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.7.3.</span> <span class="toc-text">3、用户管理页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-number">1.7.4.</span> <span class="toc-text">扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E9%A2%98%E7%9B%AE%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.7.5.</span> <span class="toc-text">4、题目管理页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E9%A1%B5%E9%9D%A2%E5%BC%80%E5%8F%91"><span class="toc-number">1.8.</span> <span class="toc-text">核心页面开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%A1%B5%E5%BC%80%E5%8F%91"><span class="toc-number">1.8.1.</span> <span class="toc-text">主页开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProTable-%E7%BB%84%E4%BB%B6"><span class="toc-number">1.8.2.</span> <span class="toc-text">ProTable 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E5%BA%93%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">1.8.3.</span> <span class="toc-text">题库详情页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">1.8.4.</span> <span class="toc-text">题目详情页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Form-%E7%BB%84%E4%BB%B6"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">Form 组件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%E6%97%A5%E5%8E%86"><span class="toc-number">1.8.5.</span> <span class="toc-text">用户刷题记录日历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.8.6.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.7.</span> <span class="toc-text">方案设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%96%B9%E6%A1%88"><span class="toc-number">1.8.8.</span> <span class="toc-text">前端方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91"><span class="toc-number">1.8.9.</span> <span class="toc-text">后端开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%B0%8F%E7%BB%93"><span class="toc-number">1.8.9.1.</span> <span class="toc-text">优化小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91"><span class="toc-number">1.8.10.</span> <span class="toc-text">前端开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95"><span class="toc-number">1.8.11.</span> <span class="toc-text">拓展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E9%A2%98%E7%9B%AE%E6%90%9C%E7%B4%A2"><span class="toc-number">1.9.</span> <span class="toc-text">分词题目搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%88ES-%E5%AE%9E%E6%88%98%EF%BC%89"><span class="toc-number">1.9.1.</span> <span class="toc-text">后端开发（ES 实战）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Elasticsearch-%E6%90%AD%E5%BB%BA"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">1、Elasticsearch 搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89%E5%AE%89%E8%A3%85-Elasticsearch%EF%BC%889200-%E7%AB%AF%E5%8F%A3%EF%BC%89"><span class="toc-number">1.9.1.1.1.</span> <span class="toc-text">1）安装 Elasticsearch（9200 端口）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%EF%BC%89%E5%AE%89%E8%A3%85-Kibana%EF%BC%885601-%E7%AB%AF%E5%8F%A3%EF%BC%89"><span class="toc-number">1.9.1.1.2.</span> <span class="toc-text">2）安装 Kibana（5601 端口）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.1.1.3.</span> <span class="toc-text">3）测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%EF%BC%89%E5%AE%89%E8%A3%85-IK-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88ES-%E6%8F%92%E4%BB%B6%EF%BC%89"><span class="toc-number">1.9.1.1.4.</span> <span class="toc-text">4）安装 IK 中文分词器（ES 插件）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%AE%BE%E8%AE%A1-ES-%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">2、设计 ES 索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%96%B0%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">3、新建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%BC%95%E5%85%A5-ES-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">4、引入 ES 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E7%BC%96%E5%86%99-ES-Dao-%E5%B1%82"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">5、编写 ES Dao 层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E5%A6%82%E4%BD%95%E5%90%91-ES-%E5%86%99%E5%85%A5%E5%85%A8%E9%87%8F%E6%95%B0%E6%8D%AE"><span class="toc-number">1.9.1.6.</span> <span class="toc-text">6、如何向 ES 写入全量数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81%E5%BC%80%E5%8F%91-ES-%E6%90%9C%E7%B4%A2"><span class="toc-number">1.9.1.7.</span> <span class="toc-text">7、开发 ES 搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E3%80%81%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.9.1.8.</span> <span class="toc-text">8、数据同步</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-1"><span class="toc-number">1.9.2.</span> <span class="toc-text">前端开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95-1"><span class="toc-number">1.9.3.</span> <span class="toc-text">拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%A0%B9%E6%8D%AE%E4%B8%9A%E5%8A%A1%E8%87%AA%E5%AE%9A%E4%B9%89-ES-%E8%AF%8D%E5%85%B8%EF%BC%8C%E6%8F%90%E9%AB%98%E5%88%86%E8%AF%8D%E5%87%86%E7%A1%AE%E5%BA%A6"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">1、根据业务自定义 ES 词典，提高分词准确度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8-ES-%E6%9F%A5%E8%AF%A2%E6%97%B6%EF%BC%8C%E5%85%B3%E8%81%94%E8%8E%B7%E5%8F%96%E9%A2%98%E7%9B%AE%E7%9A%84%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">2、使用 ES 查询时，关联获取题目的动态数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81ES-%E6%8E%A5%E5%8F%A3%E6%94%AF%E6%8C%81%E9%99%8D%E7%BA%A7"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">3、ES 接口支持降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.9.3.4.</span> <span class="toc-text">4、防止重复执行定时任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%89%B9%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.</span> <span class="toc-text">题目批量管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91"><span class="toc-number">1.10.1.</span> <span class="toc-text">基础后端开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-2"><span class="toc-number">1.10.2.</span> <span class="toc-text">前端开发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86%E6%93%8D%E4%BD%9C%E4%BC%98%E5%8C%96"><span class="toc-number">1.11.</span> <span class="toc-text">批处理操作优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%A5%E5%A3%AE%E6%80%A7"><span class="toc-number">1.11.1.</span> <span class="toc-text">健壮性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%B3%E5%AE%9A%E6%80%A7"><span class="toc-number">1.11.2.</span> <span class="toc-text">稳定性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.11.3.</span> <span class="toc-text">性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-Druid-%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">1.11.3.1.</span> <span class="toc-text">引入 Druid 连接池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Druid-%E7%9B%91%E6%8E%A7"><span class="toc-number">1.11.3.2.</span> <span class="toc-text">使用 Druid 监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.11.3.3.</span> <span class="toc-text">数据一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="toc-number">1.11.3.4.</span> <span class="toc-text">可观测性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%BC%93%E5%AD%98%E7%83%AD%E9%97%A8%E9%A2%98%E5%BA%93"><span class="toc-number">1.12.</span> <span class="toc-text">自动缓存热门题库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-number">1.12.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E7%83%AD%E7%82%B9%EF%BC%9F"><span class="toc-number">1.12.2.</span> <span class="toc-text">为什么需要自动发现热点？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1-1"><span class="toc-number">1.12.3.</span> <span class="toc-text">方案设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hotkey-%E5%85%A5%E9%97%A8"><span class="toc-number">1.12.4.</span> <span class="toc-text">hotkey 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">1.12.4.1.</span> <span class="toc-text">核心组件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%88hotkey-%E5%AE%9E%E6%88%98%EF%BC%89"><span class="toc-number">1.12.5.</span> <span class="toc-text">后端开发（hotkey 实战）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85-etcd"><span class="toc-number">1.12.5.1.</span> <span class="toc-text">1、安装 etcd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%AE%89%E8%A3%85-hotkey-worker"><span class="toc-number">1.12.5.2.</span> <span class="toc-text">2、安装 hotkey worker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%90%AF%E5%8A%A8-hotkey-%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">1.12.5.3.</span> <span class="toc-text">3、启动 hotkey 控制台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%BC%95%E5%85%A5-hotkey-client"><span class="toc-number">1.12.5.4.</span> <span class="toc-text">4、引入 hotkey client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E4%BA%86%E8%A7%A3%E5%BC%80%E5%8F%91%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.12.5.5.</span> <span class="toc-text">5、了解开发者模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E9%85%8D%E7%BD%AE-hotkey-%E8%A7%84%E5%88%99"><span class="toc-number">1.12.5.6.</span> <span class="toc-text">6、配置 hotkey 规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81%E9%A1%B9%E7%9B%AE%E5%BA%94%E7%94%A8-hotkey"><span class="toc-number">1.12.5.7.</span> <span class="toc-text">7、项目应用 hotkey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E3%80%81%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81"><span class="toc-number">1.12.5.8.</span> <span class="toc-text">8、测试验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E7%9F%A5%E8%AF%86"><span class="toc-number">1.12.6.</span> <span class="toc-text">拓展知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">1、如何更新本地缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%98%AF%E5%90%A6%E8%83%BD%E5%A4%9F%E5%92%8C-redis-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E7%BB%93%E5%90%88%EF%BC%9F"><span class="toc-number">1.12.6.2.</span> <span class="toc-text">2、是否能够和 redis 分布式缓存结合？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E7%83%AD-key-%E4%BC%9A%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F%E4%B9%88%EF%BC%9F%E5%90%A6%E5%88%99%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.12.6.3.</span> <span class="toc-text">3、热 key 会自动续期么？否则可能出现缓存雪崩的问题？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95-1"><span class="toc-number">1.12.7.</span> <span class="toc-text">扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%AE%89%E5%85%A8%E6%80%A7%E4%BC%98%E5%8C%96"><span class="toc-number">1.13.</span> <span class="toc-text">流量安全性优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E5%92%8C%E7%86%94%E6%96%AD"><span class="toc-number">1.13.1.</span> <span class="toc-text">网站流量控制和熔断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.13.2.</span> <span class="toc-text">核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.13.2.1.</span> <span class="toc-text">1、流量控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="toc-number">1.13.2.2.</span> <span class="toc-text">2、熔断机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E9%99%8D%E7%BA%A7%E6%9C%BA%E5%88%B6"><span class="toc-number">1.13.2.3.</span> <span class="toc-text">3、降级机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E7%86%94%E6%96%AD%E5%92%8C%E9%99%8D%E7%BA%A7%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.13.2.4.</span> <span class="toc-text">4、熔断和降级的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86-%E6%9C%89%E6%8D%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.13.2.5.</span> <span class="toc-text">扩展知识 - 有损服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%EF%BC%88%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99%EF%BC%89"><span class="toc-number">1.13.3.</span> <span class="toc-text">需求分析（限流熔断规则）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%9F%A5%E7%9C%8B%E9%A2%98%E5%BA%93%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD"><span class="toc-number">1.13.3.1.</span> <span class="toc-text">1、查看题库列表接口限流熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%8D%95-IP-%E6%9F%A5%E7%9C%8B%E9%A2%98%E7%9B%AE%E5%88%97%E8%A1%A8%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD"><span class="toc-number">1.13.3.2.</span> <span class="toc-text">2、单 IP 查看题目列表限流熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86-%E6%9B%B4%E5%A4%9A%E8%A7%84%E5%88%99"><span class="toc-number">1.13.3.3.</span> <span class="toc-text">扩展知识 - 更多规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%EF%BC%88%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%EF%BC%89"><span class="toc-number">1.13.4.</span> <span class="toc-text">实现方案（技术选型）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Sentinel"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">1、Sentinel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Hystrix"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">2、Hystrix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81Resilience4j"><span class="toc-number">1.13.4.3.</span> <span class="toc-text">3、Resilience4j</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81Guava-RateLimiter"><span class="toc-number">1.13.4.4.</span> <span class="toc-text">4、Guava RateLimiter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81Redisson-RRateLimiter"><span class="toc-number">1.13.4.5.</span> <span class="toc-text">5、Redisson RRateLimiter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E5%9E%8B%E7%AD%96%E7%95%A5"><span class="toc-number">1.13.4.6.</span> <span class="toc-text">选型策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel-%E5%85%A5%E9%97%A8"><span class="toc-number">1.13.5.</span> <span class="toc-text">Sentinel 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.13.5.1.</span> <span class="toc-text">1、核心概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.13.5.2.</span> <span class="toc-text">2、架构设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81Sentinel-%E5%85%A5%E9%97%A8-Demo"><span class="toc-number">1.13.5.3.</span> <span class="toc-text">3、Sentinel 入门 Demo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%90%AF%E5%8A%A8-Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">1.13.5.4.</span> <span class="toc-text">4、下载并启动 Sentinel 控制台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86%E5%92%8C%E6%8E%A8%E9%80%81"><span class="toc-number">1.13.5.5.</span> <span class="toc-text">5、规则管理和推送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E6%95%B4%E5%90%88-Spring-Boot"><span class="toc-number">1.13.5.6.</span> <span class="toc-text">6、整合 Spring Boot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.13.5.7.</span> <span class="toc-text">7、开发模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E3%80%81%E5%85%B6%E4%BB%96%E7%89%B9%E6%80%A7"><span class="toc-number">1.13.5.8.</span> <span class="toc-text">8、其他特性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%88Sentinel-%E5%AE%9E%E6%88%98%EF%BC%89"><span class="toc-number">1.13.6.</span> <span class="toc-text">后端开发（Sentinel 实战）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%9F%A5%E7%9C%8B%E9%A2%98%E5%BA%93%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD-1"><span class="toc-number">1.13.6.1.</span> <span class="toc-text">1、查看题库列表接口限流熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%8D%95-IP-%E6%9F%A5%E7%9C%8B%E9%A2%98%E7%9B%AE%E5%88%97%E8%A1%A8%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD-1"><span class="toc-number">1.13.6.2.</span> <span class="toc-text">2、单 IP 查看题目列表限流熔断</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86"><span class="toc-number">1.13.7.</span> <span class="toc-text">扩展知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%BB%85%E5%AF%B9%E9%83%A8%E5%88%86-URL-%E8%BF%9B%E8%A1%8C%E7%BB%9F%E8%AE%A1%EF%BC%88%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%89"><span class="toc-number">1.13.7.1.</span> <span class="toc-text">1、仅对部分 URL 进行统计（性能优化）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.13.7.2.</span> <span class="toc-text">2、规则配置本地持久化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.13.7.3.</span> <span class="toc-text">3、代码组织结构优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%B0%81%E8%A3%85%E9%99%90%E6%B5%81%E7%BB%84%E4%BB%B6%E4%B8%BA-Spring-Boot-Starter"><span class="toc-number">1.13.7.4.</span> <span class="toc-text">4、封装限流组件为 Spring Boot Starter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E4%B8%BB%E6%89%A9%E5%B1%95"><span class="toc-number">1.13.8.</span> <span class="toc-text">自主扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81-IP-%E9%BB%91%E5%90%8D%E5%8D%95%E8%BF%87%E6%BB%A4"><span class="toc-number">1.14.</span> <span class="toc-text">动态 IP 黑名单过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="toc-number">1.14.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1-2"><span class="toc-number">1.14.2.</span> <span class="toc-text">方案设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%AE%BE%E8%AE%A1%E8%BF%87%E7%A8%8B"><span class="toc-number">1.14.2.1.</span> <span class="toc-text">1、设计过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%9C%80%E7%BB%88%E6%96%B9%E6%A1%88"><span class="toc-number">1.14.2.2.</span> <span class="toc-text">2、最终方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.14.2.3.</span> <span class="toc-text">3、扩展知识 - 布隆过滤器</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/22/JVM-%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JVM 面试题"><img src="/img/post_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JVM 面试题"></a><div class="content"><a class="title" href="/2024/09/22/JVM-%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JVM 面试题">JVM 面试题</a><time datetime="2024-09-22T14:42:32.000Z" title="发表于 2024-09-22 22:42:32">2024-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/21/JUC-%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JUC 面试题"><img src="/img/post_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JUC 面试题"></a><div class="content"><a class="title" href="/2024/09/21/JUC-%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JUC 面试题">JUC 面试题</a><time datetime="2024-09-21T14:02:31.000Z" title="发表于 2024-09-21 22:02:31">2024-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/06/%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" title="面试狗 - interviewdog 项目笔记"><img src="/img/post_2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试狗 - interviewdog 项目笔记"></a><div class="content"><a class="title" href="/2024/09/06/%E9%9D%A2%E8%AF%95%E7%8B%97-interviewdog-%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" title="面试狗 - interviewdog 项目笔记">面试狗 - interviewdog 项目笔记</a><time datetime="2024-09-06T15:49:00.000Z" title="发表于 2024-09-06 23:49:00">2024-09-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/12/Redisson-%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8/" title="Redisson 详细使用"><img src="/img/post_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redisson 详细使用"></a><div class="content"><a class="title" href="/2024/08/12/Redisson-%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8/" title="Redisson 详细使用">Redisson 详细使用</a><time datetime="2024-08-12T15:06:31.000Z" title="发表于 2024-08-12 23:06:31">2024-08-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/29/%E6%89%8B%E6%91%B8%E6%89%8B%E6%95%99%E4%BD%A0%E5%89%8D%E7%AB%AF%E5%92%8C%E5%90%8E%E7%AB%AF%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%AF%BC%E5%87%BA-Excel-%E7%9A%84%EF%BC%9F/" title="手摸手教你前端和后端是如何实现导出 Excel 的？"><img src="/img/post_2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="手摸手教你前端和后端是如何实现导出 Excel 的？"></a><div class="content"><a class="title" href="/2024/07/29/%E6%89%8B%E6%91%B8%E6%89%8B%E6%95%99%E4%BD%A0%E5%89%8D%E7%AB%AF%E5%92%8C%E5%90%8E%E7%AB%AF%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%AF%BC%E5%87%BA-Excel-%E7%9A%84%EF%BC%9F/" title="手摸手教你前端和后端是如何实现导出 Excel 的？">手摸手教你前端和后端是如何实现导出 Excel 的？</a><time datetime="2024-07-29T14:59:29.000Z" title="发表于 2024-07-29 22:59:29">2024-07-29</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2024 By 雪荷</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'uTxTLDSTgec4bcmjQMhzZLXJ-gzGzoHsz',
      appKey: 'Mj7im3r78jFLJCaSKJKqGj7m',
      avatar: 'monsterid',
      serverURLs: 'https://utxtldst.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, ))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>